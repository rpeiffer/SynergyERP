! --- afflinkdata.src
! description Start Point for File Maintenance Programs  
!
! 1.0 mm/dd/yyyy change??
!
! loadsave -w -n 100,10 -o prog/dxport/afflinkdata.dl4 src/afflinkdata.src
!
!include copyright, common libs, common intrinsics
Include "src/copyright.inc"
!
include "src/inc/fileprod.inc" ! product
include "src/inc/fileprodwhse.inc" ! product warehouse
include "src/inc/filesyngprbk.inc" ! synergy price book/Grade
include "src/inc/filea80vm.inc" ! vendor
include "src/inc/filecust.inc" ! "customer file
include "src/inc/fileshiplist.inc" ! shiplist
include "src/inc/filecslkeywrd.inc" ! "cust/shiplist keywords
Include "src/inc/filelastpricez.inc" ! Last Price Lines (DIR'S FIXED!)
Include "src/inc/filesllstpricez.inc" ! Ship List Last Price (DIR's FIXED!)
Include "src/inc/filecommhead.inc" ! commodity
include "src/inc/filespecprice.inc" ! special price file
include "src/inc/fileprdkeywrd.inc" ! product key word
include "src/inc/filezonefle.inc" ! zone file
!
! *declare additional dl4 intrinsic subs & functions
Declare Intrinsic Function FindChannel
Declare Intrinsic Sub Logic,JuliantoDate, DateToJulian, programdump, env, FindF, String
Declare Intrinsic Sub formatdate,verifydate
!
! *declare additional external libs & subs & functions
External Lib "libgeneral.lib"
Declare External Sub getsession,AddToStr,SetOutPut,CreateNetStatus

External Lib "ubsfunc.dl4"
Declare External Function openfile,PDate$,FMTPhone$,FMTPhone2$,numericonly$,buildsort
!
External Lib "libprodconv.lib"
Declare External Function ConvProdAmount
!
External Lib "libfilegbkgrade.lib"
Declare External Sub filedroplistgbkgrade

External Lib "libfilegbkcolor.lib"
Declare External Sub filedroplistgbkcolor

External Lib "libfilegbkfinish.lib"
Declare External Sub filedroplistgbkfinish

External Lib "libfilegbksection.lib"
Declare External Sub filedroplistgbksection

External Lib "libfilegbkgclass.lib"
Declare External Sub filedroplistgbkgclass

External Lib "libfilefsctable.lib"
Declare External Sub filedroplistfsctable

External Lib "libfileccodesz.lib"
Declare External Sub filedroplistccodesz
!
External Lib "libprice.lib"
Declare External Sub SysPriceCalc
!
! program subs/functions
Declare Sub GetProd, GetVendor, listudcatgy, Openfiles, GetUMList
Declare Sub GetMisc, GetMiscData, GetUOMData, GetMWeight, ProdInfo
Declare sub GetBillto, GetShipto, GetKword17, GetOrderGuide, GetPrice, GetPromo
Declare Sub GetProdComp, GetBudget, AddBudget, GetKeyWord, GetAltItem, GetTaxCodeList
Declare Function GetEDIUM$
!
Declare External Function CheckProductEccosFlag, ReplacePipe$, GetIMGSVRIP$
Declare External Sub GetEndDate, CheckCust
!
!-------------------------------------------------------------------------------
External Lib "libfilecommhead.lib"
Declare External Sub filedroplistcommhead
External Lib "ubsprconv.dl4"
Declare External Function XAmount, Xunit$

Declare External Function ReplaceSpace$

!
!
! **main procedure
!
!
! dim variables used by program
!
Dim e$[500],buttonlist$[5,50],nextlist$[5,100] !error handling variables
!
Try 
  dim PR. as prod ! product
  dim PRW. as prodwhse ! product warehouse
  dim PB. as syngprbk ! synergy price book/Grade
  dim VM. as a80vm ! vendor
  dim cust. as cust
  dim Shpl. as shiplist
  dim CKW. as cslkeywrd
  Dim comd. as commhead ! commodity
  Dim spcl. as specprice 
  dim zn. as zonefle ! zone file

  !
  Dim action$[30],options$[30],userid$[8],b$[200],3%
  Dim action1$[30],action2$[30],action3$[30] ! actions for programs
  Dim bsdel$[20],esdel$[20],rdel$[20],fdel$[20],rstr$[1000],tdel$[10] ! .net delimiters
  Dim WebStr$[1000],Message$[200],p9$[50],p60$[50],p61$[256],p176$[255],dlog$[50],dblog$[60]
  Dim dmsg$[256], Msgdesc$[150], KCM$[50]

  Dim 1%,X1[9], timcheck, PT[37], dbg
  Dim 2%,X2[9],CurDate
  Dim 3%,X3[9]
  Dim 2%,maxcnt \ maxcnt=100 ! init max records in arrays for list
  Dim 3%
	!
  Dim edium$[6],given_um$[4],ecd$[80],ecd2$[4],ecd3$[4], spaces$[255]

  Dim List$[maxcnt,600],UMList$[maxcnt,600],SDSList$[maxcnt,600],PDimList$[maxcnt,600]
  Dim MiscList$[maxcnt,600] ,fields$[1,30]
  dim Blank$[100] \ Blank$=" ",Blank$
  dim 3%,FlePtr[20,1],Specs[50] ! for price
  dim memberid$[20],membername$[30]

  memberid$="400559";membername$="General Paper Goods Co."

  b$ = " ",b$
  spaces$=" ",spaces$
  tdel$="\11\"
  !
  Call dxopen()
  !
  Call getsession(e$,CTLC,options$,action$,userid$,intCO,intSls,fdel$,rstr$,bsdel$,esdel$,rdel$,action1$,action2$)
  !
  ! open files - may add a check to see if user can run an action/program
  !
  action$ = UCase$(action$)
  action$ = RTrim$(action$) ! UPPERCASE & TRIMMED
  !etc for all files needed
  dim custom_customer$[30],tmp$[1200]
  mat read #ctlc,115,60;custom_customer$;!
  mat read #ctlc,19,50;p9$;
  mat read #ctlc,60,50;p60$;
  mat read #ctlc,61,0;p61$;
  mat read #ctlc,176,0;p176$;
  mat read #ctlc,115,92;TIMCHECK;
  Close ! close all files before chaining off
  
  let custom_customer$=UCase$(trim$(custom_customer$))

  tmp$=Tim(8) using "&&"
  tmp$[3]=TIM(9) using "&&"
  tmp$[5]=TIM(10) using "&&"
  CurDate=tmp$[1,6] ! yymmdd


  if p9$[20,20]="Y" finepaper=1 else finepaper=0

  ReturnStatus = 0
  Message$ = "ACTION NOT FOUND"

  Call DXSave(0,"/tmp/syn1.txt!")
  ! call dxsave(0,"/tmp/syn.txt" + str$(tim(11)) + str$(tim(12)) + str$(tim(13)) + "!")

  
  action$="AFFLINK"


  Call OpenFiles()

  !--------------- GET STARTED ----------------------------------
  Select Case action$ ! go to various programs based on action

	Case "AFFLINK"
		call GetProd()
		call GetBillto()
		call GetShipto()
		call GetVendor()
		call GetOrderGuide()

    Case "GETALLLIST"
		call listudcatgy()

		!!-!GBKCOLOR
		clear list$[]
		call filedroplistgbkcolor(e$,list$[],100,GCC)
		list$[0]=bsdel$+"ProductColor"+fdel$
		list$[1]="ColorPMID"+fdel$+"ColorDescription"+fdel$
		call addToStr(e$,rstr$,list$[])
		
		!!-!GBKFINISH
		clear list$[]
		call filedroplistgbkfinish(e$,list$[],100,GFC)
		list$[0]=bsdel$+"Product_Finish"+fdel$
		list$[1]="FinishPMID"+fdel$+"FinishDescription"+fdel$
		call addToStr(e$,rstr$,list$[])
		
		!!-!GBKGRADE
		clear list$[]
		call filedroplistgbkgrade(e$,list$[],100,GGC)
		list$[0]=bsdel$+"Product_Grade"+fdel$
		list$[1]="GradePMID"+fdel$+"GradeDescription"+fdel$
		call addToStr(e$,rstr$,list$[])

		!!-!GBKGCLASS
		clear List$[]
		call filedroplistgbkgclass(e$,List$[],100,GBGC)
		list$[0]=bsdel$+"Product_GradeClass"+fdel$
		list$[1]="GradeClassPMID"+fdel$+"GradeClassDescription"+fdel$
		call addtostr(e$,rstr$,List$[])

		! Call GetProdall()
		let action1$="MASTER"\ call GetProd()  ! main prod info
		let action1$="MISC"\ call GetProd()  ! main prod info
		let action1$="UOM"\ call GetProd()  ! main prod info
		let action1$="SDS"\ call GetProd()  ! main prod info
		let action1$="DIMENSION"\ call GetProd()  ! main prod info


    Case "GETUDCATLIST"		
		! dim List$[50,50]	
		clear list$[]
		list$[0]=bsdel$+"Categogry"+fdel$
		list$[1]=bsdel$+"CategogryPmID"+fdel$
		list$[2]=bsdel$+"CategogryName"+fdel$
		list$[3]=bsdel$+"CategogryParentPmID"+fdel$
		list$[4]=esdel$
		call AddToStr(e$,rstr$,List$[])
		let returnstatus=1
		let message$="OK"

	Case "UDCAT"
		call listudcatgy()

	Case "PRODUCT"
		call GetProd()

	Case "COLOR"
		!!-!GBKCOLOR
		clear list$[]
		call filedroplistgbkcolor(e$,list$[],100,GCC)
		list$[0]=bsdel$+"ProductColor"+fdel$
		list$[1]="ColorPMID"+fdel$+"ColorDescription"+fdel$
		call addToStr(e$,rstr$,list$[])
		ReturnStatus = 1
		Message$ = "OK"

	Case "GRADECLASS"
		clear List$[]
		call filedroplistgbkgclass(e$,List$[],100,GBGC)
		list$[0]=bsdel$+"Product_GradeClass"+fdel$
		list$[1]="GradeClassPMID"+fdel$+"GradeClassDescription"+fdel$
		call addtostr(e$,rstr$,List$[])
		ReturnStatus = 1
		Message$ = "OK"

	Case "FINISH"
		!!-!GBKFINISH
		clear list$[]
		call filedroplistgbkfinish(e$,list$[],100,GFC)
		list$[0]=bsdel$+"Product_Finish"+fdel$
		list$[1]="FinishPMID"+fdel$+"FinishDescription"+fdel$
		call addToStr(e$,rstr$,list$[])
		ReturnStatus = 1
		Message$ = "OK"


	Case "VENDOR"
		Call GetVendor()

	Case "UOM"
		Call GetUMList()
	
	Case "BILLTO"
		call GetBillto()

	Case "SHIPTO"
		call GetShipto()

	Case "ORDERGUIDE"
		call GetOrderGuide()

	Case "COMPLEMENTS"
		call GetProdComp()

	Case "BUDGET"
		call GetBudget()

	Case "BUDGETADD"
		call AddBudget()

	Case "KEYWORD"
		call GetKeyWord()

	Case "ALTITEM"
		call GetAltItem()

	Case "TAXCODELIST"
		call GetTaxCodeList()

	Case "PRODINFO"
		call Prodinfo()

	  ! case ""  ! NEXT ACTION/PROGRAM
      ! any other File inquiry/edit programs can go here
  End Select !action options
  !---------------------------------------------------------
  ! status section
  Call CreateNetStatus(e$,ReturnStatus,Message$,WebStr$)
  Call AddToStr(e$,rstr$,WebStr$)
  Call SetOutPut(e$,rstr$)
  SelDone: ! no status
  !call dxclose()
Else 
  Include "src/callmainerrnet.inc"
End Try 
Chain ""
End

!-----------------------------------------------------------------------------------------
sub OpenFiles()
  !
  ! Open files for product screen
  !
  Try
    !
	CTLC = OpenFile(-9999,intCo) \ If CTLC = -1 Error 42 !control
	PRC = OpenFile(1792,intCo) \ If PRC = -1 Error 42 ! prod
	WHC = OpenFile(1744,intCo) \ If WHC = -1 Error 42 ! prodwhse
	CCC = OpenFile(-1728,intCo) \ If CCC = -1 Error 42 ! u/m codes file
	MTC = OpenFile(-2272,intCo) \ If MTC = -1 Error 42 ! mat codes file
	PCC = OpenFile(-1984,intCo) \ If PCC = -1 Error 42 ! prod cat file
	VNC = OpenFile(-2400,intCo) \ If VNC = -1 Error 42 ! vendor file
	AVC = OpenFile(-1568,intCo) \ if AVC = -1 error 42 ! alternate vendor file
	KWC = OpenFile(9979,intCo) \ if KWC = -1 error 42 ! product key word 
	PTC = OpenFile(-944,intCo) \ if PTC = -1 error 42 ! product tax type
	BRC = OpenFile(-1952,intCo) \ if BRC = -1 error 42 ! product break table
	PRMC = OpenFile("SPRICEMARK",intCo,"R") \ if PRMC = -1 error 42 ! price markup table
	SPMC = OpenFile(-1712,intCo) \ if SPMC = -1 error 42 ! product markup table
	HNC = OpenFile(-2784,intCo) \ if HNC = -1 error 42 ! hazard name
	UDA = OpenFile(9967,intCo) \ if UDA = -1 error 42 ! product user define fields
	PSC = OpenFile(2080,IntCo) \ if PSC = -1 Error 42 ! product sales
	CMC = OpenFile(-2288,IntCo) \ if CMC = -1 Error 42 ! commod code
	pdc = OpenFile(1104,IntCo) \ if PDC = -1 Error 42 ! prod desc index
	msd = OpenFile(-672,IntCo) \ if msd = -1 Error 42 ! msds file
	splc = OpenFile(-1936,IntCo) \ if splc=-1 Error 42 ! special price
	!RHC = OpenFile(-304,IntCo) \ if RHC = -1 Error 42 ! Reb contr head
	chc = OpenFile(-2880,IntCo) \ if chc = -1 Error 42 ! Sales contr head
	btc = OpenFile(-1952,IntCo) \ if btc = -1 Error 42 ! break tbl chann

	If P9$[20,20]  ! finepaper
		PBC = OpenFile(9923,Intco) \ if PBC = -1 error 42 ! synergy price book
		GCC = OpenFile(-9977,intCo) \ if GCC = -1 error 42 ! product GBK color
		GFC = OpenFile(-9976,intCo) \ if GFC = -1 error 42 ! product GBK finish
		GSC = OpenFile(-9975,intCo) \ if GSC = -1 error 42 ! product GBK section
		GGC = OpenFile(-9974,intCo) \ if GGC = -1 error 42 ! product GBK grade 
		GBGC=OpenFile(-9922,IntCo) \ if gbgc=-1 Error 42 ! GBK grade class
		FSC=OpenFile(-9921,IntCo) \ if fsc=-1 error 42 ! GBK FSC ID
	Endif
	If Cuc<=0 CUC=OpenFile(-1808,IntCo) \ if CUC=-1 Error 42 ! customer
	If SLC<=0 SLC=OpenFile(-2112,Intco) \ if SLC=-1 Error 42 ! shiplist
	If LPC<=0 LPC=OpenFile(-1376,IntCo) \ if LPC=-1 Error 42	! last price file
	If SLPC<=0 SLPC=OpenFile(-9982,IntCo) \ if SLPC=-1 Error 42	! Shiplast price file
	If Ch_Zone<=0 Ch_Zone = OpenFile(-1920,intCo) \ If Ch_Zone = -1 Error 42  !zone file


	fleptr[1,0]=prc;fleptr[2,0]=whc;fleptr[3,0]=cmc
	fleptr[4,0]=lpc;fleptr[5,0]=splc;fleptr[6,0]=chc
	fleptr[7,0]=ccc;fleptr[8,0]=btc

	udc=findchannel()
	tmp$="2/usrdefcat"+STR$(Intco)
	try
		ROpen #UDC,tmp$
	Else
		UDC=0
	End try
    !
	ch_edium=findchannel()
	tmp$="2/edium"
	try
		ROpen #ch_edium,tmp$
	Else
		ch_edium=0
	End try

  else
    include "src/callsuberr.inc"
  end try
end sub ! openfiles
! 
!--------------------------------------------------------------------

!--------------------------------------------------------------------
Sub listudcatgy()
! a list of user defined catgy's (in order parent down)
 Try
	Dim K1$[100,60],k2$[60],k3$[60],udcat$[100]
	Dim 3%,udcat[10],x3[100]
	Clear List$[]
	tmpcnt=maxcnt
	List$[0]=bsdel$,"USRDEFCTGY",fdel$
	List$[1]="UDCTGYREC",fdel$,"DESC",fdel$,"PARENTID",FDEL$
	List$[2]="0",fdel$,"NONE",fdel$,"0",fdel$
	row=3
	If UDC<=0 goto LUDCDone ! s/b open in openfiles
	! maybe similar to multi-level bom's somehow?
	! 1st thru base (0 parent) keys
	clear k1$[]
	k2$=Blank$
	do
		search #UDC,3,1;k2$,R[0],E
		if e exit do
		x3=k2$[1,8] \ if x3<>0 exit do ! no more parents
		mat read #udc,r[0],0;UDCAT$;
		MAT READ #UDC,R[0],100;UDCAT;
		clear k1$[] ! clear at parent
		k1$[0]=k2$
		! add to list - NO Parent not a selection
		list$[row]=Str$(R[0]),fdel$,RTrim$(UDCat$[1,30]),fdel$,Str$(UDCat[1]),fdel$
		row=row+1 \ if row>tmpcnt let tmpcnt=expandarray(e$,List$[])
		x3[1]=r[0];lvl=1 ! cat looking for
		k1$[lvl]=x3[lvl] using "########"
		lvlloop: ! loop thru this child level
		k3$=" ",k3$
		k3$=K1$[lvl]
		do 
			search #udc,3,1;k3$,R[lvl],e
			if e exit do
			x3=k3$[1,8] \ if x3<>X3[lvl] exit do ! not same rec
			mat read #udc,r[lvl],0;UDCAT$;
			MAT READ #UDC,R[lvl],100;UDCAT;
			k1$[lvl]=k3$ ! save last key for this level
			! add to list - ALL
			Webstr$=Str$(R[lvl]),fdel$
			tmp$=""
			for x=1 to lvl \ let tmp$=tmp$," " \ next x
			webstr$=webstr$,tmp$,RTrim$(UDCat$[1,30]),fdel$,Str$(UDcat[1]),fdel$
			list$[row]=Webstr$
			row=row+1 \ if row>tmpcnt let tmpcnt=expandarray(e$,List$[])
			lvl=lvl+1;x3[lvl]=R[lvl-1] ! record to check
			k1$[lvl]=x3[lvl] using "########" ! start new level
			goto lvlloop
		loop
		lvl=lvl-1 ! done with level - back 1 level
		!R=X3[lvl] ! get last one found
		! add to list - ONLY LAST ONES SELECTABLE
		!If R>0
		!	mat read #udc,r[0],0;UDCAT$;
		!	MAT READ #UDC,R[0],100;UDCAT;
		!	Webstr$=Str$(R[0]),fdel$
		!	X2=R[0];tmp$=""
		!	dudcloop: ! loop it up thru all levels
		 ! Try
		!	mat read #UDC,x2,0;UDCat$;
		!	MAT READ #UDC,x2,100;udcat;
		 ! Else
		!	UDCat$=Blank$;udcat[1]=0
		 ! End try
		! tmp$=tmp$,RTrim$(UDCat$[1,30])
		!  if udcat[1]>0 ! go up a level
		!	tmp$=tmp$," -> "
		!	x2=udcat[1] ! next parent level back 
		!	goto dudcloop
		 ! Endif
		!  webstr$=webstr$,RTrim$(tmp$),fdel$
		!	list$[row]=Webstr$
		!	row=row+1 \ if row>tmpcnt let tmpcnt=expandarray(e$,List$[])
		! Endif
		if lvl>0 goto lvlloop ! back to previous level - if zero - done!
	loop ! of parent

	LUDCDone: ! "finito
	List$[row]=esdel$
	list$[0]=bsdel$+"Category"+fdel$
	list$[1]="CategogryPmID"+fdel$+"CartegoryName"+fdel$+"CategoryParentPMID"+fdel$
	call addToStr(e$,rstr$,list$[])
	let returnstatus=1
	let message$="OK"

	!Call CreateNetStatus(e$,ReturnStatus,Message$,WebStr$)
	!Call AddToStr(e$,rstr$,WebStr$)
    !call SetOutPut(e$,rstr$)
 else
    include "src/callsuberr.inc"
  end try
end sub ! listudcatgy
! 
!--------------------------------------------------------------------
Sub GetProd_Dimension()
	clear webstr$
	webstr$=bsdel$+"Product_Dimension"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$   
	webstr$=webstr$+ "Length" +fdel$        
	webstr$=webstr$+ "Width" +fdel$         
	webstr$=webstr$+ "Cube" +fdel$          
	webstr$=webstr$+ "Weight" +fdel$        
	webstr$=webstr$+ "PackSize" +fdel$      
	webstr$=webstr$+ "SheetSize" +fdel$     
	webstr$=webstr$+ "BasisWeight" +fdel$   
	webstr$=webstr$+ "MWeight" +fdel$       
	webstr$=webstr$+ "CaseWeight" +fdel$    
	webstr$=webstr$+ "Size" +fdel$          
	webstr$=webstr$+ "Height" +fdel$        
	webstr$=webstr$+ "AvailableSizes" +fdel$
	webstr$=webstr$+ "SizeWidth" +fdel$     
	webstr$=webstr$+ "SizeLength" +fdel$+rdel$+esdel$


	call AddToStr(e$,rstr$,webstr$)
	let returnstatus=1
	let message$="OK"

End Sub
!--------------------------------------------------------------------
Sub GetMisc()
	clear webstr$
	webstr$=bsdel$+"Product_Misc"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$
	webstr$=webstr$+ "UPC" +fdel$
	webstr$=webstr$+ "GTIN" +fdel$
	webstr$=webstr$+ "EAN" +fdel$
	webstr$=webstr$+ "UNSPSC" +fdel$
	webstr$=webstr$+ "GS1" +fdel$
	webstr$=webstr$+ "GPC" +fdel$
	webstr$=webstr$+ "GSM" +fdel$
	webstr$=webstr$+ "Opacity" +fdel$
	webstr$=webstr$+ "AcidFree" +fdel$
	webstr$=webstr$+ "Skid" +fdel$
	webstr$=webstr$+ "Capacity" +fdel$
	webstr$=webstr$+ "PH" +fdel$
	webstr$=webstr$+ "Fragrance" +fdel$
	webstr$=webstr$+ "DilutionRatio" +fdel$
	webstr$=webstr$+ "MiscInfo" +fdel$
	webstr$=webstr$+ "Use_Applications" +fdel$
	webstr$=webstr$+ "Features_Benefits" +fdel$
	webstr$=webstr$+ "Certifications" +fdel$
	webstr$=webstr$+ "Status" +fdel$
	webstr$=webstr$+ "ProductNameSize" +fdel$
	webstr$=webstr$+ "Alternateitem" +fdel$
	webstr$=webstr$+ "AlternateVendorName" +fdel$
	webstr$=webstr$+ "Grain" +fdel$
	webstr$=webstr$+ "BrightNess" +fdel$
	webstr$=webstr$+ "RecycleContent" +fdel$
	webstr$=webstr$+ "CottonContent" +fdel$
	webstr$=webstr$+ "Laser" +fdel$
	webstr$=webstr$+ "Envelope" +fdel$
	webstr$=webstr$+ "AdviseType" +fdel$
	webstr$=webstr$+ "Caliper" +fdel$
	webstr$=webstr$+ "FSCCert" +fdel$
	webstr$=webstr$+ "SFICert" +fdel$
	webstr$=webstr$+ "Digital" +fdel$
	webstr$=webstr$+ "Inkjet" +fdel$
	webstr$=webstr$+ "UnitWeigth" +fdel$
	webstr$=webstr$+ "WeightUnitQty" +fdel$
	webstr$=webstr$+ "IndiGo" +fdel$
	webstr$=webstr$+ "WindPower" +fdel$
	webstr$=webstr$+ "DurablePaper" +fdel$
	webstr$=webstr$+ "CastCoated" +fdel$
	webstr$=webstr$+ "BookCode" +fdel$
	webstr$=webstr$+ "CostGRP1" +fdel$
	webstr$=webstr$+ "CostGRPContinued" +fdel$
	webstr$=webstr$+ "ItemGroup" +fdel$
	webstr$=webstr$+ "Section" +fdel$
	webstr$=webstr$+ "ColorPMID" +fdel$+rdel$
	!
End Sub	!  GetMisc
!-------------------------------------------------------------------
Sub GetMiscData()
	webstr$=webstr$+ RTrim$(PR.ProdCode$) +fdel$
	! webstr$=webstr$+ "UPC" +fdel$
	webstr$=webstr$+ "" +fdel$
	webstr$=webstr$+ "" +fdel$	! GTIN
	webstr$=webstr$+ "" +fdel$	!EAN
	webstr$=webstr$+ "" +fdel$	! UNSPSC
	webstr$=webstr$+ "" +fdel$  ! GS1
	webstr$=webstr$+ "" +fdel$	!GPC
	webstr$=webstr$+ Str$(PB.GSM) +fdel$
	webstr$=webstr$+ PB.Opacity$ +fdel$
	webstr$=webstr$+ Str$(PB.AcidFree) +fdel$
	webstr$=webstr$+ "" +fdel$	!Skid
	webstr$=webstr$+ "" +fdel$	!Capacity
	webstr$=webstr$+ "" +fdel$	! PH
	webstr$=webstr$+ "" +fdel$	! Fragrance
	webstr$=webstr$+ "" +fdel$ ! DilutionRatio
	webstr$=webstr$+ "" +fdel$	! MiscInfo
	webstr$=webstr$+ "" +fdel$	! Use_Applications
	webstr$=webstr$+ "" +fdel$	! Features_Benefits
	webstr$=webstr$+ "" +fdel$	! Certifications
	webstr$=webstr$+ Str$(pb.status) +fdel$
	webstr$=webstr$+ "" +fdel$	! ProductNameSize
	webstr$=webstr$+ "" +fdel$	! Alternateitem
	webstr$=webstr$+ "" +fdel$	! AlternateVendorName
	webstr$=webstr$+ PR.Grain$ +fdel$
	webstr$=webstr$+ PB.BrightNess$ +fdel$
	webstr$=webstr$+ Str$(pb.RecCont) +fdel$
	webstr$=webstr$+ Str$(pb.cottoncont) +fdel$
	webstr$=webstr$+ Str$(pb.laser) +fdel$
	webstr$=webstr$+ Str$(pb.envelope) +fdel$
	webstr$=webstr$+ pb.AdhvType$ +fdel$
	webstr$=webstr$+ Str$(pb.caliper) +fdel$
	webstr$=webstr$+ Str$(pb.fsccert) +fdel$
	webstr$=webstr$+ Str$(pb.sficert) +fdel$
	webstr$=webstr$+ Str$(pb.digital) +fdel$
	webstr$=webstr$+ Str$(pb.inkjet) +fdel$
	!webstr$=webstr$+ "UnitWeigth" +fdel$
	webstr$=webstr$+ Str$(0) +fdel$
	webstr$=webstr$+ "" +fdel$	! WeightUnitQty
	webstr$=webstr$+ Str$(pb.indigo) +fdel$
	webstr$=webstr$+ Str$(pb.windpower) +fdel$
	webstr$=webstr$+ Str$(pb.durpaper) +fdel$
	webstr$=webstr$+ Str$(pb.castcoat) +fdel$
	webstr$=webstr$+ pb.BookID$ +fdel$
	webstr$=webstr$+ Trim$(pb.costgrp$[1,50]) +fdel$
	webstr$=webstr$+ Trim$(pb.costgrp$[51,100]) +fdel$
	webstr$=webstr$+ pb.ItemGrp$ +fdel$
	webstr$=webstr$+ pb.Section$ +fdel$
	webstr$=webstr$+ pb.colorid$ +fdel$+rdel$
	! call AddToStr(e$,rstr$,webstr$)
	!-----------------------------------------------
	let returnstatus=1
	let message$="OK"
End Sub
!--------------------------------------------------------------------
Sub GetVendor()
! Afflink:
! File ID*	Char	“TVENDOR”.
! Member ID*	Char	The unique Member ID assigned by AFFLINK.
! Member Name*	Char	The name of the Member submitting the file.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).

! Line Item Record - One for each item
! Field Name	Type	Description
! Vendor ID *	Char	Distributor’s Vendor ID.
! Vendor Name*	Char	Vendor/Supplier full name.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).


Try
	Dim vnk$[6]
	clear list$[], webstr$

	txt=findchannel()
	tmp$="tmp/tvendor.txt!"
	try
		Build #txt,+tmp$
	Else
		txt=0
	End try

	webstr$="TVENDOR"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #txt;webstr$
	clear webstr$

	VNK$ = ""
	Do until VMRec=-2  ! end of file
		VMRec=filegeta80vm(e$,VNC,">",1,VNK$,VM.)
		If VMRec
			webstr$=Str$(VM.VendorCode)+tdel$+VM.Name$
			print #txt;webstr$
		End if
	Loop

	Close #TXT
	System "unix2dos tmp/tvendor.txt"
	let returnstatus=1
	let message$="OK"
 else
    include "src/callsuberr.inc"
  end try
End Sub  ! GetVendor
!--------------------------------------------------------------------
Sub GetUMList()
Try
	clear umlist$[]
	call filedroplistccodesz(e$,list$[],100,CCC,"",Fields$[],1,"",tmp$)
	call addToStr(e$,rstr$,list$[])
	let returnstatus=1
	let message$="OK"
else
	include "src/callsuberr.inc"
end try
!
End Sub ! getUMList
!--------------------------------------------------------------------
Sub GetProd()
! 
! File ID*	Char	“TITEM”.
! Member ID*	Char	The unique Member ID assigned by AFFLINK.
! Member Name*	Char	The name of the Member submitting the file.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).
! 
! Line Item Record - One for each item
! Field Name	Type	Description
! Member Item*	Char	The unique Item ID assigned by Your System.
! Description 1*	Char	Full item description.
! Manufacturer ID*	Char	The unique Manufacturer ID assigned by Your System.
! Mfg Item ID*	Char	The Manufacturer’s Item number.
! UOM*	Char	The Unit of Measure by which the item will be priced and sold.
! Color	Char	The Color.
! Pack	Char	The Pack Size (ex. 24 ea/case).
! Category Code	Char	The Item Category.
! Subcategory Code	Char	The Item Subcategory.
! UPC Code	Char	The Item UPC Code as assigned by the Manufacturer.
! UNSPSC Code	Char	The Universal Standard Products and Services Classification Code (www.unspsc.org).
! Description 2	Char	Secondary level of description. Please provide this data if available.
! Reserved	Char	Please leave a tab here to reserve this field for future enhancements.
! Item Status	Char	Status Code used for future enhancements
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).

	! dim List$[100,50]
	dim SearKey$[100],prodkey$[12],prwkey$[14],cmckey$[4],vendkey$[6]
	dim cmcdesc$[16],cmcremarks$[15],CATDESC$[24],vendname$[30],pack$[20]
	dim bkum$[4],stunit$[4],sellum$[4],priceum$[4],baseum$[4],valdum$[112],ccd$[14],sunit$[14]
	dim mweight$[50],promosdate$[10],promoedate$[10], UCATDESC$[30], PUCATDESC$[30]
	dim 1%,pfu1[14],moreprods, PromoFlag
	dim 2%
	dim 3%, r[99],prodrec, whrec, cmcrec, ParentCat

	clear list$[], umlist$[], sdslist$[], pdimlist$[], misclist$[], webstr$
	tmpsdscnt=maxcnt
	tmppdimcnt=maxcnt

	txt=findchannel()
	tmp$="tmp/titem.txt!"
	try
		Build #txt,+tmp$
	Else
		txt=0
	End try

	catsort=BuildSort(e$,50,0,-1,"catsort") ! build a sortwork on chan#-1, keysize=20w
	subcatsort=BuildSort(e$,50,0,-1,"scatsort") ! build a sortwork on chan#9, keysize=20w

	!----------------------------------------------------------------
	! get the section header based on action1$
	!
	clear webstr$

	webstr$="TITEM"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #txt;webstr$
	clear webstr$

	umrow=0;tmpcnt=maxcnt
	!
	!---------------------------------------------------
	SearKey$="";prodkey$="";prodrec=0;moreprods=0
	!
	Call DXGet("PRODKEY",tmp$)
	if tmp$ let prodkey$=tmp$+blank$
	!
	Do Until prodrec<0
	LOOP_prod: REM loop thru product file
		!-----------------------------------------------
		Prodrec=filegetprod(e$,PRC,">",1,ProdKey$,PR.)
		if prodrec<0 goto End_prod
		!-----------------------------------------------
		! filter out products
		!
		if pr.eccosflag<1 goto loop_prod
		If Not(PR.UserDefCatgyId) goto loop_prod: ! no ctgy - no send
		tmp$ = " ",tmp$                                   
		tmp$=PR.Desc1$+PR.Desc2$          ! desc 1 & 2     
		call string(1,tmp$)   ! uppercase it              
		search tmp$,"DISCONTINUE",bad1                    
		search tmp$,"DO NOT USE",bad2                     
		if (bad1 or bad2) goto loop_prod

		! if pr_a2$[1,12]<>blanks$[1,12] goto loop_prod:   ! superceded don't send
		!-----------------------------------------------
		!GET_WHSE:  check whse do not reorder flag
		prwkey$=PR.ProdCode$+" 1"  ! only checking whse 1 do not reorder
		WHRec=filegetprodwhse(e$,WHC,">=",1,PRWKey$,PRW.)
		If prwkey$[1,12]<>prodkey$[1,12] goto loop_prod
		if custom_customer$="GPG"
			! no dnr check to gpg
		else
			IF PRW.DNReordFlg=1 goto loop_prod
		end if

		!-----------------------------------------------
		!GET_COMMODITY: 
		cmckey$=PR.ComdtyCode$;cmcremarks$=" ",cmcremarks$
		Search #CMC,2,1;cmckey$,R[77],E
		if Not(E)
			mat read #cmc,r[77],0;cmcdesc$
			mat read #cmc,r[77],16;cmcremarks$;
		Else
			cmcdesc$="COMMD INVALID"
			goto loop_prod
		Endif
		!-----------------------------------------------
		!GET_CATEGORY:
		Try
			MAT  READ #PCC,PR.ProdCat,0;CATDESC$;
		Else
			goto End_prod
		End Try
		!-----------------------------------------------
		!GOSUB GET_VEND:
		vendname$=" ",vendname$
		IF pr.spare    ! SL[2] ! manufacturer
		  LET VENDKEY$=pr.spare USING "######"    ! mfr #
		ELSE                                    
		  LET VENDKEY$=pr.primvend USING "######"     
		ENDIF 
		SEARCH #VNC,2,1;VENDKEY$,REC_VEND,E
		IF E goto End_prod
		MAT  READ #VNC,REC_VEND,0;VENDNAME$;
		!-----------------------------------------------
		!  done with filters


		! filter out special characters for map
		for x = 1 to 5
			if pr.desc1$[1,1]="^" or pr.desc1$[1,1]="$" or pr.desc1$[1,1]="*" or pr.desc1$[1,1]="-" or pr.desc1$[1,1]="+" or pr.desc1$[1,1]=" "
				pr.desc1$=pr.desc1$[2],blank$
			end if
		next x
		pr.desc1$=Ltrim$(pr.desc1$),blank$

		itemcnt=itemcnt+1
		!
		Pfu1[0]=PR.BaseUM
		Pfu1[1]=PR.UM2
		Pfu1[2]=PR.UM3
		Pfu1[3]=PR.UM4
		Pfu1[4]=PR.UM5
		Pfu1[5]=PR.UM6
		Pfu1[6]=PR.UM7
		Pfu1[7]=PR.UM8
		Pfu2[0]=PR.UM2Fact
		Pfu2[1]=PR.UM3Fact
		Pfu2[2]=PR.UM4Fact
		Pfu2[3]=PR.UM5Fact
		Pfu2[4]=PR.UM6Fact
		Pfu2[5]=PR.UM7Fact
		Pfu2[6]=PR.UM8Fact

		dopromo=0
		promoflag=0
		promosdate$=" "
		promoedate$=" "
		
		If Custom_customer$="MIDATLANTIC" let dopromo=1

		If dopromo Call GetPromo()

		Let X3=PR.ListPrice1
		If custom_customer$="JACKSON" let X3=PR.ListPrice6

		if finepaper
			LET CNVTA=X3;CNVTU[0]=0;CNVTU[1]=PR.UMPriceDefault;CNVTU[2]=2;convflag=0
		else ! industrial
			LET CNVTA=X3;CNVTU[0]=0;CNVTU[1]=PR.UMSellDefault;CNVTU[2]=2;convflag=0
		end if
		LET List1=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)
	
		!----------------------------------------------------------
		SearKey$=pr.ProdCode$ ! price book
		PBRec=filegetsyngprbk(e$,PBC,"=",1,SearKey$,PB.)
		if PBRec<0 Clear PB. ! price book not found   	Heading1$=Heading1$,"Status",fdel$,"Status Desc",fdel$

		!------------------GET PARENT UDCAT----------------------------
		ParentCat=0
		UCATDESC$="";PUCATDESC$=""

		MAT READ #UDC,PR.UserDefCatgyId,0;UCATDESC$;
		MAT READ #UDC,PR.UserDefCatgyId,106;ParentCAT;
		MAT READ #UDC,ParentCAT,0;PUCATDESC$;
		!------ Save for export in index file:
		! subcat or regular prod udcat
		tmp$=PR.UserDefCatgyId using "#####"+UCATDESC$
		Search #subcatsort,4,1;tmp$,PR.UserDefCatgyId,e
		! Parent cat for udcat
		tmp$=ParentCAT using "#####"+PUCATDESC$
		Search #catsort,4,1;tmp$,ParentCAT,e
		
		!--------------------------------------------------------------

		clear webstr$
		!--------------------------------------------------------------
		! now write values to rstr$ for product
		webstr$=webstr$+ RTrim$(PR.ProdCode$) +tdel$
		webstr$=webstr$+ RTrim$(pr.desc1$)+" "+Rtrim$(pr.desc2$) +tdel$
		webstr$=webstr$+ RTrim$(Ltrim$(vendkey$))+tdel$	! manufacturer id
		webstr$=webstr$+ RTrim$(PR.VendItem$) +tdel$	! mfg item id
		
		sellum$=xunit$(PR.UMSellDefault,ccc) ! u/m
		sellum$=GetEDIUM$(sellum$)			 ! convert to Afflink UM
		webstr$=webstr$+ sellum$ +tdel$
		webstr$=webstr$+ pb.colorid$ +tdel$ ! color
		webstr$=webstr$+ RTrim$(PR.PackSize$) +tdel$	! packsize
		webstr$=webstr$+ Str$(ParentCAT) +tdel$	! topcat  (udcat parent)	
		webstr$=webstr$+ Str$(PR.UserDefCatgyId) +tdel$	! subcat (udcat)
		webstr$=webstr$+ "" +tdel$ ! UPC
		webstr$=webstr$+ "" +tdel$	! UNSPSC
		webstr$=webstr$+ "" +tdel$	! Desc2 (long?)
		webstr$=webstr$+ "" +tdel$	! reserved
		webstr$=webstr$+ ""			! item status
		print #txt;webstr$
		clear webstr$
		!webstr$=webstr$+ Rtrim$(PR.NProdId$) +fdel$+rdel$


		!---------------------------------------------------------
		! call AddToStr(e$,rstr$,webstr$)
	End_prod: Loop
	
	Close #txt
	System "unix2dos tmp/titem.txt"


!----------------Now build UDCAT files -----------------------------
	cattxt=findchannel()
	tmp$="tmp/tcat.txt!"
	try
		Build #cattxt,+tmp$
	Else
		Error 10000
	End try

	clear webstr$

	webstr$="TCAT"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #cattxt;webstr$
	clear webstr$
	tmp$=""
	Loop_catsort: Search #catsort,3,1;tmp$,r,e
	if not(e)
		webstr$=RTrim$(tmp$[1,5])+tdel$+RTrim$(tmp$[6])
		print #cattxt;webstr$
		clear webstr$
		!		
		goto Loop_catsort
	end if


	subcattxt=findchannel()
	tmp$="tmp/tsubcat.txt!"
	try
		Build #subcattxt,+tmp$
	Else
		Error 10000
	End try

	webstr$="TSUBCAT"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #subcattxt;webstr$
	clear webstr$
	tmp$=""
	Loop_subcatsort: Search #subcatsort,3,1;tmp$,r,e
	if not(e)
		webstr$=RTrim$(tmp$[1,5])+tdel$+RTrim$(tmp$[6])
		print #subcattxt;webstr$
		clear webstr$
		!		
		goto Loop_subcatsort
	end if
	!
	Close #catsort,#subcatsort,#cattxt,#subcattxt
	System "unix2dos tmp/tcat.txt"
	System "unix2dos tmp/tsubcat.txt"

!-------------------------------------------------------------------
	if moreprods=0
		let returnstatus=1
		let message$="OK"
	end if
	!
End Sub
!--------------------------------------------------------------------
Sub GetUOMData()
	!
	! baseum$=xunit$(PR.BASEUM,ccc) ! u/m
	! bkum$=xunit$(PR.UMBrknQty,ccc) ! u/m
	! sellum$=xunit$(PR.UMSellDefault,ccc) ! u/m
	! priceum$=xunit$(PR.UMPriceDefault,ccc) ! u/m
	! stunit$=xunit$(PR.UMStkDefault,ccc) ! u/m
	!
	SellFact=1
	If PR.UMSellDefault=PR.UM2 let sellfact=PR.UM2Fact
	If PR.UMSellDefault=PR.UM3 let sellfact=PR.UM3Fact
	If PR.UMSellDefault=PR.UM4 let sellfact=PR.UM4Fact
	If PR.UMSellDefault=PR.UM5 let sellfact=PR.UM5Fact
	If PR.UMSellDefault=PR.UM6 let sellfact=PR.UM6Fact
	If PR.UMSellDefault=PR.UM7 let sellfact=PR.UM7Fact
	If PR.UMSellDefault=PR.UM8 let sellfact=PR.UM8Fact

	STfactor=1!  get the stocking unit factor to make pack
	for loop_uom=1 to 7
		if pfu1[loop_uom]=pfu1[8]
			stfactor=pfu2[loop_uom-1]
		end if
	next loop_uom

	pack$=" ",pack$
	pack$=stfactor using "##########"
	pack$=pack$+"/"+stunit$[1,4]
	!-----------------------------------------------------
	! send valid ums
	!
	! valdum$=" ",valdum$
	kpos=1
	for loop_uom=0 to 7
		ccd$=" ",ccd$

		if pfu1[loop_uom]
			if pfu1[loop_uom] >0 MAT  READ #ccc,pfu1[loop_uom];ccd$
			if pfu1[loop_uom] =-1 LET ccd$[11,14]="CWT "
			if pfu1[loop_uom] =-2 LET ccd$[11,14]="LOT "
			if pfu1[loop_uom] =-3 let ccd$[11,14]="LB  "
			if ccd$[10,10]<>"*"! not price only
				factor=1
				if loop_uom>0 let factor=pfu2[loop_uom-1]
				! valdum$[kpos,kpos+3]=ccd$[11,14]!unit of measure code
				! valdum$[kpos+4,kpos+13]=factor using "##########"
				! clear webstr$
				WebStr$=rtrim$(PR.ProdCode$),fdel$ ! productcode
				WebStr$=webstr$+ ccd$[11,14]  +fdel$ ! umcode
				WebStr$=webstr$+ str$(factor) +fdel$ ! factor
				if factor=1
					WebStr$=webstr$+ str$(1) +fdel$ ! is base
				else
					WebStr$=webstr$+ str$(0) +fdel$ ! not base
				end if
				if pfu1[loop_uom]=PR.UMSellDefault
					WebStr$=webstr$+ str$(1) +fdel$ ! is sell
				else
					WebStr$=webstr$+ str$(0) +fdel$ ! not sell
				end if
				if pfu1[loop_uom]=PR.UMBrknQty
					WebStr$=webstr$+ str$(1) +fdel$ ! is bkum
				else
					WebStr$=webstr$+ str$(0) +fdel$ ! not bkum
				end if
				if pfu1[loop_uom]=PR.UMStkDefault
					WebStr$=webstr$+ str$(1) +fdel$ ! is stocking
				else
					WebStr$=webstr$+ str$(0) +fdel$ ! not stocking
				end if
				if pfu1[loop_uom]=PR.UMPriceDefault
					WebStr$=webstr$+ str$(1) +fdel$ ! is pricing
				else
					WebStr$=webstr$+ str$(0) +fdel$ ! not pricing
				end if
				call AddToStr(e$,rstr$,webstr$+rdel$)
			end if
		end if
		! kpos=kpos+14
	next loop_uom

	!----------------------------------------------------------
End Sub ! GetUOMData
!-------------------------------------------------------------
Sub GetMWeight(x3)
clear mweight$
! LET X3=PR.LbsFact
IF X3=1 
	LET NUNIT=PR.BaseUM
Else
	FOR X1=0 TO 6                                           
	  IF X3<>PFU2[X1] GOTO L_5370:                          
	  LET NUNIT=PFU1[X1+1]                                  
	  GOSUB L_5600: \ GOTO L_5390:                          
	L_5370: NEXT X1                                         
End If

L_5600: REM PRINT UNITS                                 
IF NUNIT=-1 LET SUNIT$="HUNDRED WTCWT " \ GOTO L_5630:  
LET SUNIT$=" not foundERR "                             
IF NUNIT=0 LET SUNIT$=" ",SUNIT$ \ GOTO L_5630:         
IF NUNIT>=0 MAT  READ #ccc,NUNIT;sunit$;
L_5630: ! PRINT SUNIT$[11,14];"  ";SUNIT$[1,5];
! PRINT  USING "####.##";@59,14;A[6];@67,14;"/";@69,14; 
! mweight$=PR.LbsUnit using "####.## " +"/"+ SUNIT$[11,14]+"  "+SUNIT$[1,5]
! RETURN                                                  
L_5390: !
! 
End Sub !------------------------------

!--------------------------------------------------------------------
Sub GetBillTO()
! Description                    Format     Variable       Length               
! -----------                    ------     --------       ------               
! Customer Code                 	C	    C1[1]     	      6
! Customer Name                 	C	    A1$[31,60]     	 30
! Bill to code ######		    	C	    C1[4]             6
! Default Whse 						C       DWH				  2
! address 1		 	                C   	A1$[61,90]	     30
! address 2             		 	C	    A1$[91,120]	     30
! city 		                        C   	A1$[121,135]	 15
! State                             C   	A1$[136,137]	  2
! Zip Code                          C   	A2$[1,10]	     10
! Country                           C   	A1$[21,30]	     10
! CC Y/N							C		y/n
! zone  							C		A2$[29,30]
! UDA1  							C		U2$[1,20]		(MIDATL old cust#)
!______________________AFFLINK LAYOUT___________________________________
! Header Record - One for each item
! Field Name	Type	Description
! File ID*	Char	“TBILLT”
! Member ID*	Char	The unique Member ID assigned by AFFLINK.
! Member Name*	Char	The name of the Member submitting the file.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).
! 
! Line Item Record - One for each item
! Field Name	Type	Description
! Customer ID *	Char	Unique customer number assigned by member.
! Customer Name*	Char	Member’s Customer Name.
! Bill-To Addr1	Char	Bill To Address line 1
! Bill-To Addr2	Char	Bill To Address line 2
! Bill-To City	Char	Bill To City
! Bill-To State	Char	Bill To State
! Bill-To Zip	Char 	Bill To Zip Code
! Parent Cust ID	Char	Parent Customer for this location
! Parent Cust Name	Char	Parent Customer name for this location
! Parent Addr1	Char	Parent Address line 1
! Parent Addr2	Char	Parent Address line 2
! Parent City	Char	Parent City
! Parent State	Char	Parent State
! Parent Zip
! Customer Category	Char
! Char	Parent Zip Code
! Customer Category for Full Catalog
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).

	! dim List$[100,50]
	dim SearKey$[100],custkey$[6],BcustKey$[6]
	dim 1%, CUC
	dim 2%
	dim 3%, r[99],custrec, CUR, BCUR
	dim bcust. as cust

	clear list$[], umlist$[], sdslist$[], pdimlist$[], misclist$[], webstr$

	!----------------------------------------------------------------
	!

	txt=findchannel()
	tmp$="tmp/TBILLT.txt!"
	try
		Build #txt,+tmp$
	Else
		txt=0
	End try

	clear webstr$
	webstr$="TBILLT"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #txt;webstr$
	clear webstr$


Try
	If Cuc<=0 CUC=OpenFile(-1808,IntCo) \ if CUC=-1 Error 42
	Ckwchan=OpenFile(-9972,IntCo) \ if Ckwchan=-1 Error 42

	SearKey$="";custkey$="";CUR=0
	Do Until CUR<0
	LOOP_Billto: REM loop thru customer file
		!-----------------------------------------------
		CUR=filegetcust(e$,CUC,">",1,custKey$,Cust.)
		if CUR<0 goto End_billto
		!-----------------------------------------------
		! filter out customers
		!
		if cust.eccosflag<1 goto loop_billto
		Call GetKword17()
		Try X=CKW.Keyword17$ else X=0
		if X let Cust.CustomerBillto=X

		webstr$= Str$(Cust.CustomerCode) +tdel$
		webstr$=webstr$+ Cust.Name$ +tdel$
		webstr$=webstr$+ Cust.Addr1$ +tdel$
		webstr$=webstr$+ Cust.Addr2$ +tdel$
		webstr$=webstr$+ Cust.City$ +tdel$
		webstr$=webstr$+ Cust.State$ +tdel$
		webstr$=webstr$+ Cust.Zip4$ +tdel$

		if Cust.CustomerBillto = Cust.CustomerCode
			webstr$=webstr$+tdel$+tdel$+tdel$+tdel$+tdel$+tdel$+tdel$
		else
			BcustKey$=Cust.CustomerBillto using "######"
			BCUR=filegetcust(e$,CUC,"=",1,BcustKey$,BCust.)
			webstr$=webstr$+ Str$(BCust.CustomerBillto) +tdel$
			webstr$=webstr$+ BCust.Name$ +tdel$
			webstr$=webstr$+ BCust.Addr1$ +tdel$
			webstr$=webstr$+ BCust.Addr2$ +tdel$
			webstr$=webstr$+ BCust.City$ +tdel$
			webstr$=webstr$+ BCust.State$ +tdel$
			webstr$=webstr$+ BCust.Zip4$ +tdel$
		end if
		webstr$=webstr$+ ""		! customer category??

		print #txt;webstr$

		clear webstr$

	End_Billto: Loop
	! Set the esdel and go
	Close #txt
	System "unix2dos tmp/tbillt.txt"

	let returnstatus=1
	let message$="OK"

else
	include "src/callsuberr.inc"
end try
!
End Sub !------GetBillTO--------------------

Sub GetShipto() !--------------------------------------------------
! ShipList File
! name: PMCUSTID.shipto.timestamp.(i/u/d).csv

! Customer Code                     C   	######            6
! Shipto Code (ssssss)		        C   	FRA(C1)          13
! ship to  name                     C   	A$[1,30]         30
! default Warehouse                 C       DWH               2
! ship to  address 1                C   	A$[31,60]	     30
! ship to  address 2                C   	A$[61,90]	     30
! ship to  city                 	C   	A$[91,105]	     15
! ship to  state                    C   	A$[106,107]       2
! ship to  zip                      C    	A$[108,117]      10
! ship to  country                  C       R$[13,25]        13
! Resflag
! Zone								C		R$[32,33]
!
!-------------AFFLINK-------------------------------------------
! File ID*	Char	“TSHIPT”.
! Member ID*	Char	The unique Member ID assigned by AFFLINK.
! Member Name*	Char	The name of the Member submitting the file.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).
! 
! Line Item Record - One for each item
! Field Name	Type	Description
! Customer ID *	Char	Unique customer number assigned by member (Bill-To location).
! Customer Name*	Char	Member’s Customer Name (Bill-To location).
! Ship-To ID*	Char	Unique Ship-To location number assigned by member.
! Ship-To Name*	Char	Ship-To Name
! Ship-To Addr1*	Char	Ship To Address line 1
! Ship-To Addr2	Char	Ship To Address line 2
! Ship-To City*	Char	Ship To City
! Ship-To State*	Char	Ship To State
! Ship-To Zip*	Char 	Ship To Zip Code
! Contact Person	Char	Ship To Contact Person
! Phone Number	Char	Ship To Phone Number
! Fax Number	Char	Ship To Fax Number
! Default Billing Address	Char	Y or N
! Bill-To Addr1*	Char	Bill To Address line 1
! Bill-To Addr2	Char	Bill To Address line 2
! Bill-To City*	Char	Bill To City
! Bill-To State*	Char	Bill To State
! Bill-To Zip*	Char 	Bill To Zip Code
! Customer Location ID	Char	Location ID from the customer
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).
! 

	! dim List$[100,50]
	dim SearKey$[100], slkey$[14], custkey$[6], bcustkey$[6]
	Dim 1%,CUC,SLC
	dim 2%
	dim 3%, r[99],custrec, shiprec, CUR, SLR, shiplist, BCUR
	dim bcust. as cust, cust. as cust

	clear list$[], umlist$[], webstr$


	txt=findchannel()
	tmp$="tmp/TSHIPT.txt!"
	try
		Build #txt,+tmp$
	Else
		txt=0
	End try

	clear webstr$
	webstr$="TSHIPT"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #txt;webstr$
	clear webstr$
!----------------------------------------------------------------

  Try
	!
	If Cuc<=0 CUC=OpenFile(-1808,IntCo) \ if CUC=-1 Error 42 ! customer
	If SLC<=0 SLC=OpenFile(-2112,Intco) \ if SLC=-1 Error 42 ! shiplist

	SearKey$="";custkey$="";CUR=0;SLR=0;shiprec=0;slkey$=""
	Do Until shiprec<0
	LOOP_Shipto: REM loop thru shipto file
		!-----------------------------------------------
		shiprec=filegetshiplist(e$,SLC,">",1,SLKey$,shpl.)
		if shiprec<=0 goto End_shipto
		shiplist=slkey$[8,13] ! decimal portion

		! check customer eccosflag
		clear cust.
		custkey$=slkey$[1,6]
		CUR=filegetcust(e$,CUC,"=",1,custKey$,Cust.)
		if CUR<0 or cust.eccosflag<1 goto loop_shipto
		! get billto info
		BcustKey$=Cust.CustomerBillto using "######"
		BCUR=filegetcust(e$,CUC,"=",1,BcustKey$,BCust.)

		! write it out
		WebStr$=Str$(cust.CustomerCode)+tdel$ ! cust #
		webstr$=webstr$+ Cust.Name$ +tdel$
		WebStr$=WebStr$,shiplist using "&&&&&&"+tdel$ ! shiptocode
		WebStr$=WebStr$,RTrim$(shpl.Name$)+tdel$ ! name
		WebStr$=WebStr$,RTrim$(shpl.Address$)+tdel$ ! addr 1
		WebStr$=WebStr$,RTrim$(shpl.OptAddress$)+tdel$ ! addr 2
		WebStr$=WebStr$,RTrim$(shpl.City$)+tdel$ ! city
		WebStr$=WebStr$,RTrim$(shpl.State$)+tdel$ ! state
		WebStr$=WebStr$,RTrim$(shpl.ZipCode$)+tdel$ ! zip
		WebStr$=WebStr$,RTrim$(shpl.contact$)+tdel$ ! contact
		Try tmp$=FMTPhone$(Val(numericonly$(shpl.phonenumber$))) Else tmp$=""
		webstr$=webstr$+ tmp$ +tdel$
		webstr$=webstr$+ "" +tdel$
		webstr$=webstr$+ "" +tdel$	! default billing Y/N
		webstr$=webstr$+ BCust.Name$ +tdel$
		webstr$=webstr$+ BCust.Addr1$ +tdel$
		webstr$=webstr$+ BCust.Addr2$ +tdel$
		webstr$=webstr$+ BCust.City$ +tdel$
		webstr$=webstr$+ BCust.State$ +tdel$
		webstr$=webstr$+ BCust.Zip4$ +tdel$
		webstr$=webstr$+ ""			! custom locationid

		print #txt;webstr$
		clear webstr$
		xtr=xtr+1

	End_Shipto: Loop
	! Set the esdel and go

	if xtr=0 ! no shipto records found so create defaults

		Try
			If Cuc<=0 CUC=OpenFile(-1808,IntCo) \ if CUC=-1 Error 42
			Ckwchan=OpenFile(-9972,IntCo) \ if Ckwchan=-1 Error 42

			SearKey$="";custkey$="";CUR=0
			Do Until CUR<0
			LOOP_MockShipto: REM loop thru customer file
				!-----------------------------------------------
				CUR=filegetcust(e$,CUC,">",1,custKey$,Cust.)
				if CUR<0 goto End_MockShipto
				!-----------------------------------------------
				! filter out customers
				!
				if cust.eccosflag<1 goto loop_MockShipto
				Call GetKword17()
				Try X=CKW.Keyword17$ else X=0
				if X let Cust.CustomerBillto=X
				SHIPLIST=0

				! get billto info
				BcustKey$=Cust.CustomerBillto using "######"
				BCUR=filegetcust(e$,CUC,"=",1,BcustKey$,BCust.)

				! write it out
				WebStr$=Str$(cust.CustomerCode)+tdel$ ! cust #
				webstr$=webstr$+ Cust.Name$ +tdel$
				WebStr$=WebStr$,Str$(shiplist) +tdel$ ! shiptocode
				WebStr$=WebStr$,RTrim$(Cust.Name$)+tdel$ ! name
				webstr$=webstr$+ RTrim$(Cust.Addr1$) +tdel$
				webstr$=webstr$+ RTrim$(Cust.Addr2$) +tdel$
				webstr$=webstr$+ RTrim$(Cust.City$) +tdel$
				webstr$=webstr$+ RTrim$(Cust.State$) +tdel$
				webstr$=webstr$+ RTrim$(Cust.Zip4$) +tdel$

				WebStr$=WebStr$,RTrim$(CUST.contact$)+tdel$ ! contact
				Try tmp$=FMTPhone$(Val(numericonly$(CUST.phone$))) Else tmp$=""
				webstr$=webstr$+ tmp$ +tdel$

				webstr$=webstr$+ "" +tdel$	! fax
				webstr$=webstr$+ "Y" +tdel$	! default billing Y/N
				webstr$=webstr$+ BCust.Addr1$ +tdel$
				webstr$=webstr$+ BCust.Addr2$ +tdel$
				webstr$=webstr$+ BCust.City$ +tdel$
				webstr$=webstr$+ BCust.State$ +tdel$
				webstr$=webstr$+ BCust.Zip4$ +tdel$
				webstr$=webstr$+ ""			! custom locationid

				print #txt;webstr$

				clear webstr$

			End_MockShipto: Loop
		Else
			Rem
		End Try
	End if

	Close #TXT
	System "unix2dos tmp/tshipt.txt"

	let returnstatus=1
	let message$="OK"
	
  else
    include "src/callsuberr.inc"
  end try

End Sub !------GetShipto--------------------
!----------------------------------------------------------------------------

Sub GetKWord17()
  Try
	dim 1%,tmp1,Dir,CKWDir
    dim 3%,tmp3,CKWRec
	Dim CKWKey$[64]
	clear CKW.
	let ckwkey$=custkey$+" "
	CKWRec=filegetcslkeywrd(e$,CKWChan,"=",1,CKWKey$,CKW.)
  else
    include "src/callsuberr.inc"
  end try

End Sub

Sub GetOrderGuide()  !----------------------------
!
!  Customer code
!  Ship To code   (only if p61$[64,64]="Y") (0"zero" otherwise)
!  Product code
!  Current Price  (as passed back from "price" PRICE U/M)
!  Last Qty       (in SELL U/M)
!  Last sale date (MM/DD/YY)
!  Frequency
!  Selling U/m    (4 Char)
!  Pricing u/m    (4 char)
!  Commodity code
!  Last Price     (in PRICE U/M)
!------------------------------------------------
! AFFLINK
!
! File ID*	Char	“TPRICE” or “CPRICE”.
! Member ID*	Char	The unique Member ID assigned by AFFLINK.
! Member Name*	Char	The name of the Member submitting the file.
! Carriage Return*	Char	Carriage Return (ASCII #13).
! Line Feed*	Char	Line Feed (ASCII #10).
! 
! Line Item Pricing Record - One for each item that a customer sees
! Field Name	Type	Description
! Member Item*	Char	The unique Item ID assigned by Your System.
! Customer Number*	Char	The Member’s Customer ID. (Your ID).
! Price*	Dec	The Item’s Price for this customer. (No commas or parenthesis) Ex. 12345.67
! Customer Item Number	Char	Customer’s Item Number for this item (If applicable).
! UOM	Char	Unit of Measure by which the item will be priced and sold.
! Min Qty	Int	Minimum Qty for this price.
! Lead Days	Char	Number of lead days for item price.
! Replacement Item	Char	Item number of new item that replaced this item.
! Increment	Int	Allow orders to be placed for this item in increments of this number.
! Price Text	Char	Text to display instead of numeric price
! Item Status	Char	Status Code used for future enhancements
! Carriage Return	Char	Carriage Return (ASCII #13).
! Line Feed	Char	Line Feed (ASCII #10).

  Try
	! dim List$[100,50]
	dim SearKey$[100],custkey$[6],prodkey$[12],lpkey$[50],shipkey$[20],slpckey$[50],savslpckey$[50]
	Dim tmp$[1200],sellum$[4],priceum$[4]
	dblog$="files/6/lp.log" ! fields for DEBUG

	dim 1%, cnvtu[2]
	dim 2%
	dim 3%, r[99],custrec, prodrec, PRR, LPR, cnvta, SLPR
	Dim 3%, cprice[1]
	
	Dim LP. as lastprice ! last price file (Dir fix)
	Dim SLP. as sllstprice ! ship list last price
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse

	clear list$[], umlist$[], webstr$

	txt=findchannel()
	tmp$="tmp/TPRICE.txt!"
	try
		Build #txt,+tmp$
	Else
		txt=0
	End try

	clear webstr$
	webstr$="TPRICE"+tdel$+MEMBERID$+tdel$+MEMBERNAME$
	print #txt;webstr$
	clear webstr$

	! open files

	Let SearKey$="";custkey$="";shipkey$="";prodkey$="";LPR=0;lpkey$=""

	Call DXGet("LPKEY",tmp$)
	if tmp$ let lpkey$=ReplacePipe$(tmp$)+blank$

	Do Until LPR<0
		!LOOP_LPR: REM loop thru shipto file
		!-----------------------------------------------
		
		LPR=filegetlastpricez(e$,LPC,">",1,lpkey$,lp.)
		!
		! #1 check customer is flagged for Eccos
		custkey$=lp.CustNum using "######"
		CUR=filegetcust(e$,CUC,"=",1,custKey$,Cust.)
		If CUR<0 or Cust.EccosFlag=0
			let lpkey$=lp.CustNum+1 using "######"
			if lp.CustNum+1>999999 let LPR=-2
			Goto End_LPR
		End If
		!
		! #2 check product flagged for Eccos
		clear pr.
		clear prw.
		prodkey$=lp.prod$
		PRR=filegetprod(e$,PRC,"=",1,ProdKey$,PR.)
		If not(CheckProductEccosFlag(PRC,PRR,WHC,PWR,prodkey$,PR.,PRW.,custom_customer$)) Goto End_LPR
		!
		! OK good to export Main cust/prod
		!
		if lp.lpprice*1<>lp.lpprice let lp.lpprice=0   ! uninitialized field
		!
		! set up price call:
		KCM$=" ",kcm$;kcm$=lp.ComdtyCode$+Blank$;kcm$[5]=""
		CMR=filegetcommhead(e$,CMC,"=",1,kcm$,Comd.) ! need comm rec#
		If CMR<0 Let CMR=0

		fleptr[1,1]=PRR;fleptr[2,1]=PWR;fleptr[3,1]=CMR ! prod,prodwh,comm
		fleptr[4,1]=LPC;fleptr[4,1]=LPR

		if lp.WgtFactor<=1 Let lp.WgtFactor=1
		X3=((lp.UnitWgt*lp.Quantity)/lp.WgtFactor)
		Specs[0]=0;Specs[1]=lp.Quantity;Specs[2]=X3
		Specs[3]=lp.CustNum;Specs[4]=lp.Whse;Specs[5]=0 !lp.OrdDate
		Specs[6]=lp.Dept;Specs[8]=1 ! assume ot 1
		let Specs[7]=cust.PriceType
		! default cost from prtype file
		cpt=openfile(-752,Intco) \ if cpt=-1 Error 42
		mat read #cpt,specs[7],28;PT;
		Close #cpt ! that's all we needed from file
		X=Specs[8]-1 ! pt[] is 0 to 37
		If X<0 let x=0
		X2=PT[x] \ if x2=0 let x2=P60$[29,29]
		Specs[9]=X2 ! default cost
		Specs[13]=lp.UMSell;Specs[14]=lp.UMPrice;Specs[15]=lp.UMCost
		Specs[16]=0
		Specs[17]=0 ! lp.UnitCost
		Specs[18]=0 ! no lc 2
		Specs[20]=0 ! lp.UnitPrice
		Specs[21]=0 ! 
		Specs[22]=0 ! LineDiscPct
		Specs[23]=0 ! lp.LpUnitPrice ! NetPrice
		Specs[24]=0 ! lp.RebateContract
		Specs[25]=0 ! lp.LastPriceType ! PriceOrigin
		Specs[26]=0 ! lp.LastCostOrg ! CostOrigin
		Specs[27]=0 ! lp.Contract ! Contract
		Specs[28]=0 ! SpCommPct
		Specs[29]=0 ! lp.BrkLvl ! BrkLvl
		Specs[40]=0 ! LoadUpchrg
		!
		Call GetPrice()
		!
		if finepaper
			priceum$=xunit$(LP.UMPrice,ccc) ! u/m
			sellum$=xunit$(LP.UMSell,ccc) ! u/m
			LET CNVTA=LP.UnitPrice;CNVTU[0]=0;CNVTU[1]=LP.UMPrice;CNVTU[2]=2;convflag=0
		else ! industrial 
			priceum$=xunit$(LP.UMSell,ccc) ! u/m for jansan make um's match sell
			sellum$=xunit$(LP.UMSell,ccc) ! u/m
			LET CNVTA=LP.UnitPrice;CNVTU[0]=0;CNVTU[1]=LP.UMSell;CNVTU[2]=2;convflag=0
		end if
		LET LastPrice=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)
		!
		LET cnvta=LP.Quantity;CNVTU[0]=0;CNVTU[1]=LP.UMSell;CNVTU[2]=1;convflag=0
		LET LastQty=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)

		itemcnt=itemcnt+1

		webstr$= RTrim$(lp.Prod$) +tdel$
		webstr$=webstr$+ Str$(lp.CustNum) +tdel$
		webstr$=webstr$+ Str$(CPrice[0]) +tdel$ ! in sellum else fine in priceum
		webstr$=webstr$+ "" +tdel$	! cust item code (alt)
		sellum$=GetEDIUM$(sellum$)
		webstr$=webstr$+ SellUM$ +tdel$
		webstr$=webstr$+ "" +tdel$	! min qty
		webstr$=webstr$+ "" +tdel$	! lead days
		webstr$=webstr$+ RTrim$(pr.SupersedeCode$) +tdel$	! replacement item (supercede)
		webstr$=webstr$+ "" +tdel$	! increments
		webstr$=webstr$+ "" +tdel$	! price text
		webstr$=webstr$+ ""			! item status

		itemcnt=itemcnt+1
		print #txt;webstr$
		clear webstr$

	End_LPR: Loop
	! Set the esdel and go

	Close #TXT
	System "unix2dos tmp/tprice.txt"

	if morelprecs=0
		let returnstatus=1
		let message$="OK"
	end if

	!
  else
    include "src/callsuberr.inc"
  end try

End Sub !--------------Order Guide-----------------

External Function CheckProductEccosFlag(PRC,prodrec,WHC,WHRec,prodkey$,PR. as Prod,PRW. as prodwhse,custom_customer$)
	!
	! dim PR. as prod ! product
	! dim PRW. as prodwhse ! product warehouse

	dim SearKey$[100],prwkey$[14],cmckey$[4],vendkey$[6]
	dim cmcdesc$[16],cmcremarks$[15],CATDESC$[24],vendname$[30],pack$[20]
	dim bkum$[4],stunit$[4],sellum$[4],priceum$[4],baseum$[4],valdum$[112],ccd$[14],sunit$[14]
	dim mweight$[50]
	Dim e$[500],tmp$[1200]
	dim 1%,pfu1[14],eccosflag
	dim 2%
	dim 3%, r[99],prodrec, whrec, cmcrec


	!-----------------------------------------------
	! Prodrec=filegetprod(e$,PRC,"=",1,ProdKey$,PR.)
	if prodrec<0 goto bad_prod
	!-----------------------------------------------
	! filter out products
	!
	if pr.eccosflag<1 goto bad_prod
	If Not(PR.UserDefCatgyId) goto bad_prod: ! no ctgy - no send
	tmp$ = " ",tmp$                                   
	tmp$=PR.Desc1$+PR.Desc2$          ! desc 1 & 2     
	call string(1,tmp$)   ! uppercase it              
	search tmp$,"DISCONTINUE",bad1                    
	search tmp$,"DO NOT USE",bad2                     
	if (bad1 or bad2) goto bad_prod
	! if pr_a2$[1,12]<>blanks$[1,12] goto loop_prod:   ! superceded don't send
	!-----------------------------------------------
	!GET_WHSE:  check whse do not reorder flag
	prwkey$=PR.ProdCode$+" 1"  ! only checking whse 1 do not reorder
	WHRec=filegetprodwhse(e$,WHC,">=",1,PRWKey$,PRW.)
	If prwkey$[1,12]<>prodkey$[1,12] goto bad_prod
	if custom_customer$="GPG"
		! no dnr check to gpg
	else
		IF PRW.DNReordFlg=1 goto bad_prod
	end if
	!-----------------------------------------------
	! If we got this far it is O
	EccosFlag=1 \ Goto Done_prod:
	!
	Bad_prod: Eccosflag=0
	!
	Done_prod:!

End Function EccosFlag

!--------------------------------------------------------------------
Sub GetPrice()
! get the current cost for a product (using Price()
! if no problem (specs[0]=0)) PermCost=Specs[17] & PermCostOrg=Specs[26]
  Try
	Dim K1$[50]
	Dim 3%
	Dim PW. as prodwhse ! prodwhse file

	clear e$
	! Call getcust() ! done already
	if lp.Whse>0
		k1$=lp.prod$+blank$
		k1$[13]=lp.Whse Using "##"
		PWR=filegetprodwhse(e$,WHC,"=",1,K1$,pw.)
		If PWR<0 Let PWR=0
		clear e$
	Endif
	! send rec #'s
	let x2=Cust.LpPpGrpCust
	If P60$[33,33]<>"Y" Let X2=0
	If CUST.AuthBuyList$="Y" Let X2=0
	If X2=CUST.CustomerCode let x2=0
	if x2<1 or x2>999999 or Fra(X2) Let X2=0

	let fleptr[0,1]=X2 ! perm price group
	
	!if lp.WgtFactor<=1 Let lp.WgtFactor=1
	!X3=((lp.UnitWgt*lp.Quantity)/lp.WgtFactor)
	!Specs[0]=0;Specs[1]=lp.Quantity;Specs[2]=X3
	!Specs[3]=lp.CustNum;Specs[4]=lp.Whse;Specs[5]=lp.OrdDate
	!Specs[6]=lp.Dept;Specs[8]=1 ! assume ot 1
	!let Specs[7]=cust.PriceType
	! default cost from prtype file
	!cpt=openfile(-752,Intco) \ if cpt=-1 Error 42
	!mat read #cpt,specs[7],28;PT;
	!Close #cpt ! that's all we needed from file
	!X=Specs[8]-1 ! pt[] is 0 to 37
	!If X<0 let x=0
	!X2=PT[x] \ if x2=0 let x2=P60$[29,29]
	!Specs[9]=X2 ! default cost
	!Specs[13]=lp.UMSell;Specs[14]=lp.UMPrice;Specs[15]=lp.UMCost
	!Specs[16]=0
	!Specs[17]=lp.UnitCost
	!Specs[18]=0 ! no lc 2
	!Specs[20]=lp.UnitPrice
	!Specs[21]=0 ! 
	!Specs[22]=0 ! LineDiscPct
	!Specs[23]=lp.LpUnitPrice ! NetPrice
	!Specs[24]=lp.RebateContract
	!Specs[25]=lp.LastPriceType ! PriceOrigin
	!Specs[26]=lp.LastCostOrg ! CostOrigin
	!Specs[27]=lp.Contract ! Contract
	!Specs[28]=0 ! SpCommPct
	!Specs[29]=lp.BrkLvl ! BrkLvl
	!Specs[40]=0 ! LoadUpchrg
	
	Let dbg=debug;dlog$=dblog$ ! pass what this program uses
	!
	IF TIM(2)-Lp.LPTIME<TIMCHECK and lp.lpprice>0
		specs[23]=lp.lpprice
	else
		Call SysPriceCalc(e$,FLEPTR[],SPECS[],MSGDESC$,dbg,dlog$)
	end if
	!
	clear e$

	if finepaper
		LET CNVTA=SPECS[23];CNVTU[0]=0;CNVTU[1]=LP.UMPrice;CNVTU[2]=2;convflag=0
	else ! industrial
		LET CNVTA=SPECS[23];CNVTU[0]=0;CNVTU[1]=LP.UMSell;CNVTU[2]=2;convflag=0
	end if
	!X3=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)
	LET CPRICE[0]=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)

	LET CNVTA=SPECS[23];CNVTU[0]=0;CNVTU[1]=LP.UMSell;CNVTU[2]=2;convflag=0
	LET CPRICE[1]=ConvProdAmount(e$,CNVTU[],CNVTA,ctlc,FLAG,PR.)

  else
    include "src/callsuberr.inc"
 end try
end sub ! GetCost
!------------------------------------------------------------------
External Function ReplaceSpace$(Desc$)
	!remove space and replace with a pipe
	dim temp$[255]
	temp$ = RTrim$(desc$)
	Let position=0                                                     
	SubChar1: !                                                         
	Search desc$," ",position                                          
	If position then let desc$[position,position]="|" \ goto subChar1: 
End Function desc$
!------------------------------------------------------------
External Function ReplacePipe$(Desc$)
	!remove | and replace with a space
	dim temp$[255]
	temp$ = RTrim$(desc$)
	Let position=0                                                     
	SubChar2: !                                                         
	Search desc$,"|",position                                          
	If position then let desc$[position,position]=" " \ goto subChar2: 
End Function desc$
!------------------------------------------------------------
External Function GetIMGSVRIP$()
		Dim FileName$[100],fieldname$[80],value$[80],imgsvrip$[250],e$[500]
		FileName$="sfsystem.txt"
		Chan=FindChannel()
		ropen #Chan,FileName$ as "profile"
		!systemwide option flags for salespro
		try
			search #Chan;"salespro" !search for salespro section, case insensitive
			mode=-2
			Do
				read #chan,mode;fieldname$,value$
				mode=-1
				if len(value$)>1
					if value$[len(value$)]="\15\" let value$=value$[1,len(value$)-1]
				end if
				if fieldname$ = "imgsvrip" and value$ <> ""
					imgsvrip$ = RTrim$(value$)
				end if
			Loop
		else
			if spc(8)<>52
				include "src/callsuberr.inc"
			end if
		end try
		close #chan
End Function imgsvrip$
!------------------------------------------------------------

!
Sub GetPromo()
 Try
	Dim spkey$[18],x$[10]
	Dim 2%,JDATEDIFF,TODAYJDATE,PROMOJDATE
	Dim 3%, spr
	Let PromoFlag=0
	
	TODAYJDATE = Tim(6)

	! first try product specific
	Let spkey$[1,6]="999999"
	Let spkey$[7]=pr.prodcode$+blank$
	spr=filegetspecprice(e$,splc,"=",1,spkey$,spcl.)
	if spr>=0 goto GotPromo:

	! try commodity specific
	Let spkey$[1,7]="999999*"
	Let spkey$[8]=PR.ComdtyCode$+blank$
	spr=filegetspecprice(e$,splc,"=",1,spkey$,spcl.)
	if spr>=0 goto GotPromo:

	!
	! try all prods specific
	!Let spkey$="999999#"+blank$
	!spr=filegetspecprice(e$,splc,"=",1,spkey$,spcl.)
	!if spr>=0 goto GotPromo:
	! try size specific
	!Let spkey$[1,7]="999999&"
	!Let spkey$[8]=pr.prodcode$+blank$
	!spr=filegetspecprice(e$,splc,"=",1,spkey$,spcl.)
	!if spr>=0 goto GotPromo:
	Goto PromoOut: ! nothing found
	!
	GotPromo: ! read record

	promosdate$=" "
	promoedate$=" "
	promojdate=0

	let x$=spcl.CancelDate using "######"
	Call DateToJulian(1,X$,X$,E)
	if not(E) let PROMOJDATE=X$
	JDateDiff=TodayJDate-PromoJDate
	if JDateDiff>=0 goto PromoOut:

	if spcl.StartDate let promosdate$=PDate$(spcl.StartDate)
	if spcl.CancelDate let promoedate$=PDate$(spcl.CancelDate)

	! setup price call:

		KCM$=" ",kcm$;kcm$=pr.ComdtyCode$+Blank$;kcm$[5]=""
		CMR=filegetcommhead(e$,CMC,"=",1,kcm$,Comd.) ! need comm rec#
		If CMR<0 Let CMR=0

		fleptr[1,1]=Prodrec;fleptr[2,1]=whrec;fleptr[3,1]=CMR ! prod,prodwh,comm

		if pr.LbsFact<=1 Let pr.LbsFact=1
		X3=((pr.LbsUnit*QtySell)/pr.LbsFact)
		Specs[0]=0;Specs[1]=QtySell;Specs[2]=X3
		If P60$[12,12] = "Y" and action1$<>"GETPRICEDEF" let Specs[0]=299 ! do not use amalg bypass in price

		CustomerCode=999999 ! cash for retail default pricing
		Specs[3]=CustomerCode;Specs[4]=Whse
		
		EffDate=Curdate
		Specs[5]=EffDate \ if effDate<>CurDate let Specs[5]=0-EffDate ! call it future
		Specs[6]=DeptNo;Specs[8]=1 ! assume ot 1
		!let Specs[7]=cust.PriceType
		! default cost from prtype file
		!cpt=openfile(-752,Intco) \ if cpt=-1 Error 42
		!mat read #cpt,specs[7],28;PT;
		!Close #cpt ! that's all we needed from file
		X=Specs[8]-1 ! pt[] is 0 to 37
		If X<0 let x=0
		X2=PT[x] \ if x2=0 let x2=P60$[29,29]
		Specs[9]=X2 ! default cost

		If finepaper  ! UMs
			Specs[13]=PR.UMSellDefault;Specs[14]=PR.UMPriceDefault;Specs[15]=pr.UMCostDefault
		Else
			Specs[13]=PR.UMSellDefault;Specs[14]=PR.UMSellDefault;Specs[15]=pr.UMCostDefault
		End If

		Specs[16]=0
		Specs[17]=0 ! UnitCost
		Specs[18]=0 ! no lc 2
		Specs[20]=0 ! UnitPrice
		Specs[21]=0 ! 
		Specs[22]=0 ! LineDiscPct
		Specs[23]=0 ! NetPrice
		Specs[24]=0 ! RebateContract
		Specs[25]=0 ! PriceOrigin
		Specs[26]=0 ! CostOrigin
		Specs[27]=0 ! Contract
		Specs[28]=0 ! SpCommPct
		Specs[29]=0 ! BrkLvl
		Specs[40]=0 ! LoadUpchrg
	!
	Call GetPrice()
	!
	! pass back the current price in list1 for promos
	! this becomes the retail price
	Let PR.ListPrice1=SPECS[23]
	Let promoflag=1
	!
	PromoOut: !
 else
    include "src/callsuberr.inc"
 end try
End Sub
!------------------------------------------------------------	  
Sub GetProdComp()  !complimentary items
 Try
	dim SearKey$[100],prodkey$[12]
	dim 1%, cnvtu[2]
	dim 2%
	dim 3%, r[99],custrec, prodrec, PRR, KWRec
	
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse
	dim KW. as prdkeywrd ! prod key word

	clear list$[], webstr$
	!
	webstr$=bsdel$+"Complement"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$
	webstr$=webstr$+ "ComplementaryPMID" +fdel$+rdel$
	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	Call DXGet("PRODKEY",tmp$)
	if tmp$ let prodkey$=tmp$+blank$

	Do Until PRR<0
    !
		PRR=filegetprod(e$,PRC,">",1,ProdKey$,PR.)
		if PRR<0 Goto End_Comp
		If not(CheckProductEccosFlag(PRC,PRR,WHC,whrec,prodkey$,PR.,PRW.,custom_customer$)) Goto End_Comp
		!
		! OK good to export 

		!complimentary items
		SearKey$=pr.ProdCode$
		Dir=1 ! by product number

		KWRec=filegetprdkeywrd(e$,KWC,"=",Dir,SearKey$,KW.)

		if KWRec<0 !?? add mode, other fields?
			clear kw. \ goto End_comp:  ! no comp for this item
		end if
		
		If RTrim$(KW.ComplItem1$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem1$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem2$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem2$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem3$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem3$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem4$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem4$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem5$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem5$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem6$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem6$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem7$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem7$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem8$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem8$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem9$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem9$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if
		If RTrim$(KW.ComplItem10$)
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+RTrim$(KW.ComplItem10$)+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
		End if

		!
		If itemcnt>=3000
			moreprods=99
			let returnstatus=5
			let message$="PRODKEY="+RTrim$(PRODKEY$)+"&"
			Exit Do
		End if
		!
	    End_comp: Loop
		! Set the esdel and go
		call AddToStr(e$,rstr$,esdel$)

		if moreprods=0
			if itemcnt>0
				let returnstatus=1
				let message$="OK"
			else
				let returnstatus=0
				let message$="No Records"
			end if

		end if
	!
 else
    include "src/callsuberr.inc"
 end try
End Sub
!------------------------------------------------------------	  
Sub GetBudget()  !return budget data
 Try

	Dim 1%,FLAG                                                                 
	Dim 2%,c1[9],cutoff[2]                                                      
	Dim 4%,x3[9],shipto,billto                                                  
	Dim x$[12],c1$[20],F$[16],cust$[10],ship$[14],prog$[20]                     
	Dim total$[10],used$[10],onord$[10],edate$[20],btype$[10],po$[20],sdate$[20]
	dim cpo$[1,1],shipdate$[20],tbpo$[16]                                                 

	dim SearKey$[100],prodkey$[12]
	dim 1%, cnvtu[2]
	dim 2%
	dim 3%, r[99],custrec, prodrec, PRR, KWRec
	
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse
	dim KW. as prdkeywrd ! prod key word

	clear list$[], webstr$

	!Call DXGet("PROG",prog$)
	Call DXGet("CUST",cust$)
	Call DXGet("SHIP",ship$)
	Call DXGet("BTYPE",btype$)
	Call DXGet("TOTAL",total$)
	Call DXGet("USED",used$)
	Call DXGet("ONORD",onord$)
	Call DXGet("SDATE",sdate$)
	Call DXGet("EDATE",edate$)
	Call DXGet("PO",po$)  
	prog$ = ucase$(action$) 
	btype$ = ucase$(btype$)
	po$ = ucase$(po$)
	if po$ = "BUDGETADD" or po$ = "BUDGET" let po$ = ""

	if sdate$                                                   
			x$ = sdate$                                         
			call verifydate(x$,sdate$,e)                        
			if e let sdate$ = "0";btype$="B "                   
	else                                                        
			sdate$="0"                                          
	end if                                                      
	if edate$                                                   
			x$ = edate$                                         
			call verifydate(x$,edate$,e)                        
			if e and sdate$<>"0"                                
					Call GetEndDate(sdate$,edate$,btype$)       
			end if                                              
	else                                                        
			if sdate$<>"0" Call GetEndDate(sdate$,edate$,btype$)
	end if                                                      
	!
	webstr$=bsdel$+"BUDGET"+fdel$+rdel$
	webstr$=webstr$+"PROG"+fdel$
	webstr$=webstr$+"CUST"+fdel$
	webstr$=webstr$+"SHIP"+fdel$
	webstr$=webstr$+"BTYPE"+fdel$
	webstr$=webstr$+"TOTAL"+fdel$
	webstr$=webstr$+"USED"+fdel$
	webstr$=webstr$+"ONORD"+fdel$
	webstr$=webstr$+"SDATE"+fdel$
	webstr$=webstr$+"EDATE"+fdel$
	webstr$=webstr$+"PO"+fdel$  ! +rdel$
	webstr$=webstr$+"POREQ"+fdel$
	webstr$=webstr$+"PODUPE"+fdel$
	webstr$=webstr$+"SHIPDATE"+fdel$
	webstr$=webstr$+"CUTOFF"+fdel$+rdel$

	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	c1 = cust$
	x3[9] = ship$
	If Not(x3[9])
	  c1[1] = -1
	Else 
	  Search ship$,".",nPos
	  ! c1[1] = Fra(x3[9]) * 1000000
	  if nPos c1[1] = ship$[nPos+1] else c1[1]=-1
	  Try 
		if val(ship$)>0 let c1[1]=Val(ship$)
	  else
		!
	  end try
	  billto=cust$ \ shipto=c1[1]
	  if billto=shipto let c1[1]=-1  ! these are defaulted by synergie
	End If 
	x3[9] = 0
	FLAG = 0  ! 0=all 1=on order only 9=write
	if prog$="BUDGETADD"
	flag=9  ! add budget info
	c1$=po$
	f$=btype$
	x3[0] = total$
	x3[1] = used$
	x3[2] = onord$
	x3[3] = sdate$
	! x3[3] = edate$
	x3[4] = edate$
	end if

	! Call CSBUDGINFO here
	! Call "prog/misc/CSBUDGINFO",c1,c1[1],FLAG,c1$,F$,x3[]
	! Call "CSBUDGINFO.DL4",X2,X2[1],BPFlag,TBPO$,X$,x3[],Intco
	Call "CSBUDGINFO.DL4",c1,c1[1],FLAG,c1$,F$,x3[],Intco
	Call CheckCust(c1[], cpo$[], shipdate$, cutoff[],Intco)
	!
	webstr$=prog$ + fdel$
	webstr$=webstr$+  c1 Using "######" + fdel$
	If c1[1] = -1 ! no shipto budget setup                        
			webstr$=webstr$+  "N/A" + fdel$
	Else ! got shipto info                                        
			! webstr$=webstr$+  c1[1] / 1000000 Using ".&&&&&&" + fdel$
			webstr$=webstr$+  c1[1] Using "&&&&&&" + fdel$
	End If                                                        
	webstr$=webstr$+ f$ + fdel$ ! type                         
	webstr$=webstr$+ x3[0] Using "--------#" + fdel$ ! total        
	webstr$=webstr$+ x3[1] Using "#########" + fdel$ ! used         
	webstr$=webstr$+ x3[2] Using "#########" + fdel$ ! on order     
	x$ = x3[3] Using "######"   ! st date                           
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$
	x$ = x3[4] Using "######"   ! end date                         
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$                              
	webstr$=webstr$+ c1$ + fdel$ ! po                         
	webstr$=webstr$+ cpo$[0] + fdel$ ! po req                 
	webstr$=webstr$+ cpo$[1] + fdel$ ! po dupe check          
	x$=shipdate$  ! [1,6]                                         
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$ ! shipdate                             
	webstr$=webstr$+ fdel$+rdel$ ! no cutoff time                         
	!webstr$=webstr$+ "Orders placed after 4:30pm will be processed the following business day." + fdel$ ! cutoff time
	call AddToStr(e$,rstr$,webstr$+esdel$)
	!
	let returnstatus=1
	let message$="OK"

 else
    include "src/callsuberr.inc"
 end try
End Sub  ! getbudget
!------------------------------------------------------------	  
Sub AddBudget()  !return budget data
  Try
	Dim 1%,FLAG                                                                 
	Dim 2%,c1[9],cutoff[2]                                                      
	Dim 4%,x3[9],shipto,billto                                                  
	Dim x$[12],c1$[20],F$[16],cust$[10],ship$[14],prog$[20]                     
	Dim total$[10],used$[10],onord$[10],edate$[20],btype$[10],po$[20],sdate$[20]
	dim cpo$[1,1],shipdate$[20],tbpo$[16]                                                 

	dim SearKey$[100],prodkey$[12]
	dim 1%, cnvtu[2]
	dim 2%
	dim 3%, r[99],custrec, prodrec, PRR, KWRec
	
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse
	dim KW. as prdkeywrd ! prod key word

	clear list$[], webstr$

	!Call DXGet("PROG",prog$)
	Call DXGet("CUST",cust$)
	Call DXGet("SHIP",ship$)
	Call DXGet("BTYPE",btype$)
	Call DXGet("TOTAL",total$)
	Call DXGet("USED",used$)
	Call DXGet("ONORD",onord$)
	Call DXGet("SDATE",sdate$)
	Call DXGet("EDATE",edate$)
	Call DXGet("PO",po$)  
	prog$ = ucase$(action$) 
	btype$ = ucase$(btype$)
	po$ = ucase$(po$)
	if po$ = "BUDGETADD" or po$ = "BUDGET" let po$ = ""

	if sdate$                                                   
			x$ = sdate$                                         
			call verifydate(x$,sdate$,e)                        
			if e let sdate$ = "0";btype$="B "                   
	else                                                        
			sdate$="0"                                          
	end if                                                      
	if edate$                                                   
			x$ = edate$                                         
			call verifydate(x$,edate$,e)                        
			if e and sdate$<>"0"                                
					Call GetEndDate(sdate$,edate$,btype$)       
			end if                                              
	else                                                        
			if sdate$<>"0" Call GetEndDate(sdate$,edate$,btype$)
	end if                                                      
	!
	webstr$=bsdel$+"BUDGETADD"+fdel$+rdel$
	webstr$=webstr$+"PROG"+fdel$
	webstr$=webstr$+"CUST"+fdel$
	webstr$=webstr$+"SHIP"+fdel$
	webstr$=webstr$+"BTYPE"+fdel$
	webstr$=webstr$+"TOTAL"+fdel$
	webstr$=webstr$+"USED"+fdel$
	webstr$=webstr$+"ONORD"+fdel$
	webstr$=webstr$+"SDATE"+fdel$
	webstr$=webstr$+"EDATE"+fdel$
	webstr$=webstr$+"PO"+fdel$  ! +rdel$
	webstr$=webstr$+"POREQ"+fdel$
	webstr$=webstr$+"PODUPE"+fdel$
	webstr$=webstr$+"SHIPDATE"+fdel$
	webstr$=webstr$+"CUTOFF"+fdel$+rdel$

	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	c1 = cust$
	x3[9] = ship$
	If Not(x3[9])
	  c1[1] = -1
	Else 
	  Search ship$,".",nPos
	  ! c1[1] = Fra(x3[9]) * 1000000
	  if nPos c1[1] = ship$[nPos+1] else c1[1]=-1
	  Try 
		if val(ship$)>0 let c1[1]=Val(ship$)
	  else
		!
	  end try

	  billto=cust$ \ shipto=c1[1]
	  if billto=shipto let c1[1]=-1  ! these are defaulted by synergie
	End If 
	x3[9] = 0
	FLAG = 0  ! 0=all 1=on order only 9=write
	if prog$="BUDGETADD"
	flag=9  ! add budget info
	c1$=po$
	f$=btype$
	x3[0] = total$
	x3[1] = used$
	x3[2] = onord$
	x3[3] = sdate$
	! x3[3] = edate$
	x3[4] = edate$
	end if

	! Call CSBUDGINFO here
	! Call "prog/misc/CSBUDGINFO",c1,c1[1],FLAG,c1$,F$,x3[]
	! Call "CSBUDGINFO.DL4",X2,X2[1],BPFlag,TBPO$,X$,x3[],Intco
	Call "CSBUDGINFO.DL4",c1,c1[1],FLAG,c1$,F$,x3[],Intco
	Call CheckCust(c1[], cpo$[], shipdate$, cutoff[],Intco)
	!
	webstr$=prog$ + fdel$
	webstr$=webstr$+  c1 Using "######" + fdel$
	If c1[1] = -1 ! no shipto budget setup                        
			webstr$=webstr$+  "N/A" + fdel$
	Else ! got shipto info                                        
			!webstr$=webstr$+  c1[1] / 1000000 Using ".&&&&&&" + fdel$
			webstr$=webstr$+  c1[1] Using "&&&&&&" + fdel$
	End If                                                        
	webstr$=webstr$+ f$ + fdel$ ! type                         
	webstr$=webstr$+ x3[0] Using "--------#" + fdel$ ! total        
	webstr$=webstr$+ x3[1] Using "#########" + fdel$ ! used         
	webstr$=webstr$+ x3[2] Using "#########" + fdel$ ! on order     
	x$ = x3[3] Using "######" ! st date                           
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$
	x$ = x3[4] Using "######" ! end date                         
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$                              
	webstr$=webstr$+ c1$ + fdel$ ! po                         
	webstr$=webstr$+ cpo$[0] + fdel$ ! po req                 
	webstr$=webstr$+ cpo$[1] + fdel$ ! po dupe check          
	x$=shipdate$  ! [1,6]                                         
	Call formatdate(x$,x$,e)                                      
	webstr$=webstr$+ x$ + fdel$ ! shipdate                             
	!webstr$=webstr$+ fdel$+rdel$ ! no cutoff time                         
	webstr$=webstr$+ "Orders placed after 4:30pm will be processed the following business day." + fdel$+rdel$ ! cutoff time
	call AddToStr(e$,rstr$,webstr$+esdel$)
	!
	let returnstatus=1
	let message$="OK"

 else
    include "src/callsuberr.inc"
 end try
End Sub  ! addbudget
!------------------------------------------------------------	  
External Sub GetEndDate(sdate$,edate$,btype$)
	! calc end date here
	! expire type(DB),Date type(MQSAC)
	Dim tmpdate$[20],x$[20],3%

	if btype$[1,1]="D"
		call formatdate(sdate$,tmpdate$)  ! result MM/DD/YY
		mm=tmpdate$[1,2]
		dd=tmpdate$[4,5]
		yy=tmpdate$[7,8]

		Select Case btype$[2,2]
		Case "M"  ! monthly
			mm=mm+1
			if mm>12 let mm=1;yy=yy+1
			x$ = tmpdate$              
			x$[1,2]=mm using "&&"  
			x$[4,5]=dd using "&&"    
			x$[7,8]=yy using "&&"    
			e=1                      
			Do until not(e)
				call verifydate(x$,edate$,e)
				if e
					dd=dd-1 \ x$[4,5]=dd using "&&"
				else
					! got a good date
				endif
			Loop
		! done "M"

		Case "Q"  ! quarterly
			mm=mm+3
			if mm>12 let mm=(mm-15)+3;yy=yy+1
			x$ = tmpdate$              
			x$[1,2]=mm using "&&"  
			x$[4,5]=dd using "&&"    
			x$[7,8]=yy using "&&"    
			e=1                      
			Do until not(e)
				call verifydate(x$,edate$,e)
				if e
					dd=dd-1 \ x$[4,5]=dd using "&&"
				else
					! got a good date
				endif
			Loop
		! done "Q"

		Case "S"  ! semi-annual
			mm=mm+6
			if mm>12 let mm=(mm-18)+6;yy=yy+1
			x$ = tmpdate$              
			x$[1,2]=mm using "&&"  
			x$[4,5]=dd using "&&"    
			x$[7,8]=yy using "&&"    
			e=1                      
			Do until not(e)
				call verifydate(x$,edate$,e)
				if e
					dd=dd-1 \ x$[4,5]=dd using "&&"
				else
					! got a good date
				endif
			Loop
		! done "S"

		Case "A"  ! annual
			yy=yy+1
			x$ = tmpdate$              
			x$[1,2]=mm using "&&"  
			x$[4,5]=dd using "&&"    
			x$[7,8]=yy using "&&"    
			e=1                      
			Do until not(e)
				call verifydate(x$,edate$,e)
				if e
					dd=dd-1 \ x$[4,5]=dd using "&&"
				else
					! got a good date
				endif
			Loop
		! done "A"

		Case "C"  ! custom
			if not(edate$) let edate$=tmpdate$
			x$ = edate$
			call verifydate(x$,edate$,e)
			if e let edate$=sdate$
		End Select

	Else  ! btype[1,1]<>D
		edate$ = "0"
	end if
		! end calc end date
End Sub  ! getenddate
!--------------------------------------------------------------------
External Sub CheckCust(c1[], cpo$[], shipdate$, cutoff[],Intco)
	Declare Intrinsic Function FindChannel
	Declare Intrinsic Sub DateToJulian, JulianToDate,FormatDate,VerifyDate

	dim 1%,c7[4],coid,x$[20]
	dim custkey$[6],shipkey$[14],f$[100],work$[100]
	dim 2%,cuttime[99,1],cdate[5]
	dim 3%,cfin[8],param[9]

	LET X2=TIM(6);X$=X2+1 USING "#####"            
	CALL JulianToDate(1,X$,WORK$,E)
	LET CDATE[0]=(WORK$[7,8]+WORK$[1,2]+WORK$[4,5]) ! tomorrow
	LET X2=TIM(6);X$=X2 USING "#####"              
	CALL JulianToDate(1,X$,WORK$,E)
	LET CDATE[1]=(WORK$[7,8]+WORK$[1,2]+WORK$[4,5]) ! today
	LET X$=TIM(6) USING "#####"                    
	CALL JulianToDate(1,X$,WORK$,E)
	LET CDATE[2]=(WORK$[7,8]+WORK$[1,2]+WORK$[4,5]) ! today

	! COID = Int((Spc(5) - Int(Spc(5) / 16384) * 16384) / 64)
	COID=Intco   !  1
 	ch_cntrl=1	
	read #ch_cntrl,182,84,LOCKTIMEOUT;CUTTIME[0,0];
	if cuttime[0,0]=0 let cuttime[0,0]=240001

	f$=coid using "files/2/whinfo#"
	ch_cust=FindChannel()       
	Ropen #ch_whinfo,f$
		for I = 0 to 98
			read #ch_whinfo,I,3028;cuttime[I+1,0];  ! = to wh
			read #ch_whinfo,I,895;work$[1]; ! sunday pick
			cuttime[i+1,1]=work$[1]
		next I
	close #ch_whinfo

	f$=coid using "files/2/scustomer#"
	ch_cust=FindChannel()
	Ropen #ch_cust,f$
	custkey$=c1[0] using "######"
	search #ch_cust,2,1;custkey$,r,e
	if not(e)
		Mat Read #ch_cust,r,378;C7;
		Mat Read #ch_cust,r,544;cfin;
	end if
	Close #ch_cust

	Select Case c7[1]
		Case 0
			cpo$[0]="N";cpo$[1]="N"
		Case 1
			cpo$[0]="Y";cpo$[1]="N"
		Case 2
			cpo$[0]="N";cpo$[1]="Y"
		Case 3
			cpo$[0]="Y";cpo$[1]="Y"
		Case Else
			cpo$[0]="N";cpo$[1]="N"
	End Select


!-----------CUTOFF TIME------------------------------------------
	LET CURTIME=Tim(11)*10000+Tim(12)*100+Tim(13)
	if cuttime[cfin[4],0]>0 let cutoff[0]=cuttime[cfin[4],0] else cutoff[0]=cuttime[0,0]
	if cutoff[1] let cutoff[0]=cutoff[1]  ! custcutoff
	if cutoff[2] let cutoff[0]=cutoff[2]  ! shipcutoff
	if cuttime[cfin[4],1] ! means sundaypick=yes
		IF Tim(7)=5 or Tim(7)=6 let cutoff[0]=999999  ! skip fri and sat
	else  ! friday night pick
		IF Tim(7)=0 or Tim(7)=6 let cutoff[0]=999999  ! skip sat and sun
	end if
	! if shipdate>cdate[0] cutoff[0]=999999 ! shipdate>tomorrow(already future)
	shipdate$[1,2]=Tim(8) using "&&"  ! YY
	shipdate$[3,4]=Tim(9)  using "&&" ! MM
	shipdate$[5,6]=Tim(10) using "&&" ! DD 
	Call DateToJulian(1,shipdate$,x$,e)
	x = x$ \ x=x+1 ! tomorrow
	x$ = x using "#####"
	Call JulianToDate(1,x$,x$,e)  ! returns MM/DD/YY
	Call VerifyDate(x$,x$,e)  ! returns YYMMDD
	shipdate$=x$ \ shipdate=shipdate$

	IF CURTIME>cutoff[0]
		Call DateToJulian(1,shipdate$,x$,e)
		x = x$ \ x=x+1 ! tomorrow
		x$ = x using "#####"
		Call JulianToDate(1,x$,x$,e)
		Call VerifyDate(x$,x$,e)  ! returns YYMMDD
		shipdate$=x$ \ shipdate=shipdate$
		! LET X2=shipdate \ GOSUB YMD2JUL: \ LET X2=0  
		! LET X2=X2+1      ! add 1 day for beyond cutoff
		! LET WORK$=X2 USING "&&&&&"                         
		! LET JDATE[0]=X2 \ LET JDATE[1]=X2 \ LET E=0        
		! CALL "JULIANUTIL",JDATE[],X$,E                     
		! LET X2=X$                                          
		! LET shipdate=X2                             
	end if
	! now check the date and adjust if needed
	LET PARAM[0]=cfin[4];PARAM[1]=cfin[4]
	LET CDATE[3]=shipdate;CDATE[4]=1;CDATE[5]=0          
	CALL "validdate",CDATE[3],CDATE[4],CDATE[5],PARAM[]
	IF CDATE[4]<>-2 LET shipdate=CDATE[3] 
	x$ = shipdate using "&&&&&&"
	shipdate$ = x$[3,4]+"/"+x$[5,6]+"/20"+x$[1,2]

!--------END OF CUTOFF TIME--------------------------------------
End Sub ! CheckCust

Sub GetKeyWord() !--------------------------------------------------
 Try
	dim SearKey$[100],prodkey$[12],f$[100],sortkey$[30], sortwork$[30], pwkey$[28], oldprod$[12]
	dim 1%, cnvtu[2],ch_sort, oldflag
	dim 2%
	dim 3%, r[99],custrec, prodrec, PRR, KWRec, RSort
	
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse
	dim KW. as prdkeywrd ! prod key word

	clear list$[], webstr$
	
	sortkey$=""
	Call DXGet("SORTKEY",tmp$)
	if tmp$ let sortkey$=ReplacePipe$(tmp$)+blank$

	if sortkey$=""
		BUILD_SORT: REM                                                      
		LET F$="6/SORTKWORD"
		BUILD #CH_SORT,"[1:1] "+F$+"!"                                                       
		LET R[9]=30 \ SEARCH #CH_SORT,0,1;F$,R[9],E \ IF E error 42
		LET R[9]=1 \ SEARCH #CH_SORT,0,0;F$,R[9],E \ IF E error 42
		LET R[9]=0 \ SEARCH #CH_SORT,1,0;F$,R[9],E \ IF E error 42
		!
		f$=intCo using "2/pkeywidx#"
		ch_pwk=FindChannel()       
		Ropen #ch_pwk,f$
		sortkey$=""

		Loop_PWK: Search #ch_pwk,3,1;pwkey$,rsort,e
		If Not(E)
			sortkey$=pwkey$[16,27]+pwkey$[1,15]
			Search #ch_sort,4,1;sortkey$,rsort,e
			goto Loop_PWK
		end if
		sortkey$=""
		!
	else
		Open #ch_sort,"6/SORTKWORD"
	end if


	!----------------------------------------------
	Main_PWK: !
	webstr$=bsdel$+"KEYWORD"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$
	webstr$=webstr$+ "KEYWORD" +fdel$+rdel$
	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	Loop_Sort: !
		Search #ch_sort,3,1;sortkey$,rsort,e
		if not(e) 
			prodkey$=sortkey$[1,12]
			if oldprod$<>prodkey$
				if oldflag and PRR>=0 call AddToStr(e$,rstr$,webstr$+fdel$+rdel$) \ clear webstr$
				oldprod$=prodkey$
				PRR=filegetprod(e$,PRC,"=",1,ProdKey$,PR.)
				if PRR<0 Goto Loop_Sort
				If not(CheckProductEccosFlag(PRC,PRR,WHC,whrec,prodkey$,PR.,PRW.,custom_customer$)) let PRR=-1 \ Goto Loop_Sort
				oldflag=99
				itemcnt=itemcnt+1
				webstr$=RTrim$(PR.ProdCode$)+fdel$
			end if
			!
			! OK good to export 
			if PRR>=0
				! webstr$=RTrim$(PR.ProdCode$)+fdel$
				! webstr$=webstr$+RTrim$(SortKey$[13,27])+fdel$+rdel$
				webstr$=webstr$+RTrim$(SortKey$[13,27])+"; "
				! call AddToStr(e$,rstr$,webstr$)
				! itemcnt=itemcnt+1
			end if
			!
			If itemcnt>=3000
				moreprods=99
				let returnstatus=5
				let message$="SORTKEY="+RTrim$(ReplaceSpace$(SORTKEY$))+"&"
				Goto End_PWK
			End if
			Goto Loop_Sort
			!
		End if
		!
	    End_PWK: !
		! Set the esdel and go
		call AddToStr(e$,rstr$,esdel$)

		if moreprods=0
			if itemcnt>0
				let returnstatus=1
				let message$="OK"
			else
				let returnstatus=0
				let message$="No Records"
			end if

		end if
	Close
	!
 else
    include "src/callsuberr.inc"
 end try
End Sub	! GetKeyWord

!------------------------------------------------------------	 

Sub GetAltItem() !--------------------------------------------------
 Try
	dim SearKey$[100],prodkey$[12],f$[100],sortkey$[36], altkey$[36], oldprod$[12], custkey$[6]
	dim 1%, cnvtu[2],ch_sort, CUC
	dim 2%, C1, M1[1]
	dim 3%, r[99],custrec, prodrec, PRR, KWRec, RSort, altrec, CUR
	
	dim PR. as prod ! product
	dim PRW. as prodwhse ! product warehouse
	dim KW. as prdkeywrd ! prod key word

	clear list$[], webstr$
	
	ch_stagitem = openfile(-2352) \ If ch_stagitem = -1 Error 42

	altkey$=""
	Call DXGet("ALTKEY",tmp$)
	if tmp$ let altkey$=ReplacePipe$(tmp$)+blank$

	!----------------------------------------------
	Main_Alt: !
	webstr$=bsdel$+"ALTITEM"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$
	webstr$=webstr$+ "BilltoPMID" +fdel$
	webstr$=webstr$+ "AltItemPMID" +fdel$+rdel$
	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	Loop_Alt: !
		Search #ch_stagitem,3,2;altkey$,altrec,e
		if not(e) 
			prodkey$=altkey$[1,12]
			if oldprod$<>prodkey$
				oldprod$=prodkey$
				PRR=filegetprod(e$,PRC,"=",1,ProdKey$,PR.)
				if PRR<0 Goto Loop_Alt
				If not(CheckProductEccosFlag(PRC,PRR,WHC,whrec,prodkey$,PR.,PRW.,custom_customer$)) Goto Loop_Alt
			end if

			Read #ch_stagitem,altrec,0;C1
			Mat Read #ch_stagitem,altrec,4;M1;
			
			if not(C1) goto Loop_Alt

			if C1  ! we have a custcode
				custkey$=c1 using "######"
				CUR=filegetcust(e$,CUC,"=",1,custKey$,Cust.)
				if cust.eccosflag<1 goto Loop_Alt
			end if
			!
			! OK good to export 
			webstr$=RTrim$(PR.ProdCode$)+fdel$
			webstr$=webstr$+Str$(C1)+fdel$
			webstr$=webstr$+RTrim$(altkey$[13])+fdel$+rdel$
			call AddToStr(e$,rstr$,webstr$)
			itemcnt=itemcnt+1
			!
			If itemcnt>=500
				moreprods=99
				let returnstatus=5
				let message$="ALTKEY="+RTrim$(ReplaceSpace$(ALTKEY$))+"&"
				Goto End_ALT
			End if
			Goto Loop_Alt
			!
		End if
		!
	    End_ALT: !
		! Set the esdel and go
		call AddToStr(e$,rstr$,esdel$)

		if moreprods=0
			if itemcnt>0
				let returnstatus=1
				let message$="OK"
			else
				let returnstatus=0
				let message$="No Records"
			end if

		end if
	Close
	!
 else
    include "src/callsuberr.inc"
 end try
End Sub	! GetAltItem

Sub GetTaxCodeList() !--------------------------------------------------
!
	dIM 2%,A1,A$[20],maxnew

	ctc = OpenFile(-2176,IntCo) \ if ctc = -1 Error 42 ! tax code
!----------------------------------------------------------------------------
BuildTCDroplist: !
	tmp$=bsdel$+"TAXCODELIST"+fdel$+rdel$
	tmp$=tmp$+"TAXCODE"+fdel$
	tmp$=tmp$+"DESCRIPTION"+fdel$
	tmp$=tmp$+"TAXRATE"+fdel$+rdel$
	call addToStr(e$,rstr$,tmp$)

	MaxNew = chf(ctc) - 1
	for i = 1 To MaxNew
		mat read #ctc,i,0;a$
		mat read #ctc,i,20;A1;
		if a$[1,1] > " "
			tmp$=str$(i) + fdel$ + rtrim$(a$) + fdel$ + A1 using "####.###%"+fdel$+rdel$
			call addToStr(e$, rstr$, tmp$)
		end if
	next i
	call addToStr(e$, rstr$, esdel$)

	let returnstatus=1
	let message$="OK"
End Sub	! GetTaxCodeList
!----------------------------------------------------------------------------
!
Sub ProdInfo() !--------------------------------------------------
 Try
	dim SearKey$[100],prodkey$[12],f$[100],sortkey$[36], oldprod$[12]
	dim imgsvrip$[255], sds$[100], ext$[6]
	dim 1%, cnvtu[2],ch_sort, ch_imi, ch_ims
	dim 2% 
	dim 3%, r[99], prodrec, PRR

	dim scandir$[20],ikey$[40],dr$[1],work$[255],img$[255]
	dim imi$[66]
	dim 3%,imi1,1%,imi2[3],2%,imi3[2]
	dim imsto$[44],pdffilename$[100],uniq$[12]
	dim 2%,upcflag,c1
	dim 3%,imsto[4],rec_imidx


	dim PR. as prod ! product

	clear list$[], webstr$

	IMI=FindChannel() \	Ropen #IMI,"6/IMINDEX"+str$(IntCo)
	IMS=FindChannel() \ Ropen #IMS,"6/IMSTORE"+str$(IntCo)

	ext$ = ".tif"
	If P176$[2,2] = "Y" Let ext$ = ".imd"
	If P176$[3,3] = "Y" Let ext$ = ".tif"
	If P176$[6,6] = "Y" ! 4 page images
		Dim IMask$[4],numpages$[4] \ IMask$="&&&&"
	Else
		Dim IMask$[2],numpages$[2] \ IMask$="&&"
	End if
	
	webstr$=bsdel$+"PRODINFO"+fdel$+rdel$
	webstr$=webstr$+ "ProductPMID" +fdel$
	webstr$=webstr$+ "SDSURL" +fdel$+rdel$
	call AddToStr(e$,rstr$,webstr$)
	clear webstr$
	!
	Call DXGet("PRODKEY",tmp$)
	if tmp$ let prodkey$=tmp$+blank$
	clear tmp$

	! Call DXGet("u_imgsvrip",tmp$)
	tmp$=GetIMGSVRIP$()
	if tmp$ let imgsvrip$=tmp$+blank$
	if not(imgsvrip$) let imgsvrip$="174.128.33.116:7610/imvu/"
	

	PRR=filegetprod(e$,PRC,"=",1,ProdKey$,PR.)
	if PRR<0 Goto done_prodinfo
	!

!-------------------- BUILD SDS URL ---------------------------------
	If IMGSVRIP$
		!    MSDS INFO                                          
		work$ = " ",work$                              
		work$[1,2] = "MD"                              
		work$[3,8] = Str$(PR.MSDS) ! Using "######" 
		work$[9] = ""                                  
		!                                              
		img$ = work$                            
		Search #IMI,3,1;work$,REC_IMIDX,e       
		If Val(work$[3,8]) <> PR.MSDS Let e = 2
		img$ = REC_IMIDX                        
		If Not(e)                                                     
		  Rem                                                         
		  !img$ = "failing during read of image index"                
		  Mat Read #IMI,REC_IMIDX,0;IMI$                              
		  Mat Read #IMI,REC_IMIDX,66;IMI1                             
		  Mat Read #IMI,REC_IMIDX,72;imi2                             
		  Mat Read #IMI,REC_IMIDX,80;IMI3                             
		  Rem                                                         
		  REC_IMSTO = imi2[0]                                         
		  Rem                                                         
		  img$ = "failing during read of image storage location"      
		  Mat Read #IMS,REC_IMSTO,0;IMSTO$                            
		  Mat Read #IMS,REC_IMSTO,44;IMSTO                            
		  Rem                                                         
		  numpages$ = imi2[1] Using IMask$
		  work$ = RTrim$(IMSTO$[21,40])                               
		  SCANDIR$ = work$                                            
		  !                                                           
		  ! img$ = IMI$                                               
		  img$ = LCase$(SCANDIR$ + "/" + IMI$[1,2] + "/" + Str$(IMI1))
		  !                                                           
		  ! Call FindF(img$ + "0001.tif",e)
		  Call FindF(img$ + 1 using IMask$ + ext$,E)
		  If e 
			uniq$=Tim(11) using "&&",Tim(12) using "&&",Tim(13) using "&&"
			pdffilename$="http://"+Rtrim$(IMGSVRIP$)+uniq$+Str$(IMI1)+"0001.pdf",blank$
			Open #0,"$/usr/ub/sys/fax imgtif2pdf"
			Print #0;uniq$ + Str$(IMI1) + "0001.pdf"
			For x = 1 To imi2[1]
				work$ = img$,x Using imask$  ! "&&&&.tif"
				work$ = work$ + ext$
				Call FindF(work$,found)  
				if found Print #0;work$ 
			Next x                       
			Close #0                    
			img$ = pdffilename$
		   Else
				pdffilename$="not found"
		   End If                      
		Else              ! if not(e)
		    img$ = ""      
		    numpages$ = "0"
		End If           
	Else ! not(IMGSVRIP$)
		img$=" "
	End If
	!
!-----------------------------------------------------------------------
	!
	done_prodinfo: ! OK good to export 
	let returnstatus=1
	let message$="OK"
	!
	webstr$=RTrim$(ProdKey$)+fdel$
	!  webstr$=webstr$+"http://"+RTrim$(imgsvrip$)+RTrim$(img$)+fdel$+rdel$+esdel$
	webstr$=webstr$+RTrim$(pdffilename$)+fdel$+rdel$+esdel$
	call AddToStr(e$,rstr$,webstr$)
	!
	!
 else
    include "src/callsuberr.inc"
 end try
End Sub	! ProdInfo
!-------------------------------------------------------------------------
Function GetEDIUM$(given_um$) !
try
	let edium$=given_um$,spaces$
	search #ch_edium,2,1;edium$,rec_edium,e
	if not(e)
		read #ch_edium,rec_edium,84;given_um$;
	else
		ecd3$=""
	end if
 else
    include "src/callsuberr.inc"
 end try
End Function given_um$
!-------------------------------------------------------------------------
