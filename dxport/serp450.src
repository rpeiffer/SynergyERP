! serp450.dl4 - Commission report
! 1.0 03/24/2010 - initial conversion
!
! loadsave -w -n 100,10 -o prog/dxport/serp450.dl4 src/serp450.src
!
Rem MX450 - SALESMAN COMMISSION (for morrisette)
Rem AUTHOR:   MAR 27, 1987
Rem LAST UPDATE: roman  05/30/1991  fix prompts
! mod B.Swet 2/26/92 add cust sort moved gp% & cost in with column
!          03/28/1997 - DATE COMPARE JULIAN
!  jlp 2/11/98 cct110393 sales not accumulated right if run by month
!  jlp 3/17/98 cct110205 and 110903
!  jliu 6/7/99 cct123526 take care no commssion for the salesman
!  sms 7/19/99 leap year
!  jlp 7/19/99 cct122312 number prompts, fix purge flag
!  tc 1/4/00 cct131003 fix assign of YEAR variable
!  jlp 1/4/00 (cct131003) also fix YEAR check for y2k
!  Added a year check for current month sale print 02/14/00  rab
!  jliu 04/03/00 cct134601 y2k problem
! jliu 5/22/02 cct157166 print a summery line for each salesperson for the
!              the non-amalgamted version
! jliu 6/27/02 cct158506 on the aduit version print a "*" next to the inv/cm
!              that are marked to purge. Add an option to unmark items.
! jliu 7/3/02 cct158716 add the new prompt 
!             "Use  C: current or  H: historical slsm commission records"
! jliu 7/18/02 cct159076 fix the checking AR paid date logic
! ADD CUSTOM HTBERRY CHANGES - 210768/210769 to serp
! ------------------------------------------------------------------------------
! 12/19/11 vst task10451 - for H T Berry's upgrade -custom_customer$="HTBERRY"
!                        - Added the following code:
!                          - custom_customer$ code
!  Custom code for:
! 08/01/07 rjs cct210768 - show adj gp on report
! 08/02/07 rjs cct217550 - misc problems with gp% and line feeds totals
! 08/31/07 rjs cct217884 - keep consistent how gp% is displayed
! ------------------------------------------------------------------------------
Rem BEDIT Version: 2.2 OBJECT CODE     Created: NOV 30, 2009  16:33:17
Rem /w2/papermaster/r2005//usr/acct/txc/work/r2005/mx/mx450.src (univ2) [txc] {21710}
Rem  Copyright (c) 2009 Universal Business Systems, Inc.
Rem    **** ALL CHANGES MUST BE MADE IN SOURCE!!! ****
Rem
include "src/copyright.inc"
External Lib "libgeneral.lib"
Declare External Sub GetSession,AddToStr,SetOutput,CreateNetStatus
Declare External Function getmsg$,expandarray
Declare External Function AddToMYReports
Declare External Function openprinter

External Lib "dxblockcustom.lib"
Declare External Sub blockPrintersDropList
External Lib "ubsfunc.dl4"
Declare External Sub getportdefault,GetCostLevels
Declare External Function OpenFile,PDate$,FormatDate2$,getuidinfo$,JDate$
Declare External Function chkDteFrmt$,buildsort
Declare Intrinsic Sub DateToJulian,FindF,InpBuf,String,VerifyDate,programdump
Declare Intrinsic Function findchannel
! Option Default Dialect IRIS1

Def FNW(H) = Sgn(H) * (Int(Abs(H) * 1 + .5) * 1)
If Err 0 Gosub ERR_TRAP
! If Spc(13) = 11 Print @0,0;"\177\UWHOTSPOT.\\HOTSPOT\\HOTSPOTIN.hsf\177\";
DIM 1%,CR1[2],2%,CR2[8],1%,CR4,3%,CR3[6],TOTPAID 
dim 1%,sa0[10]
DIM CASHKEY$[30],CASHKEY1$[30]                   
DIM 3%,PAYCURR,PAYPREV,AVAILMERCH,ARCOMM[1]
DIM 3%,DISCAMT,APPAMT  
DIM I$[30],3%,R[30]
Dim C1$[30],J$[75],J1$[75],J2$[20],J3$[40],J4$[75],J7$[50],K9$[50],J0$[10]
Dim J8$[8],J9$[50],K1$[50],K2$[20],K3$[20],S1$[30],Z1$[50],X$[10],SMAT$[1]
Dim P60$[50],CF$[1],P9$[50],COMP$[30],J5$[75],ARDATE$[10],TEMP$[10]
Dim 1%,Z2$[2],URECFLAG
Dim 1%,ARMONTH
Dim 1%,E,N3,N4,S4[1],X1,3%,A3[13],J,S2[1],T8[20],T9[20],S6[1],T6[1],T5[1]
Dim 3%,T10[20],T7[1],S10,S7[1],PT8[10],PT9[10],PT10[10],4%,J1
Dim 2%,A2[5],J2,J3,J4,J7[2],J8,J9,N1,N2,R3,R4,R5,S1[3],S3[1],S8,X2
Dim 2%,C1[12],JDATE[1],ARDATE,DT3[1],JWDATE,SPAYDATE,EPAYDATE,JSPAYDATE,JEPAYDATE,JPAYDATE,3%
Dim 2%,JARPAYDATE
Dim K98$[50],SCRATCH$[80],SNAME$[15],F$[16],P61$[256]
Dim 3%,GP,COST,PROFIT,PRIMTH,CURMTH,AMTPAID,COMMAMT,COMMDUE
Dim 3%,ARREF[1],X3[9],ocs1[3],COMMSRVCHG,adj_gp_dollars,adj_dollars
DIM 3%,ET8[10],ET9[10],ET10[10]
! commission audit file vars
dim k7$[30]
dim 1%,as1[3],as4[1]
dim 2%,r7,as2[1]
dim 3%,as3[5],aorigcomm,r1
dim source$[10],cas$[60]

Dim e$[500],buttonlist$[5,50],nextlist$[5,100] ! dx error handling variables
dim tmp$[800],tmp1$[800],tmp2$[800],Message$[600],msg$[100],rstr$[2000],webstr$[2000]
dim action$[30],options$[30],userid$[8],3%,fdel$[10],bsdel$[10],esdel$[10],rdel$[10]
Dim ReportDir$[128],BaseName1$[128],Statusfile$[128],action1$[30],action2$[30],custom_customer$[30]
Dim List$[100,100] ! for lists
DEF FNR(H)=SGN(H)*(INT(ABS(H)*100+.5)*.01)
! call dxopen() ! for standalone run
Call getsession(e$,CTLC,options$,action$,userid$,intCO,intSls,fdel$,rstr$,bsdel$,esdel$,rdel$,Action1$,Action2$)
!call dxget("u_custom_customer",custom_customer$)
mat read #ctlc,115,60;custom_customer$;
custom_customer$=UCase$(Trim$(custom_customer$))

call dxget("TOTONLY",tmp$)
! serp450afpS not in use any more
! if tmp$ = "2" chain "serp450afpS.dl4"
! serp450afpT is now our standard transactional commission report
if tmp$ = "2" or tmp$ = "3" chain "serp450trans.dl4"

!Print 'CS'
action1$=UCase$(RTrim$(action1$))
Mat Read #1,60,50;P60$;
L_500: !If P60$[24,24] <> "Y"
  !Print @0,5;"Would you like a  C: Commission report or  H: Chargeback report ( E: Exit )? ";
  !Input Len 16385;""X$
  !Call String(1,X$)
  !If X$ = "E" Goto OUTEND
  !If X$ = "H" Chain "MX450CB"
  !If X$ <> "C" Print 'RB'; \ Goto L_500
!End If 
L_600: !Print @0,6;"Sort by customer bill to and use all invoice with the "
!Print @0,7;"same salesman   invoice date for commission ";
!If P60$[24,24] <> "Y"
!  Print "(Y/N) ";
!Else 
!  Print "(Y/N/E) ";
!End If 
!Input Len 16385;""X$
!Call String(1,X$)
!If P60$[24,24] = "Y" And X$ = "E" Goto OUTEND
!If X$ = "Y" Chain "MX450C"
!If X$ <> "N" Print 'RB'; \ Goto L_600
For J = 2 To 7
	Read J1 \ If J1 = -1 Goto L_830
	Read #1,88,Abs(J1);J$;
	If J < 0 Ropen #J,J$ Else Open #J,J$
L_830: Next J
Data "2240","-1824","-1808","-1504","-1408","-1"
OPEN #7,"4/commaudit"+STR$(intco)
Read #1,3;COMP$;
Mat Read #1,0,100;J8$;
Mat Read #1,0,108;ARDATE;
Mat Read #1,0,120;ARMONTH;
Mat Read #1,19,50;P9$;
Mat Read #1,61,0;P61$;
CF$ = P60$[37,37]
ARDATE$ = ARDATE Using "&&&&&&"
CH_SLSMCOMM = 2
ch_commaudit = 7
! check screen print upon submit
SORTKEY = 0
returnstatus=1;message$="OK"
EPAYDATE = 591231;SPAYDATE = 700101
Gosub HIST_FIND
If action1$="GETLISTS" ! want's flags/droplists
	clear List$[]
	list$[0]=bsdel$,"SYSFLAG",fdel$
	List$[1]="ALLOWCH",fdel$ ! allow commission history prompts
	tmp$="N" \if havehist let tmp$="Y"
	List$[2]=tmp$,fdel$
	list$[3]=esdel$
	List$[4]=bsdel$,"PURGEFLAG",fdel$
	List$[5]="ID",fdel$,"DESC",fdel$
	List$[6]="1",fdel$,"1 - Paid Only",fdel$
	list$[7]="2",fdel$,"2 - All in Range",fdel$
	List$[8]="3",fdel$,"3 - Audit Version",fdel$
	List$[9]=esdel$
	call addtostr(e$,rstr$,list$[])
	clear list$[]
	list$[0]=bsdel$,"TOTONLY",fdel$
	list$[1]="ID",fdel$,"DESC",fdel$
	list$[2]="0",fdel$,"No",fdel$  ! standard
	list$[3]="1",fdel$,"Yes",fdel$ ! summary 
	i=4
	! if custom_customer$ = "AFP"
! 		list$[4]="2",fdel$,"AFP Summary",fdel$
! 		i=i+1
		list$[i]=str$(i-2),fdel$,"Full Transactional",fdel$
		i=i+1
		list$[i]=str$(i-2),fdel$,"Full Transactional + Invoice Detail",fdel$
		i=i+1
	! end if
	list$[i]=esdel$
	call addtostr(e$,rstr$,list$[])
	clear list$[]
	list$[0]=bsdel$,"Printers",fdel$
	List$[1]="Name",fdel$,"Id",fdel$,"Default",fdel$
	call AddToStr(e$,rstr$,List$[])
	pdfoption=1
	xmloption=1 ! BROWSER is OK  (We'll try and hope no timeout)
	if custom_customer$="ETNA" LET XMLOPTION=0 ! no browser for custom ETNA
	Call blockPrintersDropList(rstr$,xmloption,pdfoption)
	Call AddToStr(e$,rstr$,esdel$) ! end of section
	Call CreateNetStatus(e$,ReturnStatus,Message$,WebStr$)
	Call AddToStr(e$,rstr$,WebStr$)
	Call SetOutPut(e$,rstr$)
	goto outend
Endif
IF CUSTOM_CUSTOMER$="ETNA"
	LET CF$=""
	! open temp file
	LET I$=" ",I$
	LET I$="[1:6] 6/SLCOMTMP"+Str$(Spc(6))+"!"
	BUILD #30,I$
	LET R[30]=10 \ SEARCH #30,0,1;I$,R[30],E \ IF E GOSUB Err_Search:
	LET R[30]=1 \ SEARCH #30,0,0;I$,R[30],E \ IF E GOSUB Err_Search:
	READ #1,88,1536;J$;
	ROPEN #60,J$
ENDIF
SORTKEY = 0
L_1000: Rem "=================================== get ranges
! Gosub SCREENDISP
!Print 'CS';@0,0;"-MX450-";@25,0;"SALESMAN COMMISSION";@55,0;Msc$(3)
!Print @0,2;" 1> Enter AR month to print or <CR> for date range ";
!Print @0,3;" 2> Enter year ## to print ";'CE';
!Print @22,5;'BR';"STARTING";@36,5;"ENDING";'ER';
!Print @0,6;" 3> TRANSACTION DATE ";
!Print @0,7;" 4> SALESMAN ";
!Print @0,9;" 5> Print salesperson totals only? ";
!Print @0,10;" 6> Print cost & G/P on report? ";
!Print @0,11;" 7> 460 to purge:  (1/2/3) ";
!Print @0,12;"     1:  Paid Only "
!Print @0,13;"     2:  All in Range "
!Print @0,14;"     3:  Audit Version (will not flag any to be purged) "
!If HAVEHIST Print @0,17;" 8> Use  C: current or  H: historical slsm commission records? "
ARCODE = 0
YEAR_ = 0
N3 = 0
N4 = 999
SUMM = 0
PRTCOST = 0
!Goto EDT_ALL
!Goto INPUTS
INPUTS: Rem
!Print @0,23;'CE';"Enter #:field to edit  R: reselect all  P: print  E: exit ";
!Input Len 16384 + 3;""X$ \ Call String(1,X$)
!Print @0,23;'CE';
!If X$ = "P" Goto MAIN
!If X$ = "E" Let J8 = 0 \ Goto OUTEND
!If X$ = "R" Goto EDT_ALL
!If X$ = "" Goto INPUTS
!X = X$
!If HAVEHIST Let MAXFIELD = 8 Else Let MAXFIELD = 7
!If X < 1 Or X > MAXFIELD Goto INPUTS
!Gosub EDTFIELD
!Goto INPUTS
!EDT_ALL: Rem
!For X = 1 To 7
!  If Not(ARCODE) If X = 2 Let X = 4
!  If ARCODE If X = 3 Or X = 2 Let X = 4
!  Gosub EDTFIELD
!Next X
!If HAVEHIST Gosub HIST_QUEST
!Goto INPUTS
EDTFIELD: Rem
!If Spc(13) = 11 Print @0,0;"\177\UWHOTSPOT.\\HOTSPOT\\HOTSPOTDIS.hsf\177\";
!On X Gosub EDARCODE,EDYEAR,EDDATE,EDSLSM,EDTOTALS,EDCOST,EDPURGE,HIST_QUEST
!If Spc(13) = 11 Print @0,0;"\177\UWHOTSPOT.\\HOTSPOT\\HOTSPOTIN.hsf\177\";
!Return 
SCREENDISP: Rem --display prompts on screen

!Return 
EDARCODE: Rem
J1$ = ARCODE \ J0$ = "2   025102"
J5$ = "Enter A/R Month "
! Gosub L7000 \ K2$ = J4$
call dxget("ARMONTH",tmp$)
K2$=RTrim$(tmp$) ! Call String(1,K2$)
If K2$ = ""
  !Print @51,2;'CL';
  ARCODE = 0
  !Print @28,3;'CL';
  Goto Eddate !Gosub EDDATE
  !Return 
End If 
ARCODE = K2$ ! \ 
If ARCODE < 1 Or ARCODE > 12 ! Goto EDARCODE
	returnstatus=0
	e$="Invalid Month Number"
	goto ERR_MSG
Endif
!If ARCODE
  ! Print @22,6;'CL';
!  Gosub EDYEAR
!End If 
!Return 
EDYEAR: Rem
If Not(ARCODE) goto eddate ! Return 
J1$ = YEAR_ \ J0$ = "2   022803"
J5$ = "Enter Year (YY)"
!Gosub L7000 \ K2$ = J4$
call dxget("ARYEAR",tmp$)
tmp$=Trim$(tmp$)
if len(tmp$)>2 ! sent 4 digit?
	K2$=tmp$[3,4] ! just last 2
Else
	k2$=RTrim$(tmp$)
Endif
!Call String(1,K2$)
YEAR_ = K2$
!If ARCODE
  !Print @28,3;K2$;
!Else 
!  Print @28,3;'CL';
!End If 
!Return 
EDDATE: Rem
if ARCode goto EdSlsm ! one or the other
If STARTDATE = 0 Let STARTDATE = 700101
J1 = STARTDATE
J5$ = "Enter Starting Transaction Date (MMDDYY)  "
J0$ = "5 00082206"
!Gosub L7000 \ X2 = 0
call dxget("STARTDATE",tmp$)
if len(tmp$)>10
	tmp1$=chkDteFrmt$(E$,tmp$[1,10])
else 
	tmp1$=chkDteFrmt$(E$,tmp$)
endif
if tmp1$[1,1]<"0" and tmp1$[1,1]>"9" let tmp1$=""
if tmp1$<>""
	tmp$=formatdate2$(tmp1$) ! mm/dd/yyyy to yyyymmdd
  Else
	tmp$="19"+StartDate using "&&&&&&"
Endif
J1=tmp$[3,10]
If J1 Let X2 = J1 \ Gosub L_7820 \ X2=-1 ! Goto EDDATE
if x2<=0
	returnstatus=0
	e$="Invalid Start Date"
	goto err_msg
Endif
STARTDATE = J1;JDATE[0] = X2
EDENDDATE: Rem "Ending
J0$ = "5 00083606"
J5$ = "Enter Ending Transaction Date (MMDDYY)   "
If ENDDATE = 0 Let ENDDATE = 591231
J1 = ENDDATE
!Gosub L7000
call dxget("ENDDATE",tmp$)
if len(tmp$)>10
	tmp1$=chkDteFrmt$(E$,tmp$[1,10])
else 
	tmp1$=chkDteFrmt$(E$,tmp$)
endif
if tmp1$[1,1]<"0" and tmp1$[1,1]>"9" let tmp1$=""
if tmp1$<>""
	tmp$=formatdate2$(tmp1$) ! mm/dd/yyyy to yyyymmdd
Else
	tmp$="20"+EndDate using "&&&&&&"
Endif
J1=tmp$[3,10]
X2 = J1 \ Gosub L_7820 \ X2=-1 ! Goto EDENDDATE
if x2<=0
	returnstatus=0
	e$="Invalid End Date"
	goto err_msg
Endif
ENDDATE = J1;JDATE[1] = X2
If JDATE[0] > JDATE[1]
  ! J7$ = "INVALID RANGE" \ Gosub L_7600 \ Goto EDDATE
  E$="Invalid Date Range"
  goto err_msg
End If 
!Return 
EDSLSM: Rem ***** INPUT SALESMAN RANGE == BWB == 4/9/87
J1$ = N3 Using "###" \ J0$ = "1 00032207"
J5$ = "Enter the starting salesman code maximum 999"
!Gosub L7000 \ K2$ = J$
call dxget("STSLSM",tmp$) \ if tmp$="" let tmp$=Str$(N3)
k2$=tmp$
N3 = K2$
J1$ = N4 Using "###" \ J0$ = "1 00033607"
J5$ = "Enter the ending salesman code maximum 999 "
!Gosub L7000 \ K3$ = J$
call dxget("ENDSLSM",tmp$) \ if tmp$="" let tmp$=Str$(N4)
K3$=tmp$
N4 = K3$
If N3 <= N4 Goto SLSMDONE
!J7$ = "INVALID RANGE" \ Gosub L_7600 \ Goto EDSLSM
e$="Invalid Salesperson Range"
goto err_msg
SLSMDONE: Rem
!Return 
EDTOTALS: Rem SLSM TOTALS ONLY?
J1 = SUMM \ J0$ = "6   014009"
J5$ = "Enter Y or N "
!Gosub L7000
call dxget("TOTONLY",tmp$)
summ = tmp$
! j1=0 \ if UCase$(tmp$)="Y" let j1=1
! SUMM = 0 \ If J1 Let SUMM = 1
!Return 
EDCOST: Rem PRINT COST & G/P
J1 = PRTCOST \ J0$ = "6   014010"
J5$ = "Enter Y or N"
!Gosub L7000
call dxget("COSTGP",tmp$)
j1=0 \ if ucase$(tmp$)="Y" let j1=1
PRTCOST = 0 \ If J1 Let PRTCOST = 1
! Return 
EDPURGE: Rem  paid only , all , or audit version ?
PRT_PAIDONLY = 0
UNMARK_PURGE = 0
!Print @27,11;'CL';@116;'CL';
!Print @0,15;'CL';
!Input @27,11;""Z1$
call dxget("PRGTYPE",tmp$)
z1$=tmp$
If Z1$ <> "1" And Z1$ <> "2" And Z1$ <> "3" ! Goto EDPURGE
	returnstatus=0
	e$="Please select 1 2 or 3"
	goto err_msg
Endif
PURGEFLAG = Z1$
!If PURGEFLAG <> 3
!  Print @5,20;'ER BR';" RANGES ENTERED ABOVE WILL BE PURGED WHEN 460 IS RUN ";'ER'
!  Print @0,18;'CL';
!End If 
If PURGEFLAG = 1 or PURGEFLAG = 3
	!Print @0,15;"     Print only the paid invoices? ";
	J1 = PRT_PAIDONLY \ J0$ = "6   015315"
	J5$ = "Enter Y or N "
	!Gosub L7000
	call dxget("PAIDONLY",tmp$)
	j1=0 \ if UCase$(tmp$)="Y" let j1=1
	PRT_PAIDONLY = 0 \ If J1 Let PRT_PAIDONLY = 1
	IF CUSTOM_CUSTOMER$="ETNA" and PRT_PAIDONLY<>1
		 E$="Must Select Print Only Paid Invoices"
		goto err_msg
	ENDIF
	If PRT_PAIDONLY = 1
		!Print @0,16;"    Payment Date";'CL';
		PAYDATE: Rem
		If Not(SPAYDATE) Let SPAYDATE = 700101
		J1 = SPAYDATE
		J5$ = "Enter Starting Payment Date (MMDDYY)  "
		J0$ = "5 00082216"
		!Gosub L7000 \ X2 = 0
		call dxget("STPAYDATE",tmp$)
		if len(tmp$)>10
			tmp1$=chkDteFrmt$(E$,tmp$[1,10])
		else 
			tmp1$=chkDteFrmt$(E$,tmp$)
		endif
		if tmp1$[1,1]<"0" and tmp1$[1,1]>"9" let tmp1$=""
		if tmp1$<>""
			tmp$=formatdate2$(tmp1$) ! mm/dd/yyyy to yyyymmdd
		Else
			tmp$="19"+SPAYDATE using "&&&&&&"
		Endif
		J1=tmp$[3,10]
		If J1 Let X2 = J1 \ Gosub L_7820 \ X2=-1 ! Goto PAYDATE
		if x2<=0
			e$="Invalid Start Payment Date"
			goto err_msg
		Endif
		SPAYDATE = J1;JSPAYDATE = X2
		ENDPAYDATE: Rem "Ending payment date
		J0$ = "5 00083616"
		J5$ = "Enter Ending Payment Date (MMDDYY)   "
		If EPAYDATE = 0 Let EPAYDATE = ARDATE
		J1 = EPAYDATE
		!Gosub L7000
		call dxget("ENDPAYDATE",tmp$)
		if len(tmp$)>10
			tmp1$=chkDteFrmt$(E$,tmp$[1,10])
		else 
			tmp1$=chkDteFrmt$(E$,tmp$)
		endif
		if tmp1$[1,1]<"0" and tmp1$[1,1]>"9" let tmp1$=""
		if tmp1$<>""
			tmp$=formatdate2$(tmp1$) ! mm/dd/yyyy to yyyymmdd
		Else
			tmp$="20"+EPAYDATE using "&&&&&&"
		Endif
		J1=tmp$[3,10]
		X2 = J1 \ Gosub L_7820 \ X2=-1 ! Goto ENDPAYDATE
		if x2<=0
			e$="Invalid End Payment Date"
			goto err_msg
		Endif
		EPAYDATE = J1;JEPAYDATE = X2
		If JEPAYDATE < JSPAYDATE
			!J7$ = "INVALID RANGE" \ Gosub L_7600 \ Goto PAYDATE
			e$="Invalid Payment Date Range"
			goto err_msg
		End If
	End If
Else
	!Print @0,15;'CL';
	!Print @0,16;'CL';
	!If PURGEFLAG = 3 Print @0,20;'CL';
End If !"purgeflag =1
!Return 
HIST_QUEST: Rem
UNMARK_PURGE = 0
!If HIST = 1 Print @63,17;"H"; Else Print @63,17;"C";
J5$ = "Enter  C: current or  H: historical slsm commission records"
J0$ = "2 00016317"
!If HIST Let J1$ = "H" Else Let J1$ = "C"
!Gosub L7000
if havehist ! only ask if it's there
	call dxget("CHCOMM",tmp$)
	tmp$=UCase$(RTrim$(tmp$))
Else
	tmp$="C"
Endif
J$=tmp$
If J$ <> "H" And J$ <> "C" ! Goto HIST_QUEST
	e$="Please select C or H"
	goto err_msg
Endif
HIST = 0 \ If J$ = "H" Let HIST = 1
If J$ = "H"
	HIST = 1
	Close #CH_SLSMCOMM
	close #ch_commaudit
	SCRATCH$ = Str$(IntCo) ! Str$(Int((Spc(5) - Int(Spc(5) / 16384) * 16384) / 64))
	Open #CH_SLSMCOMM,"4/SSLSMCOMMH" + SCRATCH$
	open #ch_commaudit,"4/commaudith" + scratch$
Else
	HIST = 0
End If 
If Not(HIST) And PURGEFLAG = 3
	!Print @0,18;"     Unmark items that are marked for purging? ";
	J1 = UNMARK_PURGE \ J0$ = "6   015318"
	J5$ = "Enter Y or N "
	!Gosub L7000
	call dxget("UMKPRG",tmp$)
	J1=0 \ if tmp$="Y" let j1=1
	UNMARK_PURGE = 0 \ If J1 Let UNMARK_PURGE = 1
	!Else
	!  Print @0,18;'CL';
End If
!If HIST Print @0,20;'CL';
! Return 
call dxget("Printer",tmp$) ! let's see if 1 selected (-- = NONE)
tmp$=rtrim$(tmp$)
if tmp$[1,2]="--"
	Returnstatus=0
	e$="NO PRINTER SELECTED"
	goto ERR_MSG ! Done
Endif
onchannelno=0 ! zero for channel
printchan = openprinter(e$,onchannelno)
Toscreen=0
if printchan=-1 let Toscreen=1 ! to browser
!if toscreen ! UNREM TO NOT ALLOW XML
!	Returnstatus=0
!	e$="NO Browser Print"
!	goto ERR_MSG ! Done
!Endif
let SCREENPRINT=toscreen
! Call dxsave(0,"tmp/450in.txt!") ! save web data sent
X2=BuildSort(e$,20,0,9) ! build a sortwork on chan#9, keysize=20w/40C
MAIN: Rem

MAXLINES = 59 ! \ If SCREENPRINT Let MAXLINES = 20
LN = 99
if screenprint ! xml 
	!<section>
	tmp$ = bsdel$,"450",fdel$,rdel$
	call addtostr(e$,rstr$,tmp$)
	! set headings
	if summ ! slsm /grand totals only
		tmp$="SLSM",FDEL$,"NAME",FDEL$
	Else ! slsm/cust/detail/grand
		tmp$="SLSM",FDEL$,"NAME",FDEL$
		tmp$=tmp$,"CUST",fdel$,"CUSTNAME",fdel$
		tmp$=tmp$,"INV/CM",fdel$,"DATE",fdel$
	Endif ! rest is standard
	If PRTCOST
		tmp$=tmp$,"GP%",fdel$,"COST",fdel$,"PROFIT",fdel$
	Endif
	if not(arcode) tmp$=tmp$,"PRV MNTH",fdel$
	tmp$=tmp$,"SALES",fdel$,"PAID",fdel$,"COMMISSION",fdel$
	If PURGEFLAG = 1 And SUMM = 0 And PRT_PAIDONLY = 1
		tmp$=tmp$,"PAID DATE",fdel$
	Else
	  If custom_customer$<>"HTBERRY"
		tmp$=tmp$,"DUE",fdel$
	  Else
		tmp$=tmp$,"PRCT",fdel$
	  Endif
	Endif
	If PURGEFLAG = 3 let tmp$=tmp$,"UNMRKD",fdel$
	tmp$=tmp$,rdel$
	call addtostr(e$,rstr$,tmp$)
Else ! normal print - send in process
! 	Call CreateNetStatus(e$,1,"Report In Process...",WebStr$)
! 	Call AddToStr(e$,rstr$,WebStr$)
! 	call setoutput(e$,rstr$)
	 Call setoutput(e$,rstr$,2) !2 flag puts 0 status section in w/print in process msg, puts </page> in
Endif
If Err 0 Gosub ERR_TRAP
iF CUSTOM_CUSTOMER$="ETNA"
	FOR CTR=0 TO 10
		LET ET8[CTR]=0;ET9[CTR]=0;ET10[CTR]=0
	NEXT CTR
ENDIF
Gosub SORTCOMMFILE
IF CUSTOM_CUSTOMER$="ETNA"
	GOSUB L_8100:
endif
If Not(SUMM)
  Gosub CLEAR_SORT
End If 

! Print @0,22;"Printing...please wait";'CE'; \ Signal 3,0
COUNT = 0
! If SCREENPRINT Print 'CS';
K1$ = N3 Using "###"
L_2000: Search #9,3,1;K1$,R1,E \ If E > 2 Gosub ERR_SEARCH
If E Goto L_9100
Mat Read #2,R1,0;S1;
Mat Read #2,R1,16;S2;
Mat Read #2,R1,28;S3;
Mat Read #2,R1,36;S4;
Mat Read #2,R1,40;S6;
Mat Read #2,R1,54;S7;
!if custom_customer$="HTBERRY"
	MAT  READ #2,R1,100;commsrvchg;
!Endif
MAT  READ #2,R1,112;ocs1;
COUNT = COUNT + 1
! If Fra(COUNT / 100) = 0 Print @30,22;COUNT Using "###,###";
If ARCODE If S4[0] <> ARCODE Goto L_2000
X2 = S1[3] \ Gosub L_7820 \ X2 = 0
JWDATE = X2
If Not(ARCODE) If JWDATE < JDATE[0] Goto L_2000
If Not(ARCODE) If JWDATE > JDATE[1] Goto L_2000
If S1[0] < N3 Goto L_2000
If S1[0] > N4 Goto L_9100
If S8 
	If S8 <> S1 
		if line_print_flag 
			Gosub L_4500
		else
			line_print_flag = 0
		endif
	endif
endif
If S10 If S10 <> S3[1] Gosub L_4600
If Not(S8) Gosub L_3000
If Not(S10) Gosub L_3200
X5 = K1$[20,21]
Gosub L_3400
Rem CHECKING A/R WILL DETERMINE IF "PAID"(INCL DATE RANGE&MERCH AMT)
if custom_customer$<>"ETNA"
	If PRT_PAIDONLY = 1
		If ARPAID = 0 Goto L_2000
	End If 
endif
multiplier = 1
If X5 < 6 or X5 = 8 Goto L_2150
multiplier = -1
S6 = 0 - S6
IF CUSTOM_CUSTOMER$="ETNA"
	PAYPREV=-PAYPREV;PAYCURR=-PAYCURR;COMMDUE=-COMMDUE
ENDIF
T9 = 0 - T9
S2 = 0 - S2 \ S2[1] = 0 - S2[1]
L_2150: Rem
!if custom_customer$="HTBERRY"
	adj_gp_dollars=s2[0]-s6[0]
	adj_dollars=s2[0]-(s2[0]*(commsrvchg/100))
	if p61$[79,79]="Y"
		adj_gp_dollars=s2[0]-s6[0]-(s2[0]*(commsrvchg/100))
	end if
!Endif
If SUMM Goto L_2165
if custom_customer$<>"ETNA"
	If X5 < 6 If PURGEFLAG = 1 If PRT_PAIDONLY If Not(ARPAID) Goto L_2000
endif
Gosub L_5800
L_2165: If HEADING Gosub L_5300 \ Gosub L_5200
Gosub L_5000
if NOT(SUMM) GOSUB PrintAuditTrans:
If Not(HIST) If PURGEFLAG = 3 If UNMARK_PURGE !"cct158507
  If S4[1] Let S4[1] = 0
  Mat Write #CH_SLSMCOMM,R1,36;S4;
End If 
Gosub L_2200
Goto L_2000
L_2200: Rem TOTALS CALC
IF CUSTOM_CUSTOMER$="ETNA"
	LET ET8[0]=ET8[0]+S6[0]\ ET9[0]=ET9[0]+S6[0]\ET10[0]=ET10[0]+S6[0] ! COST
	LET ET8[1]=ET8[1]+S2[0]\ ET9[1]=ET9[1]+S2[0]\ET10[1]=ET10[1]+S2[0] ! SALE AMOUNT	
	LET ET8[2]=ET8[2]+PAYPREV\ET9[2]=ET9[2]+PAYPREV\ET10[2]=ET10[2]+PAYPREV! PAID PREVIOUS
	LET ET8[3]=ET8[3]+S2[1]\ ET9[3]=ET9[3]+S2[1]\ET10[3]=ET10[3]+S2[1] ! COMMISSION
	LET ET8[4]=ET8[4]+PAYCURR\ET9[4]=ET9[4]+PAYCURR\ET10[4]=ET10[4]+PAYCURR! PAID CURRENT
	LET ET8[5]=ET8[5]+COMMDUE\ET9[5]=ET9[5]+COMMDUE\ET10[5]=ET10[5]+COMMDUE! COMMISSION DUE
ENDIF
If ARCODE
  T9[5] = T9[5] + S2[0] \ T8[5] = T8[5] + S2[0] \ T10[5] = T10[5] + S2[0]
  if custom_customer$="HTBERRY"
	LET T9[9]=T9[9]+adj_gp_dollars
	LET T8[9]=T8[9]+adj_gp_dollars
	LET T10[9]=T10[9]+adj_gp_dollars
	LET T9[10]=T9[10]+adj_dollars
	LET T8[10]=T8[10]+adj_dollars
	LET T10[10]=T10[10]+adj_dollars
  Endif
	if custom_customer$="ETNA"	
		LET T9[6]=T9[6]+PAYPREV \ LET T8[6]=T8[6]+PAYPREV \ LET T10[6]=T10[6]+PAYPREV
		LET T9[8]=T9[8]+COMMDUE;T8[8]=T8[8]+COMMDUE;T10[8]=T10[8]+COMMDUE
		LET T9[3]=T9[3]+PAYCURR;T8[3]=T8[3]+PAYCURR;T10[3]=T10[3]+PAYCURR
	endif
Else 
  If ARMONTH <> S4[0] ! not right month
    PT9[5] = PT9[5] + S2[0]
    PT8[5] = PT8[5] + S2[0]
    PT10[5] = PT10[5] + S2[0]
	if custom_customer$="HTBERRY"
		LET PT9[6]=PT9[6]+adj_gp_dollars
		LET PT8[6]=PT8[6]+adj_gp_dollars
		LET PT10[6]=PT10[6]+adj_gp_dollars
		LET PT9[7]=PT9[7]+adj_dollars
		LET PT8[7]=PT8[7]+adj_dollars
		LET PT10[7]=PT10[7]+adj_dollars
	Endif
	if custom_customer$="ETNA"	
			LET PT9[6]=PT9[6]+PAYPREV \ LET PT8[6]=PT8[6]+PAYPREV \ LET PT10[6]=PT10[6]+PAYPREV
			LET PT9[8]=PT9[8]+COMMDUE;PT8[8]=PT8[8]+COMMDUE;PT10[8]=PT10[8]+COMMDUE
			LET PT9[3]=PT9[3]+PAYCURR;PT8[3]=PT8[3]+PAYCURR;PT10[3]=PT10[3]+PAYCURR
	endif
  Else 
    TEMP$ = S1[3] Using "&&&&&&"
    If ARDATE$[1,2] = TEMP$[1,2] ! is the year the same?
      T9[5] = T9[5] + S2[0]
      T8[5] = T8[5] + S2[0]
      T10[5] = T10[5] + S2[0]
	  if custom_customer$="HTBERRY"
		LET T9[9]=T9[9]+adj_gp_dollars
			LET T8[9]=T8[9]+adj_gp_dollars
			LET T10[9]=T10[9]+adj_gp_dollars
			LET T9[10]=T9[10]+adj_dollars
			LET T8[10]=T8[10]+adj_dollars
			LET T10[10]=T10[10]+adj_dollars
	  Endif
	  if custom_customer$="ETNA"	
				LET T9[6]=T9[6]+PAYPREV \ LET T8[6]=T8[6]+PAYPREV \ LET T10[6]=T10[6]+PAYPREV
				LET T9[8]=T9[8]+COMMDUE;T8[8]=T8[8]+COMMDUE;T10[8]=T10[8]+COMMDUE
				LET T9[3]=T9[3]+PAYCURR;T8[3]=T8[3]+PAYCURR;T10[3]=T10[3]+PAYCURR
	  endif
    Else 
      PT9[5] = PT9[5] + S2[0]
      PT8[5] = PT8[5] + S2[0]
      PT10[5] = PT10[5] + S2[0]
	  if custom_customer$="HTBERRY"
		LET PT9[6]=PT9[6]+adj_gp_dollars
			LET PT8[6]=PT8[6]+adj_gp_dollars
			LET PT10[6]=PT10[6]+adj_gp_dollars
			LET PT9[7]=PT9[7]+adj_dollars
			LET PT8[7]=PT8[7]+adj_dollars
			LET PT10[7]=PT10[7]+adj_dollars
	  Endif
	  if custom_customer$="ETNA"	
				LET PT9[6]=PT9[6]+PAYPREV \ LET PT8[6]=PT8[6]+PAYPREV \ LET PT10[6]=PT10[6]+PAYPREV
				LET PT9[8]=PT9[8]+COMMDUE;PT8[8]=PT8[8]+COMMDUE;PT10[8]=PT10[8]+COMMDUE
				LET PT9[3]=PT9[3]+PAYCURR;PT8[3]=PT8[3]+PAYCURR;PT10[3]=PT10[3]+PAYCURR
	  endif
    End If 
  End If 
End If 
T6[0] = T6[0] + S6[0] \ T5[0] = T5[0] + S6[0] \ T7[0] = T7[0] + S6[0]
IF CUSTOM_CUSTOMER$<>"ETNA"
	T9[6] = T9[6] + T9 \ T8[6] = T8[6] + T9 \ T10[6] = T10[6] + T9
endif
T9[7] = T9[7] + S2[1] \ T8[7] = T8[7] + S2[1] \ T10[7] = T10[7] + S2[1]
If CF$ = "C"
  If X5 < 6
    If Abs(T9) >= Abs(S2) Or ARPAID !this is for invoices
      T9[8] = T9[8] + S2[1];T8[8] = T8[8] + S2[1];T10[8] = T10[8] + S2[1]
    End If 
  Else ! this is for credits / others , no need to check applied amount
    T9[8] = T9[8] + S2[1];T8[8] = T8[8] + S2[1];T10[8] = T10[8] + S2[1]
  End If 
End If 
If CF$ = "A"
  If Abs(T9) >= Abs(S2) Or ARPAID
    T9[8] = T9[8] + S2[1];T8[8] = T8[8] + S2[1];T10[8] = T10[8] + S2[1]
  End If 
End If 
If PURGEFLAG = 1
  If CF$ = "C"
    If X5 < 6
      If Abs(T9) >= Abs(S2) Or ARPAID Let S4[1] = 1 Else Let S4[1] = 0
    Else 
      S4[1] = 1
    End If 
  End If 
  If CF$ = "A"
    If Abs(T9) >= Abs(S2) Or ARPAID Let S4[1] = 1 Else Let S4[1] = 0
  End If 
Else 
  If PURGEFLAG = 2 Let S4[1] = 1
End If 
Mat Write #2,R1,36;S4;
Return 
L_3000: Rem GET SLSM NAME
If S8 = S1 Return 
J2$ = " ",J2$ \ J2$ = S1 Using "###"
Search #3,2,1;J2$,R3,E
If E = 1 Let S1$ = "** ERROR ** SALESMAN NOT FOUND" \ Goto L_3050
If E Gosub ERR_SEARCH
Mat Read #3,R3;S1$;
L_3050: Return 
L_3200: Rem GET CUSTOMER
For X = 0 To 12 \ C1[X] = 0 \ Next X
If S3[1] = S10 Return 
J3$ = " ",J3$ \ J3$ = S3[1] Using "######"
Search #4,2,1;J3$,R4,E
If E = 1
	Let C1$ = "**CUSTOMER NOT FOUND"
	if not(s3[1]) let c1$ = "** NON-CUSTOMER SPECIFIC"
	Goto L_3240
END IF
If E Gosub ERR_SEARCH
Mat Read #4,R4,30;C1$;
Mat Read #4,R4,142;C1;
L_3240: Rem
Return 
L_3400: Rem GET A/R RECORD
LET PAYPREV=0;PAYCURR=0;COMMDUE=0
ARPAID = 0
if x5 = 8 or x5 = 9
	! non invoice based transaction - good to go
	let ARPAID = 1
	return
end if
J4$ = " ",J4$ \ J4$ = S3[1] Using "######"
If S7 Let J4$[7] = S7 Using "##########" Else Let J4$[7] = S7[1] Using "##########"
J4$[17] = K1$[20];J4$[18] = ""
If custom_customer$="ETNA"
	LET J4$=" ",J4$ \ LET J4$=S3[1] USING "######"
	LET J4$[7]=k1$[10]! ;J4$[18]="" ! "type
	IF S7[0]<>0 LET J4$[7,16]=S7[0] USING "##########" 
endif
Search #5,2,1;J4$,R5,E
If E Goto L_3500
Mat Read #5,R5;A2;
Mat Read #5,R5,24;A3;
IF CUSTOM_CUSTOMER$="ETNA"
	mat read #5,r5,124;sa0;
	IF SA0[5]=2 ! division 2 get no commission
		LET S2[1]=0;COMMDUE=0
	ENDIF 
	LET TOTPAID=0
	SEARCH #30,2,1;J4$,R[30],E \ IF E GOSUB Err_Search:
	MAT  READ #30,R[30],0;TOTPAID;
	LET PAYPREV=A3[1];PAYCURR=A3[2]
	LET PAYCURR=TOTPAID
	LET T1=INT(FRA(A2[3])*100)
	IF NOT(A3[0]-A3[1]-A3[2]) LET S4[1]=1 ! flagged as paid
	IF PAYPREV>=A3[5]
		LET S4[1]=1;COMMDUE=0
		GOTO L_3540:
	ENDIF 
	LET AVAILMERCH=A3[5]-PAYPREV
	IF AVAILMERCH<=0
		LET S4[1]=1;COMMDUE=0
		GOTO L_3540:
	ENDIF 
	IF AVAILMERCH>PAYCURR LET AVAILMERCH=PAYCURR
	LET COMMDUE=FNR(S2[1]*(AVAILMERCH/A3[5]))
	IF A3[5]<=(A3[1]+A3[2]) LET S4[1]=1
	L_3540: MAT  READ #5,R5,330;ARCOMM
	LET ARCOMM[1]=COMMDUE
	MAT  WRITE #5,R5,330;ARCOMM;
	RETURN 
ENDIF
T9 = A3[1] + A3[2]
T1 = Int(Fra(A2[3]) * 100)
Rem IF NOT PAID IN FULL, BUT MERCH AMOUNT PAID- WE CALL IT "PAID"
Rem ************************************
Rem NOTE: IF THE CUSTOMER DOES NOT WANT THIS CONDITION, THEN
Rem CHANGING IT IS SIMPLE, JUST REM OUT THIS SECTION.- WMB 12/2008
If Abs(A3[0] - T9) <> 0 And Abs(T9) >= Abs(S2)
  If Not(PRT_PAIDONLY)
    ARPAID = 1
  Else 
    If Not(A2[1])
      ARPAID = 1
    Else 
      X2 = A2[1] \ Gosub L_7820 \ Goto BADARPAYDATE
      JARPAYDATE = X2
      If JARPAYDATE >= JSPAYDATE And JARPAYDATE <= JEPAYDATE
        ARPAID = 1
      End If 
    End If 
  End If 
End If 
Rem ************************************
If Abs(A3[0] - T9) = 0
  If Not(PRT_PAIDONLY)
    ARPAID = 1
  Else 
    If Not(A2[1])
      ARPAID = 1
    Else 
      X2 = A2[1] \ Gosub L_7820 \ Goto BADARPAYDATE
      JARPAYDATE = X2
      If JARPAYDATE >= JSPAYDATE And JARPAYDATE <= JEPAYDATE
        ARPAID = 1
      End If 
    End If 
  End If 
End If 
Return 
L_3500: Rem NOT FOUND SO MUST BE PAID
IF CUSTOM_CUSTOMER$="ETNA"
	LET PAYPREV=S2[0];COMMDUE=0;S4[1]=1
	RETURN 
ENDIF
Search #6,2,1;J4$,R6,E \ If E > 1 Gosub ERR_SEARCH
If Not(E)
  Mat Read #6,R6;A2;
Else 
  A2[1] = 0
End If 
T9 = S2[0]
If PRT_PAIDONLY = 0
  ARPAID = 1
Else 
  If Not(A2[1])
    ARPAID = 1
  Else 
    X2 = A2[1] \ Gosub L_7820 \ Goto BADARPAYDATE
    JARPAYDATE = X2
    If JARPAYDATE >= JSPAYDATE And JARPAYDATE <= JEPAYDATE
      ARPAID = 1
    End If 
  End If 
End If 
Return 
BADARPAYDATE: Rem bad date convert from julian
ARPAID = 1
Return 

L_4000: Rem TOTAL PRINT
iF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA4000:
	if screenprint ! xml
		if summ
			tmp$=fdel$,"REPORT TOTALS",fdel$ ! skip slsm#
		Else
			tmp$=fdel$,"REPORT TOTALS",fdel$
			tmp$=tmp$,fdel$,fdel$ ! no cust/name
			tmp$=tmp$,fdel$,fdel$ ! no inv / date
		Endif ! rest is standard
		If PRTCOST
			! tmp$=tmp$,"GP%",fdel$,"COST",fdel$,"PROFIT",fdel$
			x3=0
			if custom_customer$<>"HTBERRY"
			if (PT9[5]+t9[5]) let x3=FNW((PT9[5] + T9[5] - T5[0]) / (PT9[5] + T9[5]) * 100)
			Else
			IF (PT9[7]+T9[10]) let x3=int(((PT9[6]+T9[9])/(PT9[7]+T9[10]))*100)
			Endif
			tmp$=tmp$,LTrim$(X3 Using "-----#%"),fdel$
			tmp$=tmp$,LTrim$(T5[0] Using "----------#.##"),fdel$
			tmp$=tmp$,LTrim$(PT9[5] + T9[5] - T5[0] Using "---------#.##"),fdel$
		Endif
		if not(ARCODE)
			tmp$=tmp$,LTrim$(PT9[5] Using "---------#.##"),fdel$
		Endif
		tmp$=tmp$,LTrim$(T9[5] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T9[6] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T9[7] using "---------#.##"),fdel$
		If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
		  if custom_customer$<>"HTBERRY"
			tmp$=tmp$,LTrim$(T9[8] Using "---------#.##"),fdel$
		  Else
			tmp$=tmp$,fdel$
		  Endif
		Else
			tmp$=tmp$,fdel$
		End If
		If PURGEFLAG = 3 let tmp$=tmp$,fdel$
		tmp$=tmp$,rdel$
		call addtostr(e$,rstr$,tmp$)
		return ! that's all folks
	Endif
	Gosub L_5800
	if custom_customer$="HTBERRY" print #0;""
	Print #0;"** TOTALS **";
	If Not(PRTCOST) Goto L_4055
	if custom_customer$<>"HTBERRY"
	If (PT9[5] + T9[5]) Print #0; Using "---#%"; Tab 44;FNW((PT9[5] + T9[5] - T5[0]) / (PT9[5] + T9[5]) * 100);
	Else
	IF (PT9[7]+T9[10]) PRINT #0; USING "---#%"; TAB 44;int(((PT9[6]+T9[9])/(PT9[7]+T9[10]))*100);
	Endif
	!! Print #0; Using "--------#.##"; Tab 49;T5[0];
	Print #0; Using "--------#.##"; Tab 61;PT9[5] + T9[5] - T5[0];
	L_4055: !! If Not(ARCODE) Print #0; Using "-------#.##"; Tab 74;PT9[5];
	Print #0; Using "--------#.##"; Tab 85;T9[5];
	!! Print #0; Using "-------#.##"; Tab 98;T9[6];
	Print #0; Using "--------#.##"; Tab 109;T9[7];
	!! If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
	!! If custom_customer$<>"HTBERRY"
	!! Print #0; Using "------#.##"; Tab 122;T9[8];
	!! Else
	!! Rem ! doesn't print the above
	 !! Endif
	!! End If
	Print #0;""
	
	If Not(PRTCOST) Goto L_4056
	Print #0; Using "-----------#.##"; Tab 46;T5[0];
	L_4056: If Not(ARCODE) Print #0; Using "----------#.##"; Tab 71;PT9[5];
	Print #0; Using "----------#.##"; Tab 95;T9[6];
	If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
	  If custom_customer$<>"HTBERRY"
		Print #0; Using "---------#.##"; Tab 119;T9[8];
	  Else
		Rem ! doesn't print the above
	  Endif
	End If
        Print #0;""
        Print #0;""
Return

L_4500: Rem SALESMAN TOTAL
IF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA4500:
	if s10 Gosub L_4600
	Gosub L_5800
	if screenprint ! xml
		if summ
			tmp$=Str$(S8),fdel$,S1$[1,15]," TOTALS",fdel$ !
		Else
			tmp$=Str$(s8),fdel$,S1$[1,15]," TOTALS",fdel$
			tmp$=tmp$,fdel$,fdel$ ! no cust/name
			tmp$=tmp$,fdel$,fdel$ ! no inv / date
		Endif ! rest is standard
		If PRTCOST
			x3=0
			if custom_customer$<>"HTBERRY"
			if (PT8[5] + T8[5]) let x3=FNW((PT8[5] + T8[5] - T6[0]) / (PT8[5] + T8[5]) * 100)
			Else
			IF (PT8[7]+T8[10]) let x3=int(((PT8[6]+T8[9])/(PT8[7]+T8[10]))*100)
			Endif
			tmp$=tmp$,LTrim$(X3 Using "-----#%"),fdel$
			tmp$=tmp$,LTrim$(T6[0] Using "---------#.##"),fdel$
			tmp$=tmp$,LTrim$(PT8[5] + T8[5] - T6[0] Using "---------#.##"),fdel$
		Endif
		if not(ARCODE)
			tmp$=tmp$,LTrim$(PT8[5] Using "---------#.##"),fdel$
		Endif
		tmp$=tmp$,LTrim$(T8[5] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T8[6] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T8[7] using "---------#.##"),fdel$
		If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
		  If custom_customer$<>"HTBERRY"
			tmp$=tmp$,LTrim$(T8[8] Using "---------#.##"),fdel$
		  Else
			tmp$=tmp$,fdel$
		  Endif
		Else
			tmp$=tmp$,fdel$
		End If
		If PURGEFLAG = 3 let tmp$=tmp$,fdel$
		tmp$=tmp$,rdel$
		call addtostr(e$,rstr$,tmp$)
		goto STLDone ! that's all
	Endif
	Print #0;""
	Print #0; Tab 8;"**SLSM ";S8;" ";S1$[1,15];" TOTALS**";
	If Not(PRTCOST) Goto L_4530
	if custom_customer$<>"HTBERRY"
	If (PT8[5] + T8[5]) Print #0; Using "---#%"; Tab 44;FNW((PT8[5] + T8[5] - T6[0]) / (PT8[5] + T8[5]) * 100);
	else
	IF (PT8[7]+T8[10]) PRINT #0; USING "---#%"; TAB 44;int(((PT8[6]+T8[9])/(PT8[7]+T8[10]))*100);
	Endif
	Print #0; Using "-------#.##"; Tab 50;T6[0];
	Print #0; Using "-------#.##"; Tab 62;PT8[5] + T8[5] - T6[0];
	L_4530: If Not(ARCODE) Print #0; Using "-------#.##"; Tab 74;PT8[5];
	Print #0; Using "-------#.##"; Tab 86;T8[5];
	Print #0; Using "-------#.##"; Tab 98;T8[6];
	Print #0; Using "-------#.##"; Tab 110;T8[7];
	If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
	  if custom_customer$<>"HTBERRY"
		Print #0; Using "------#.##"; Tab 122;T8[8]
	  Else
	    REM ! berry - no print above
	  Endif
	End If
	STLDone: ! finish
	If Not(SUMM) Gosub INSERT_SUMTMP
	S8 = 0 \ T8[5] = 0 \ T8[6] = 0 \ T8[7] = 0 \ T8[8] = 0
	line_print_flag=0
	T6[0] = 0 \ PT8[5] = 0
	pt8[6]=0;t8[9]=0;pt8[7]=0;t8[10]=0  !berry vars
	If SUMM Let LN = LN + 1 \ Goto L_4590
	LN = 9999
L_4590: Return

L_4600: Rem CUSTOMER TOTAL
IF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA4600:
	If SUMM Goto L_4645
	Gosub L_5800
	If HEADING Gosub L_5300
	if screenprint ! xml
		if summ
			If Not(S8) tmp$=Str$(S1),fdel$,RTrim$(S1$),fdel$
			If S8 tmp$=Str$(S8),fdel$,RTrim$(S1$),fdel$
		Else
			If Not(S8) tmp$=Str$(S1),fdel$,RTrim$(S1$),fdel$
			If S8 tmp$=Str$(S8),fdel$,RTrim$(S1$),fdel$
			tmp$=tmp$,Str$(S10),fdel$,"TOTALS",fdel$ ! no cust/name
			tmp$=tmp$,fdel$,fdel$ ! no inv / date
		Endif ! rest is standard
		If PRTCOST
			x3=0
			if custom_customer$<>"HTBERRY"
			if (PT10[5] + T10[5]) let x3=FNW((PT10[5] + T10[5] - T7[0]) / (PT10[5] + T10[5]) * 100)
			Else
			IF (PT10[7]+T10[10]) let x3=int(((PT10[6]+T10[9])/(PT10[7]+T10[10]))*100)
			Endif
			tmp$=tmp$,LTrim$(X3 Using "-----#%"),fdel$
			tmp$=tmp$,LTrim$(T7[0] Using "---------#.##"),fdel$
			tmp$=tmp$,LTrim$(PT10[5] + T10[5] - T7[0] Using "---------#.##"),fdel$
		Endif
		if not(ARCODE)
			tmp$=tmp$,LTrim$(PT10[5] Using "---------#.##"),fdel$
		Endif
		tmp$=tmp$,LTrim$(T10[5] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T10[6] Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(T10[7] using "---------#.##"),fdel$
		If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
		  if custom_customer$<>"HTBERRY"
			tmp$=tmp$,LTrim$(T10[8] Using "---------#.##"),fdel$
		  Else
			tmp$=tmp$,fdel$
		  Endif
		Else
			tmp$=tmp$,fdel$
		End If
		If PURGEFLAG = 3 let tmp$=tmp$,fdel$
		tmp$=tmp$,rdel$
		call addtostr(e$,rstr$,tmp$)
		goto L_4645 ! that's all
	Endif
	Print #0;""
	Print #0; Using "######"; Tab 12;"** CUSTOMER ";S10;" TOTALS **";
	If Not(PRTCOST) Goto L_4627
	if custom_customer$<>"HTBERRY"
	If (PT10[5] + T10[5]) Print #0; Using "---#%"; Tab 44;FNW((PT10[5] + T10[5] - T7[0]) / (PT10[5] + T10[5]) * 100);
	Else
	IF (PT10[7]+T10[10]) PRINT #0; USING "---#%"; TAB 44;int(((PT10[6]+T10[9])/(PT10[7]+T10[10]))*100);
	Endif
	Print #0; Using "-------#.##"; Tab 50;T7[0];
	Print #0; Using "-------#.##"; Tab 62;PT10[5] + T10[5] - T7[0];
	L_4627: If Not(ARCODE) Print #0; Using "-------#.##"; Tab 74;PT10[5];
	Print #0; Using "-------#.##"; Tab 86;T10[5];
	Print #0; Using "-------#.##"; Tab 98;T10[6];
	Print #0; Using "-------#.##"; Tab 110;T10[7];
	If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
	  if custom_customer$<>"HTBERRY"
		Print #0; Using "------#.##"; Tab 122;T10[8];
	  Else
	    Rem - berry line is remmed
	  Endif
	End If
	Print #0;""
	Print #0;""
	LN = LN + 3
	L_4645: S10 = 0 \ T10[5] = 0 \ T10[6] = 0 \ T10[7] = 0 \ T10[8] = 0
	T7[0] = 0 \ PT10[5] = 0
	let pt10[6]=0;t10[9]=0;pt10[7]=0;t10[10]=0 ! berry vars
Return

L_4700: Rem Print the salesman total again
IF CUSTOM_CUSTOMER$="ETNA" RETURN
	LN = 999
	K98$ = " ",K98$
	SORT_LOOP: Search #ch_98,3,1;K98$,R98,E \ If E > 2 Gosub ERR_SEARCH
	If E Return
	Mat Read #ch_98,R98,0;SNAME$;
	Read #ch_98,R98,16;GP;
	Read #ch_98,R98,22;COST;
	Read #ch_98,R98,28;PROFIT;
	Read #ch_98,R98,34;PRIMTH;
	Read #ch_98,R98,40;CURMTH;
	Read #ch_98,R98,46;AMTPAID;
	Read #ch_98,R98,52;COMMAMT;
	Read #ch_98,R98,58;COMMDUE;
	if screenprint ! xml
		if summ
			tmp$=K98$[1,3],fdel$,SNAME$[1,15]," TOTALS",fdel$ !
		Else
			tmp$=K98$[1,3],fdel$,SNAME$[1,15]," TOTALS",fdel$
			tmp$=tmp$,fdel$,fdel$ ! no cust/name
			tmp$=tmp$,fdel$,fdel$ ! no inv / date
		Endif ! rest is standard
		If PRTCOST
			x3=GP
			tmp$=tmp$,LTrim$(X3 Using "-----#%"),fdel$
			tmp$=tmp$,LTrim$(COST Using "---------#.##"),fdel$
			tmp$=tmp$,LTrim$(PROFIT Using "---------#.##"),fdel$
		Endif
		if not(ARCODE)
			tmp$=tmp$,LTrim$(PRIMTH Using "---------#.##"),fdel$
		Endif
		tmp$=tmp$,LTrim$(CURMTH Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(AMTPAID Using "---------#.##"),fdel$
		tmp$=tmp$,LTrim$(COMMAMT using "---------#.##"),fdel$
		If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
		  If custom_Customer$<>"HTBERRY"
			tmp$=tmp$,LTrim$(COMMDUE Using "--------#.##"),fdel$
		  Else
			tmp$=tmp$,fdel$
		  Endif
		Else
			tmp$=tmp$,fdel$
		End If
		If PURGEFLAG = 3 let tmp$=tmp$,fdel$
		tmp$=tmp$,rdel$
		call addtostr(e$,rstr$,tmp$)
		goto Sort_LOOP ! that's all
	Endif
	Gosub L_5800
	Print #0;""
	Print #0; Tab 8;"**SLSM ";K98$[1,3];" ";SNAME$[1,15];" TOTALS**";
	If Not(PRTCOST) Goto L_4730
	Print #0; Using "---#%"; Tab 44;GP;
	Print #0; Using "-------#.##"; Tab 50;COST;
	Print #0; Using "-------#.##"; Tab 62;PROFIT;
	L_4730: If Not(ARCODE) Print #0; Using "-------#.##"; Tab 74;PRIMTH;
	Print #0; Using "-------#.##"; Tab 86;CURMTH;
	Print #0; Using "-------#.##"; Tab 98;AMTPAID;
	Print #0; Using "-------#.##"; Tab 110;COMMAMT;
	If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
	  If custom_customer$<>"HTBERRY"
		Print #0; Using "------#.##"; Tab 122;COMMDUE;
	  Else
	    Rem - berry rems line
	  Endif
	End If
	Print #0;""    !if custom_customer$<>"HTBERRY" Print #0;""
	LN = LN + 2
	Goto SORT_LOOP
Return

L_5000: Rem PRINT LINE
	IF CUSTOM_CUSTOMER$="ETNA" goto etna5000:
	If SUMM Goto L_5160
	If S10 <> S3[1] If Not(HEADING) Gosub L_5200
	if screenprint ! xml
		if summ
			If Not(S8) tmp$=Str$(S1),fdel$,RTrim$(S1$),fdel$
			If S8 tmp$=Str$(S8),fdel$,RTrim$(S1$),fdel$
		Else
			If Not(S8) tmp$=Str$(S1),fdel$,RTrim$(S1$),fdel$
			If S8 tmp$=Str$(S8),fdel$,RTrim$(S1$),fdel$
			tmp$=tmp$,Str$(S3[1]),fdel$,RTrim$(C1$),fdel$ ! cust/name
			x2=S1[3] \ GOSUB L_7700
			tmp$=tmp$,Str$(S7[1]),fdel$,X$,fdel$ ! inv / date
		Endif ! rest is standard
		If PRTCOST
			x3=0
			if custom_Customer$<>"HTBERRY"
			if S2 let x3=FNW((S2[0] - S6[0]) / S2[0] * 100)
			Else
			IF S2 let x3=int((adj_gp_dollars)/adj_dollars*100)
			Endif
			tmp$=tmp$,LTrim$(X3 Using "----#%"),fdel$
			tmp$=tmp$,LTrim$(S6[0] Using "--------#.##"),fdel$
			tmp$=tmp$,LTrim$(S2[0] - S6 Using "--------#.##"),fdel$
		Endif
		if not(ARCODE) ! col 74
			tmp1$="" ! for col 86
			tmp2$="" ! for col 74
			If ARMONTH <> S4[0] ! not right month
				tmp2$=LTrim$(S2[0] Using "--------#.##") ! ; Tab 74;S2[0];
			Else
				TEMP$ = S1[3] Using "&&&&&&"
				If ARDATE$[1,2] = TEMP$[1,2] ! is the year the same?
				tmp1$=LTrim$(S2[0] Using "--------#.##") ! ; Tab 86;S2[0];
				Else
				tmp2$=LTrim$(S2[0] Using "--------#.##") ! ; Tab 74;S2[0];
				End If
			End If
			tmp$=tmp$,tmp2$,fdel$
		Else ! is arcode
			tmp1$=LTrim$(S2[0] Using "--------#.##")
		Endif
		tmp$=tmp$,tmp1$,fdel$
		tmp$=tmp$,LTrim$(T9 Using "--------#.##"),fdel$
		tmp$=tmp$,LTrim$(S2[1] using "--------#.##"),fdel$
		if custom_customer$="HTBERRY"
			tmp$=tmp$,LTrim$(S1[2] USING "-------#.##%"),fdel$
		Else
		  If SUMM <> 0 Or PURGEFLAG <> 1 Or PRT_PAIDONLY = 0
			tmp1$=""
			If X5 >= 6 ! it's a credit
				If CF$ = "C"
				tmp1$=LTrim$(S2[1] Using "-------#.##")
				Else
				If Abs(T9) >= Abs(S2) Or ARPAID tmp1$=LTrim$(S2[1] Using "-------#.##")
				End If
			Else
				If Abs(T9) >= Abs(S2) Or ARPAID tmp1$=LTrim$(S2[1] Using "-------#.##")
			End If
			tmp$=tmp$,tmp1$,fdel$
		  Else
			If A2[1]
				X2 = A2[1] \ Gosub L_7700
				tmp$=tmp$,X$[1,8],fdel$
			Else
				tmp$=tmp$,fdel$
			End If
		  End If
		Endif
		If PURGEFLAG = 3
			if s4[1]
				let tmp$=tmp$,"*",fdel$
			Else
				let tmp$=tmp$,fdel$
			End if
		Endif
		tmp$=tmp$,rdel$
		call addtostr(e$,rstr$,tmp$)
		goto L_5160 ! that's all
	Endif
	Print #0; Using "########"; Tab 26;S7[1];
	X2 = S1[3] \ Gosub L_7700
	Print #0; Tab 35;X$[1,8];
	If Not(PRTCOST) Goto L_5121
	if custom_customer$<>"HTBERRY"
	If S2 Print #0; Using "---#%"; Tab 44;FNW((S2[0] - S6[0]) / S2[0] * 100);
	Else
	IF S2 PRINT #0; USING "---#%"; TAB 44;int((adj_gp_dollars)/adj_dollars*100);
	Endif
	Print #0; Using "-------#.##"; Tab 50;S6[0];
	Print #0; Using "-------#.##"; Tab 62;S2[0] - S6;
	L_5121: Rem what columns should print
	If ARCODE
		Print #0; Using "-------#.##"; Tab 86;S2[0];
	Else
		If ARMONTH <> S4[0] ! not right month
			Print #0; Using "-------#.##"; Tab 74;S2[0];
		Else
			TEMP$ = S1[3] Using "&&&&&&"
			If ARDATE$[1,2] = TEMP$[1,2] ! is the year the same?
				Print #0; Using "-------#.##"; Tab 86;S2[0];
			Else
				Print #0; Using "-------#.##"; Tab 74;S2[0];
			End If
		End If
	End If
	Print #0; Using "-------#.##"; Tab 98;T9;
	Print #0; Using "-------#.##"; Tab 110;S2[1];
	if custom_customer$="HTBERRY"
		PRINT #0; USING "----#.##%"; TAB 122;S1[2];
	Else ! below is remmed on berry
	If PURGEFLAG = 1 And SUMM = 0 And PRT_PAIDONLY = 1
		If A2[1]
			X2 = A2[1] \ Gosub L_7700
			Print #0; Tab 122;X$[1,8];
		End If
	Else
		If X5 >= 6 ! it's a credit
			If CF$ = "C"
				Print #0; Using "-----#.##"; Tab 122;S2[1];
			Else
				If Abs(T9) >= Abs(S2) Or ARPAID Print #0; Using "-----#.##"; Tab 122;S2[1];
			End If
		Else
			If Abs(T9) >= Abs(S2) Or ARPAID Print #0; Using "-----#.##"; Tab 122;S2[1];
		End If
	End If
	Endif ! end of custom
	If PURGEFLAG = 3 If S4[1] Print #0;"*";
	Print #0;""
	LN = LN + 1
	L_5160: S8 = S1 \ line_print_flag=1
	S10 = S3[1]
Return

PrintAuditTrans: ! print all audit transactions for a commission record
	if screenprint return ! no transactional detail for xml
	if summ return
	gotFirstAudit = 0
	k7$=" ",k7$
	k7$[1,3] = k1$[1,3]
	k7$[4,13] = k1$[10,19]
	pca_loop: !
		search #ch_commaudit,3,1;k7$,r7,e \ if e>2 gosub err_search:
		if e goto end_pca_loop:
		if k7$[1,3] <> k1$[1,3] OR k7$[4,13] <> k1$[10,19] goto end_pca_loop:
		if k7$[26,26] <> k1$[20,20] goto pca_loop: ! wrong type
		mat read #ch_commaudit,r7,0;as1;
		mat read #ch_commaudit,r7,16;as3;
		mat read #ch_commaudit,r7,128;as4;
		mat read #ch_commaudit,r7,62;cas$;
		if as1[1] = 6 or as1[1] = 7 or as1[1] = 9 ! it's a credit or negative adjustment
			for i = 0 to 5
				if i<2 as3[i] = 0 - as3[i]
				if i>1 as5[i] = 0 - as5[i]
			next i
		end if
		GOSUB L_5800:
		IF HEADING GOSUB L_5300: \ GOSUB L_5200: ! new page prt cust&slsm
		if not(gotFirstAudit)
			print #0;TAB 33;"* ORIG COMM.";
			print #0;TAB 49;"ORIGINAL COMMISSION AMOUNT";
			PRINT #0; USING "-------#.##"; TAB 110;ocs1[0] * multiplier
			ln = ln + 1
			GOSUB L_5800:
			IF HEADING GOSUB L_5300: \ GOSUB L_5200: ! new page prt cust&slsm
			gotFirstAudit = 1
		end if
		tmp$ = "* UNKNOWN ADJ"
		if as4[0] = 1 tmp$ = "* MANUAL ADJ"
		if as4[0] = 2 tmp$ = "* CHARGEBACK ADJ"
		if as4[0] = 3 tmp$ = "* TERMS DISC ADJ"
		if as4[0] = 4 tmp$ = "* CASH DISC " + str$(as4[1])
		if as4[0] = 5 tmp$ = "* CUST REBT ADJ"
		if as4[0] = 6 tmp$ = "* CPI CHARGE "
		if as4[0] = 7 tmp$ = "* HB ADJ "+rtrim$(cas$)
		if as4[0] = 8 tmp$ = "* CREDIT CARD ADJ"
		if as4[0] = 9 tmp$ = "* AMALG ADJ"
		print #0;tab 33;tmp$;
		print #0;tab 49;cas$;
		PRINT #0; USING "-------#.##"; TAB 110;(AS3[0] - AS3[1]) * -1;
		tmp$ = as3[4] using "&&&&&&"
		PRINT #0; TAB 123;tmp$[3,4]+"/"+tmp$[5,6]+"/"+tmp$[1,2]
		LN = LN + 1
		GOSUB L_5800:
		IF HEADING GOSUB L_5300: \ GOSUB L_5200: ! new page prt cust&slsm
		gotFirstAudit = 1
		goto pca_loop:
	end_pca_loop: !
	if gotFirstAudit
		print #0;""
		ln = ln + 1
		GOSUB L_5800:
		IF HEADING GOSUB L_5300: \ GOSUB L_5200: ! new page prt cust&slsm
		gotFirstAudit = 1
	end if
RETURN


L_5200: Rem PRINT CUSTOMER
IF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA5200:
If SUMM Return 
if screenprint return ! sent every line
Print #0; Using "######"; Tab 0;S3[1];
Print #0; Tab 7;C1$[1,18];
Return 
L_5300: Rem print salesman!
IF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA5300:
If SUMM Goto L_5335
if screenprint goto L_5335 ! sent every line
If Not(S8) Print #0; Using "###";"SALESMAN ";S1;" ";S1$
If S8 Print #0; Using "###";"SALESMAN ";S8;" ";S1$
Print #0;" "
LN = LN + 2
L_5335: SALESMAN = 1
Return 
L_5800: Rem HEADINGS ROUTINE
IF CUSTOM_CUSTOMER$="ETNA" GOTO ETNA5800:
if screenprint return ! has already!
HEADING = 0
If LN < MAXLINES Return 
!If J2 If SCREENPRINT Input @0,23;"PRESS <CR> TO CONTINUE "J$ \ Print 'CS';
If J2 If Not(SCREENPRINT) Print #0;"\14\";
J2 = J2 + 1 \ LN = 7
If Not(SCREENPRINT) Print #0;"\15\";
Print #0; Tab 10;J8$; Tab (64 - Len(COMP$) / 2);COMP$; Tab 120;"PAGE";J2
Print #0;" - 450 - ";Msc$(3);
If HIST
  Print #0; Tab 47;"S A L E S M A N   C O M M I S S I O N   H I S T O R Y"
Else 
  Print #0; Tab 47;"S A L E S M A N   C O M M I S S I O N"
End If 
If Not(PRT_PAIDONLY)
  If ARCODE Print #0; Tab 56;"FOR A/R MONTH CODE ";ARCODE \ Goto L_5852
  X2 = STARTDATE \ Gosub L_7700
  Print #0; Tab 46;"RUN FOR DATES ";X$;" THROUGH ";
  X2 = ENDDATE \ Gosub L_7700 \ Print #0;X$
Else 
  If ARCODE
    Print #0; Tab 20;"Transactions for A/R Month Code ";ARCODE;
  Else 
    X2 = STARTDATE \ Gosub L_7700
    Print #0; Tab 15;"Transactions as of ";X$;" Through ";
    X2 = ENDDATE \ Gosub L_7700 \ Print #0;X$;
  End If 
  X2 = SPAYDATE \ Gosub L_7700
  Print #0; Tab 65;"Paid as of ";X$;" Through ";
  X2 = EPAYDATE \ Gosub L_7700
  Print #0;X$
End If 
L_5852: If Not(HIST) If PURGEFLAG < 3 Print #0; Tab 52;"RUN FOR PURGE ";
If HIST Print #0; Tab 52;"RUN FOR HISTORY ";
If PURGEFLAG = 1 Print #0;"PAID ONLY"
If PURGEFLAG = 2 Print #0;"ALL IN RANGE"
If PURGEFLAG = 3 Print #0; Tab 55;"AUDIT VERSION ONLY"
Print #0;" "
If Not(ARCODE) Print #0; Tab 75;"-- N E T    S A L E --"
Print #0; Tab 0;"CUST #";
Print #0; Tab 8;"CUSTOMER NAME";
Print #0; Tab 28;"INV/CM";
Print #0; Tab 37;"DATE";
If Not(PRTCOST) Goto L_5877
Print #0; Tab 45;"GP %";
Print #0; Tab 55;"COST";
Print #0; Tab 65;"PROFIT";
L_5877: If Not(ARCODE)
  Print #0; Tab 75;"PRIOR MTH";
  Print #0; Tab 86;"CURRENT MTH";
Else 
  Print #0; Tab 86;"       SALE";
End If 
Print #0; Tab 99;"AMT PAID";
Print #0; Tab 111;"COMM AMT";
If SUMM = 0 And PURGEFLAG = 1 And PRT_PAIDONLY = 1
  Print #0; Tab 122;"PAID DATE";
Else 
  If custom_customer$<>"HTBERRY"
  Print #0; Tab 122;"COMM DUE";
  Else
  PRINT #0; TAB 122;"COMM %";
  Endif
End If 
Print #0;" "
Print #0;"\15\";
HEADING = 1
Return 

! START ETNA PRINTS

! START ETNA PRINTS
ETNA4000: ! TOTAL PRINT 
GOSUB ETNA5800:
PRINT #0;"** TOTALS**";
IF PRTCOST <>0 ! GOTO L_4055: ! "no cost/gp print
	IF ET9[1]<>0 PRINT #0; USING "---#%"; TAB 28;FNW((ET9[1]-ET9[0])/ET9[1]*100); ! SALE-COST/SALE ! GP
	PRINT #0; USING "-------#.##"; TAB 35;ET9[0]; ! COST
	PRINT #0; USING "-------#.##"; TAB 48;ET9[1]-ET9[0]; ! PROFIT ! SALES-COST
ENDIF
PRINT #0; USING "-------#.##"; TAB 61;ET9[1]; ! SALE
PRINT #0; USING "-------#.##"; TAB 74;ET9[2]; ! COMMISSION
PRINT #0; USING "-------#.##"; TAB 87;ET9[3]; ! PAYPREV
PRINT #0; USING "-------#.##"; TAB 100;ET9[4]; ! PAYCURR
PRINT #0; USING "-------#.##"; TAB 113;ET9[5]  ! COMMDUE
PRINT #0;""
!
RETURN 

ETNA4500: ! SALESMAN TOTAL
GOSUB ETNA4600:
GOSUB ETNA5800:
PRINT #0;""
PRINT #0; USING "###";"**SALESMAN ";S8;" TOTALS**";
!IF PRTCOST<>0 !  GOTO L_4530: ! "no cost/gp print
!	IF T8[5] PRINT #0; USING "---#%"; TAB 28;FNW((T8[5]-T6[0])/T8[5]*100);
!	PRINT #0; USING "-------#.##"; TAB 35;T6[0];
!	PRINT #0; USING "-------#.##"; TAB 48;T8[5]-T6[0];
!ENDIF
!PRINT #0; USING "-------#.##"; TAB 61;T8[5];
!PRINT #0; USING "-------#.##"; TAB 74;T8[6];
!PRINT #0; USING "-------#.##"; TAB 87;T8[7];
!PRINT #0; USING "-------#.##"; TAB 100;T8[3];
!PRINT #0; USING "-------#.##"; TAB 113;T8[8]
IF PRTCOST <>0 ! GOTO L_4530 ! "no cost/gp print
	IF ET8[1]<>0 PRINT #0; USING "---#%"; TAB 28;FNW((ET8[1]-ET8[0])/ET8[1]*100); ! SALE-COST/SALE ! GP
	PRINT #0; USING "-------#.##"; TAB 35;ET8[0]; ! COST
	PRINT #0; USING "-------#.##"; TAB 48;ET8[1]-ET8[0]; ! PROFIT ! SALES-COST
ENDIF
PRINT #0; USING "-------#.##"; TAB 61;ET8[1]; ! SALE
PRINT #0; USING "-------#.##"; TAB 74;ET8[2]; ! COMMISSION
PRINT #0; USING "-------#.##"; TAB 87;ET8[3]; ! PAYPREV
PRINT #0; USING "-------#.##"; TAB 100;ET8[4]; ! PAYCURR
PRINT #0; USING "-------#.##"; TAB 113;ET8[5]  ! COMMDUE
FOR CTR=0 TO 10\LET ET8[CTR]=0\NEXT CTR
LET S8=0 \ LET T8[5]=0 \ LET T8[6]=0 \ LET T8[7]=0 \ LET T8[8]=0 \ LET T8[3]=0
line_print_flag=0
LET T6[0]=0
IF SUMM<>0
	LET LN=LN+1 
	!\ GOTO L_4590: ! "only 2 lines print 
ELSE
	LET LN=9999
ENDIF
RETURN 





!!!!
ETNA4600: ! CUSTOMER TOTAL
IF SUMM=0 !  GOTO L_4645: ! "slsm totals only
	LET LN=LN+2
	GOSUB ETNA5800:
	IF HEADING GOSUB ETNA5300:
	PRINT #0;""
	PRINT #0; USING "######";"**CUSTOMER ";S10;" TOTALS**";
	!IF PRTCOST<>0 ! GOTO L_4627: ! "no cost/gp print
	!	IF T10[5] PRINT #0; USING "---#%"; TAB 28;FNW((T10[5]-T7[0])/T10[5]*100);
	!	PRINT #0; USING "-------#.##"; TAB 35;T7[0];
	!	PRINT #0; USING "-------#.##"; TAB 48;T10[5]-T7[0];
	!ENDIF
	!PRINT #0; USING "-------#.##"; TAB 61;T10[5];
	!PRINT #0; USING "-------#.##"; TAB 74;T10[6];
	!PRINT #0; USING "-------#.##"; TAB 87;T10[7];
	!PRINT #0; USING "-------#.##"; TAB 100;T10[3];
	!PRINT #0; USING "-------#.##"; TAB 113;T10[8]
	!PRINT #0;""
	IF PRTCOST <>0 ! GOTO L_4627! "no cost/gp print
	IF ET10[1]<>0 PRINT #0; USING "---#%"; TAB 28;FNW((ET10[1]-ET10[0])/ET10[1]*100); ! SALE-COST/SALE ! GP
	PRINT #0; USING "-------#.##"; TAB 35;ET10[0]; ! COST
	PRINT #0; USING "-------#.##"; TAB 48;ET10[1]-ET10[0]; ! PROFIT ! SALES-COST
ENDIF
PRINT #0; USING "-------#.##"; TAB 61;ET10[1]; ! SALE
PRINT #0; USING "-------#.##"; TAB 74;ET10[2]; ! COMMISSION
PRINT #0; USING "-------#.##"; TAB 87;ET10[3]; ! PAYPREV
PRINT #0; USING "-------#.##"; TAB 100;ET10[4]; ! PAYCURR
PRINT #0; USING "-------#.##"; TAB 113;ET10[5]  ! COMMDUE
print #0;""
FOR CTR=0 TO 10\LET ET10[CTR]=0\NEXT CTR
ENDIF
LET S10=0;T10[5]=0;T10[6]=0;T10[7]=0;T10[8]=0;T10[3]=0
LET T7[0]=0
RETURN 




ETNA5000: ! PRINT LINE 
IF not(SUMM) !  GOTO L_5160: ! "slsm totals only
	IF S10<>S3[1] IF NOT (HEADING) GOSUB ETNA5200:
	PRINT #0; USING "########"; TAB 8;S7[1];
	LET X2=S1[3] \ GOSUB L_7700:
	PRINT #0; TAB 18;X$[1,8];
	IF PRTCOST<>0 !  GOTO L_5125: ! "no cost/gp print
		IF S2 PRINT #0; USING "---#%"; TAB 28;FNW((S2[0]-S6[0])/S2[0]*100);
		PRINT #0; USING "-------#.##"; TAB 35;S6[0];
		PRINT #0; USING "-------#.##"; TAB 48;S2[0]-S6;
	ENDIF
	PRINT #0; USING "-------#.##"; TAB 61;S2[0];
	PRINT #0; USING "-------#.##"; TAB 74;PAYPREV;
	PRINT #0; USING "-------#.##"; TAB 87;S2[1];
	PRINT #0; USING "-------#.##"; TAB 100;PAYCURR;
	PRINT #0; USING "-------#.##"; TAB 113;COMMDUE;
	PRINT #0;""
ENDIF
LET S8=S1
LET S10=S3[1]
LN = LN + 1
RETURN 

etna5200: ! PRINT CUSTOMER
IF SUMM RETURN  ! "totals only
GOSUB ETNA5800:
PRINT #0; USING "######"; TAB 0;S3[1];
PRINT #0; TAB 7;C1$;
PRINT #0;""
LET S10=S3[1]
ln=ln+1
RETURN 

ETNA5300: ! print salesman!
IF SUMM=0 !  GOTO L_5335: ! "totals only
	IF NOT (S8) PRINT #0; USING "###";"SALESMAN ";S1;" ";S1$ ! 1st time
	IF S8 PRINT #0; USING "###";"SALESMAN ";S8;" ";S1$
	PRINT #0;" "
	LET ln=ln+2
endif
LET SALESMAN=1 !salesman name printed
S8=S1
RETURN 

ETNA5800: ! HEADINGS ROUTINE
LET HEADING=0 !flag to indicate heading have printed
IF LN<MAXLINES RETURN 
If J2 If Not(SCREENPRINT) Print #0;"\14\";
J2 = J2 + 1 \ LN = 7
If Not(SCREENPRINT) Print #0;"\15\";
Print #0; Tab 10;J8$; Tab (64 - Len(COMP$) / 2);COMP$; Tab 120;"PAGE";J2
Print #0;" - 450 - ";Msc$(3);
Print #0;" - 450 - ";Msc$(3);
PRINT #0; TAB 47;"S A L E S M A N   C O M M I S S I O N"
IF ARCODE <>0
	PRINT #0; TAB 46;"FOR ARMONTH CODE ";ARCODE 
ELSE
	LET X2=startdate \ GOSUB L_7700:
	PRINT #0; TAB 46;"RUN FOR DATES ";X$;" THROUGH ";
	LET X2=enddate \ GOSUB L_7700: \ PRINT #0;X$
	!LET X2=N1 \ GOSUB L_7700:
	!PRINT #0; TAB 46;"RUN FOR DATES ";X$;" THROUGH ";
	!LET X2=N2 \ GOSUB L_7700: \ PRINT #0;X$
ENDIF
PRINT #0;" "
PRINT #0; TAB 0;"CUST #";
PRINT #0; TAB 10;"CUSTOMER NAME"
PRINT #0; TAB 10;"INV/CM";
PRINT #0; TAB 18;"DATE";
IF PRTCOST <>0 ! GOTO L_5877: ! "no cost/gp print
	PRINT #0; TAB 29;"GP %";
	PRINT #0; TAB 42;"COST";
	PRINT #0; TAB 53;"PROFIT";
ENDIF
PRINT #0; TAB 64;"NET SALE";
PRINT #0; TAB 76;"PREV APLD";
PRINT #0; TAB 90;"COMM AMT";
PRINT #0; TAB 102;"CURR PAID";
PRINT #0; TAB 115;"COMM DUE";
PRINT #0;" "
PRINT #0;"\215\";
LET HEADING=1 !yes headings have printed
RETURN 



! --- END ETNA PRINTS






L7000: ! Call "Input",J1,J$,J0$,J1$,J4$,J5$
Return 
SORTCOMMFILE: Rem sort commission file
! Print @0,22;'CL';"Sorting...please wait";'CE'; \ Signal 3,0
COUNT = 0
K1$ = N3 Using "###"
L_7020: Search #2,3,1;K1$,R1,E
If E = 2 Goto L_7170
If E Gosub ERR_SEARCH
Mat Read #2,R1,0;S1;
Mat Read #2,R1,28;S3;
Mat Read #2,R1,36;S4;
Mat Read #2,R1,52;SMAT$;
MAT  READ #2,R1,54;S7;
COUNT = COUNT + 1
! If Fra(COUNT / 100) = 0 Print @30,22;COUNT Using "###,###";
Gosub L_3200
If ARCODE If S4[0] <> ARCODE Goto L_7020
If YEAR_ Or ARCODE ! year could be zero when entering month/year
  X$ = S1[3] Using "&&&&&&";TEMPYR = X$[1,2]
  TEMPMTH = X$[3,4]
  If S4[0] <> TEMPMTH ! invoice date not match ar period on record
    If S4[0] >= 11 And TEMPMTH <= 3 ! period at eoy, but invoice date in next
      TEMPYR = TEMPYR - 1
      If TEMPYR < 0 Let TEMPYR = 100 - TEMPYR
    End If 
    If S4[0] <= 2 And TEMPMTH >= 10 ! period at start of year ,  invoice
      TEMPYR = TEMPYR + 1
    End If 
  End If 
  If TEMPYR >= 100 Let TEMPYR = TEMPYR - 100
  If YEAR_ <> TEMPYR Goto L_7020
End If 
X2 = S1[3] \ Gosub L_7820 \ X2 = 0
JWDATE = X2
If Not(ARCODE) If JWDATE < JDATE[0] Goto L_7020
If Not(ARCODE) If JWDATE > JDATE[1] Goto L_7020
If S1[0] < N3 Goto L_7020
If S1[0] > N4 Goto L_7170
K9$ = " ",K9$
K9$[1,3] = K1$[1,3]
K9$[4,9] = S3[1] Using "######"
K9$[10] = K1$[4]
Search #9,4,1;K9$,R1,E
If E Gosub ERR_SEARCH
SORTKEY = SORTKEY + 1
IF CUSTOM_CUSTOMER$="ETNA"
	LET J4$=" ",J4$ \ LET J4$=S3[1] USING "######"
	!IF S7 LET J4$[7]=S7 USING "######" ELSE  LET J4$[7]=S1[1] USING "######" !  IN CASE S7[0] HASN'T BEEN WRITTEN OUT ( OLDER RECORD )
	!IF S7 LET J4$[7]=S7 USING "##########" ELSE  LET J4$[7]=S7[1] USING "##########"                                  
	!LET J4$[13]=K9$[16]
	LET j4$[7]=K1$[4] ! "ref #/type (10,19]=Inv/cm, [20,20]=type
	IF S7[0]<>0 LET J4$[7,16]=S7[0] USING "##########" 
	! LET J4$[17]=K1$[20];J4$[18]="" ! "type
	SEARCH #5,2,1;J4$,R5,E
	IF E GOTO L_7020: ! not found
	MAT  READ #5,R5,24;A3;
	Search #30,2,1;j4$,r[0],e
	if not(e) goto L_7020: ! with multiple salespeople may be duplicates
	LET E=2 \ SEARCH #30,1,0;J4$,R[30],E \ IF E GOSUB Err_Search:
	LET TOTPAID=A3[2]
	MAT  WRITE #30,R[30],0;TOTPAID;
	SEARCH #30,4,1;J4$,R[30],E \ IF E GOSUB Err_Search:
	GOTO L_7020:
ENDIF
Goto L_7020
L_7170: Return 

! FOR ETNA
L_8100: ! run through cash receipts
LET CASHKEY$=" ",CASHKEY$;DISCAMT=0
L_8110: SEARCH #60,3,1;CASHKEY$,R[6],E \ IF E=2 GOTO L_8295:
IF E GOSUB Err_Search:
! IF CASHKEY$[1,7]=" 1  191" STOP 
L_8120: MAT  READ #60,R[6],44;CR3;
LET X=CASHKEY$[8,10]
IF X=1
	IF NOT (CR3[1]) GOTO L_8300:
ENDIF 
IF NOT (CR3[4]) GOTO L_8110:
L_8130: ! 1st add up all deductions
LET DISCAMT=0;CASHKEY1$=" ",CASHKEY1$;CASHKEY1$[1,7]=CASHKEY$[1,7]
L_8140: SEARCH #60,3,1;CASHKEY1$,R[6],E \ IF E GOTO L_8165:
IF E GOSUB Err_Search:
IF CASHKEY1$[1,7]<>CASHKEY$[1,7] GOTO L_8165:
MAT  READ #60,R[6],44;CR3; \ LET DISCAMT=DISCAMT+CR3[4]
GOTO L_8140:

L_8165: ! look for invoices to apply discounts
LET CASHKEY1$=" ",CASHKEY1$;CASHKEY1$[1,7]=CASHKEY$[1,7]
L_8175: SEARCH #60,3,1;CASHKEY1$,R[6],E \ IF E=2 GOTO L_8290:
IF E GOSUB Err_Search:
IF CASHKEY1$[1,7]<>CASHKEY$[1,7] GOTO L_8290:
MAT  READ #60,R[6],44;CR3; \ IF NOT (CR3[3]) GOTO L_8175:
MAT  READ #60,R[6],0;CR1; \ IF CR1[2]<>1 GOTO L_8175:
MAT  READ #60,R[6],6;CR2;
LET J4$=" ",J4$;J4$[1,6]=CR2[0] USING "######"
LET J4$[7,16]=CR3[0] USING "##########";J4$[17]=CR1[2] USING "#"
SEARCH #30,2,1;J4$,R[30],E \ IF E=1 GOTO L_8175:
IF E GOSUB Err_Search:
MAT  READ #30,R[30],0;TOTPAID;
IF DISCAMT>TOTPAID
	LET DISCAMT=DISCAMT-TOTPAID;TOTPAID=0
ELSE 
	LET TOTPAID=TOTPAID-DISCAMT;DISCAMT=0
ENDIF 
MAT  WRITE #30,R[30],0;TOTPAID;
IF DISCAMT GOTO L_8175:
GOTO L_8290:

L_8290: LET CASHKEY$[8,10]="999" \ GOTO L_8110:

L_8295: RETURN 

L_8300: ! bank amount is 0check for unapplied payments
LET CASHKEY1$=CASHKEY$ \ LET APPAMT=0
GOTO L_8325:

L_8310: SEARCH #60,3,1;CASHKEY$,R[6],E \ IF E=2 GOTO L_8350:
IF E GOSUB Err_Search:
IF CASHKEY$[1,7]<>CASHKEY1$[1,7] GOTO L_8350:
L_8325: MAT  READ #60,R[6],44;CR3; \ IF NOT (CR3[2]) GOTO L_8310: ! no debit a/r amt
MAT  READ #60,R[6],0;CR1; \ IF CR1[2]<>9 GOTO L_8310: ! not payment type
LET APPAMT=APPAMT+CR3[2]
GOTO L_8310:

L_8350: LET CASHKEY$="" \ LET CASHKEY$[1,7]=CASHKEY1$[1,7]
IF APPAMT GOTO L_8130: ! treat as if bank amt was entered
GOTO L_8400: ! no payment found

L_8400: SEARCH #60,3,1;CASHKEY$,R[6],E \ IF E=2 GOTO L_8110:
IF E GOSUB Err_Search:
IF CASHKEY$[1,7]<>CASHKEY1$[1,7] GOTO L_8120:
MAT  READ #60,R[6],44;CR3;
IF NOT(CR3[2]+CR3[3]) GOTO L_8400:
MAT  READ #60,R[6],0;CR1;
MAT  READ #60,R[6],6;CR2;
LET J4$=" ",J4$;J4$[1,6]=CR2[0] USING "######"
LET J4$[7,16]=CR3[0] USING "##########";J4$[17]=CR1[2] USING "#"
SEARCH #30,2,1;J4$,R[30],E \ IF E=1 GOTO L_8400:
IF E GOSUB Err_Search:
MAT  READ #30,R[30],0;TOTPAID
LET TOTPAID=TOTPAID-(ABS(CR3[2]-CR3[3]))
IF TOTPAID<0 LET TOTPAID=0
MAT  WRITE #30,R[30],0;TOTPAID;
GOTO L_8400:


CLEAR_SORT: Rem ==========================clear the sort file
ch_98 = findchannel()
gosub open_sort:
! CHNL = 98 \ Gosub CHNLFREE
! If CHNLFREE
!   Gosub OPEN_SORT
! Else 
!   K98$ = " ",K98$
! CLEARSORT_LOOP: Rem
!   Search #ch_98,3,1;K98$,V1,E \ If E > 2 Gosub ERR_SEARCH
!   If Not(E)
!     Search #ch_98,5,1;K98$,V1,E
!     Goto CLEARSORT_LOOP
!   End If 
! End If 
Return 
OPEN_SORT: Rem
SCRATCH$ = "[1:256] 6/SUMTMP" + Str$(Spc(6)) + "!"
Build #ch_98,SCRATCH$
R98 = 25 \ Search #ch_98,0,1;SCRATCH$,R98,E \ If E Gosub ERR_SEARCH
R98 = 1000 \ Search #ch_98,0,0;SCRATCH$,R98,E \ If E Gosub ERR_SEARCH
R98 = 0 \ Search #ch_98,1,0;SCRATCH$,R98,E \ If E Gosub ERR_SEARCH
Return 
INSERT_SUMTMP: Rem====== insert summary tmp file
K98$ = " ",K98$
K98$[1,3] = S8 Using "###"
Search #ch_98,2,1;K98$,R98,E \ If E > 2 Gosub ERR_SEARCH
If E = 1 ! "insert record
  K98$[1,3] = S8 Using "###"
  E = 2
  Search #ch_98,1,0;K98$,R98,E
  If E Gosub ERR_SEARCH
  Search #ch_98,4,1;K98$,R98,E
  If E Gosub ERR_SEARCH
  SNAME$[1,15] = S1$[1,15]
  if custom_customer$<>"HTBERRY"
	  If (PT8[5] + T8[5])
		GP = FNW((PT8[5] + T8[5] - T6[0]) / (PT8[5] + T8[5]) * 100)
	  Else 
		GP = 0
	  End If 
  Else
	  IF (PT8[6]+T8[9])
		 let gp=0
		 if (pt8[7]+t8[10]) LET GP=int(((PT8[6]+T8[9])/(PT8[7]+T8[10]))*100)
	  ELSE
		 LET GP=0
	  ENDIF
  Endif
  COST = T6[0]
  PROFIT = PT8[5] + T8[5] - T6[0]
  PRIMTH = PT8[5]
  CURMTH = T8[5]
  AMTPAID = T8[6]
  COMMAMT = T8[7]
  COMMDUE = T8[8]
  Mat Write #ch_98,R98;SNAME$;
  Write #ch_98,R98,16;GP;
  Write #ch_98,R98,22;COST;
  Write #ch_98,R98,28;PROFIT;
  Write #ch_98,R98,34;PRIMTH;
  Write #ch_98,R98,40;CURMTH;
  Write #ch_98,R98,46;AMTPAID;
  Write #ch_98,R98,52;COMMAMT;
  Write #ch_98,R98,58;COMMDUE;
  SUM_COUNT = SUM_COUNT + 1
End If 
Return 
GETCHAN: Rem search for open channel (counts down from supplied chnl #)
For SCR = CHNL To 1 Step -1
  CHNL = SCR
  Gosub CHNLFREE
  If CHNLFREE
    SCR = 1
  Else 
    CHNL = 0
  End If 
Next SCR
Return 
CHNLFREE: Rem check to see if a channel is being used
If Err 0 Let CHNLFREE = Spc(8)
CHNLFREE = 0
E = Chf(CHNL)
If Err 0 Gosub ERR_TRAP
If CHNLFREE And CHNLFREE <> 49 Gosub ERR_TRAP
END_CHNLFREE: Rem
Return 
HIST_FIND: Rem--------------------------------------------------
SCRATCH$ = "4/SSLSMCOMMH" + Str$(IntCo) ! Str$(Int((Spc(5) - Int(Spc(5) / 16384) * 16384) / 64))
Call FindF(SCRATCH$,SCR)
If Not(SCR)
  HAVEHIST = 0
Else 
  HAVEHIST = 1
End If 
Return 

L_7700: Rem  *UNPACK DATE  X2 TO X$      V1.0  4/04/84  G.DOSCHER
X$ = " ",X$ \ X$[10] = ""
X$[1,3] = Int(X2 / 10 ^ 2 - Int(X2 / 10 ^ 4) * 10 ^ 2) + 10 ^ 2 Using "###"
X$[4,6] = Fra(X2 / 10 ^ 2) * 10 ^ 2 + 10 ^ 2 Using "###"
X$[7,9] = Int(X2 / 10 ^ 4) + 10 ^ 2 Using "###"
X$[4,4] = "/" \ X$[7,7] = "/" \ X$ = X$[2]
Return 
DT3[0] = X2;FLAG = 1;X$ = " "
Call "JULIANUTIL",DT3[],X$,FLAG
Return 
L_7800: Rem DATE X$ TO X2
Call VerifyDate(X$,X$,E) \ If E Let X$ = "    "
X2 = X$[1,6] \ Return 
L_7820: Rem  CONVERT YYMMDD TO JULIAN (RETURN=NOGOOD, +1=OKAY)
if x2<=0 return
X$ = X2 Using "&&&&&&"
Call DateToJulian(1,X$,X$,E) \ If E Return 
X2 = X$[1,5] \ Return 1
DT3[0] = X2;DT3[1] = X2;FLAG = 0
Call "JULIANUTIL",DT3[],X$,FLAG
Return 
X$ = X2 Using "&&&&"
DT3[0] = X$[1,2];DT3[1] = X$[3,4]
If DT3[0] > 67 Let DT3[0] = 1900 + DT3[0]
If DT3[0] < 68 Let DT3[0] = 2000 + DT3[0]
X$[1,4] = DT3[0] Using "&&&&";X$[5,6] = DT3[1] Using "&&"
X2 = X$[1,6] \ Return 
K9$ = " ",K9$

L_9100: Rem END OF THIS RANGE
If Not(SORTKEY) ! no salesman commission found cct123526
  !Print @0,2;"NO COMMISSION FOR SALESMAN ";N3;
  !If N3 <> N4 Print @32,2;" - ";N4
  Goto L_4270
End If 
if line_print_flag  ! some detail line got printed 
	Gosub L_4500 ! slsm total
endif
Gosub L_4000 ! report totals
If custom_customer$<>"ACME" ! acme custom - this is remmed out?
	If Not(SUMM)
	  Gosub L_4700 ! slsm total recap
	  if not(screenprint)
		  if custom_customer$<>"HTBERRY" Print #0;""
		  LN = LN + 1
	  Endif
	  Gosub L_4000 ! report ttls
	End If 
Endif
L_4270: ! If SCREENPRINT Print @0,23;"PRESS <CR> TO CONTINUE ";'CL'; \ Input ""J$
Goto OUTEND
OUTEND: Rem EXIT PROGRAM
!Print 'CS'
!Chain "MX000C"
If screenprint ! dx xml
  Call addtostr(e$,rstr$,esdel$) !end section
  Call setoutput(e$,rstr$,1) !1 flag puts 0 status seciton in, puts </page> in
Endif
End
ERR_SEARCH: Rem                                            
ENUM = E;ELINE = Spc(16);CTERR = 0                         
If E = 5 Let CTERR = Err(8)                                
e$ = "RETURN STATUS",(E + (CTERR * .001))                  
e$ = e$,"/ STATEMENT",ELINE," IN PROGRAM " + Msc$(4)       
Call programdump("tmp/450se!","")                        
Goto ERR_MSG ! Error 10000                                 
Return ! End

ERR_MSG: ! send message                                    
ReturnStatus = 0 ! 0 ! no good (ONLY DISPLAYS IF =1 ??)    
Message$ = e$                                              
Call CreateNetStatus(e$,ReturnStatus,Message$,WebStr$)     
Call AddToStr(e$,rstr$,WebStr$)                            
Call SetOutPut(e$,rstr$)                                   
End                             

Rem {begin rtn.error.s}
ERR_TRAP: Rem *Error routine (escape trap)   V3.1 8/94 G.DOSCHER/REK
!
include "src/callmainerrnet.inc"
End
