! libfilewhinfo.lib
! loadsave -w -n 100,10 -o prog/dxport/libfilewhinfoz.lib src/libfilewhinfoz.src
!! need change for dropdown list to start at record #0 for wh#
!
! supporting library of file maintenance routines for browser
!
! 1.0 generated by dfcreatestruct on 10/24/14 Upgrade
!
include "src/copyright.inc"
!
! file maintenance sub routines for whinfo File
!
!  function  filedroplistwhinfoz
!
Declare Intrinsic Sub Env,GetGlobals
Declare Intrinsic Function crc32,callstat$,trim$,findchannel
External Lib "dfgeneral.lib"
Declare External Function dfDTConvert$
External Lib "ubsfunc.dl4"
Declare External Function Openfile
!
include "src/inc/filewhinfoz.inc"
!
! ----------------------------------------
external sub filedroplistwhinfoz(e$,list$[],maxcnt,Chan,...)
  !
  ! creates a drop list
  !
  ! e$          : to return error msg if any
  ! List$[]     : the record created from the field array
  ! maxcnt      : maxmium # of lines for list array
  ! Chan        : the channel # of the file
  !
  ! Optional parameters
  ! Section$    : .net, the section to be created and sent to web
  ! Field$[]    : the fields being created in the drop down list
  !               in the order of being displayed
  ! Others$     : list of flags to display other drop list options 0=None,A=All
  !
  Try
    !
    Try enter iSection$,... else dim iSection$[1]
    Try enter iField$[],... else dim iField$[1,30]
    Try enter Others$ else dim Others$[1]
    !
    option string redim is legal
    !
    dim tmp$[50],tmpfield$[50],tmpline$[500],calling$[14],errtype$[1],Section$[30],Field$[ 1 ,30]
    dim bsdel$[20],esdel$[20],rdel$[20],fdel$[20]
    dim 2%,row
    dim 2%,tmpcnt,3%
    !
    dim whinfo. as whinfo
    Section$ = iSection$
    for i=0 to ubound(iField$[],1)
     Field$[i]=iField$[i]
    next i
    calling$=callstat$(1,errtype$)
    if calling$="libfilehandler" let blockformat=1 !dxblock <data> format
    !
    call env(1,"BSDEL",bsdel$)
    call env(1,"ESDEL",esdel$)
    call env(1,"RDEL",rdel$)
    call env(1,"FDEL",fdel$)
    !
    if Section$="" let Section$="droplistwhinfo"
    tmpcnt=ubound(list$[],1)
    row=0
    !
    ! beginning section
    Clear list$[]
    List$[0]=bsdel$,Section$,fdel$ ! beginning section
    !
    ! heading section for .net
    cnt=0
    if field$=""
      tmpline$="ID",fdel$,"WhName",fdel$
      !
      Field$[0]="WhName$"
    else
      tmpline$="ID",fdel$
      while Field$[cnt]
        tmpline$=tmpline$,trim$(Field$[cnt]),fdel$ ! field name
        cnt=cnt+1
      wend
    endif
    if blockformat=0
     List$[1]=tmpline$
    row=2
    end if
    !
 !any other optional elements to include in drop list (defined in page block userdef2
       sub tmpline(tmp$) !needed to put right # of fields in others
        tmpline$=""
        for fcnt=0 to ubound(Field$[],1)
          if Field$[fcnt] = "" exit for
          tmpfield$=" "
          if fcnt=0 let tmpfield$=tmp$
          if blockformat
           let tmpline$=tmpline$,rtrim$(tmpfield$)," "
          else
           let tmpline$=tmpline$,rtrim$(tmpfield$),fdel$
          end if
        next fcnt
       end sub
 xpos=pos(ucase$(others$),="A")
 if xpos
          call tmpline("All")
          if blockformat=0 List$[row]="A",fdel$,tmpline$
          if blockformat let list$[row]=tmpline$,fdel$,"A",fdel$,fdel$
          row=row+1
 end if
 xpos=pos(ucase$(others$),="0")
 if xpos
          call tmpline("None")
          if blockformat=0 List$[row]="0",fdel$,tmpline$
          if blockformat let list$[row]=tmpline$,fdel$,"0",fdel$,fdel$
          row=row+1
 end if
 xpos=pos(ucase$(others$),="B") !blank
 if xpos
          call tmpline("")
          if blockformat=0 List$[row]="",fdel$,tmpline$
          if blockformat let list$[row]=tmpline$,fdel$,"",fdel$,fdel$
          row=row+1
 end if
 xpos=pos(ucase$(others$),="C")
 if xpos
          call tmpline("Total of Selected")
          if blockformat=0 List$[row]="C",fdel$,tmpline$
          if blockformat let list$[row]=tmpline$,fdel$,"C",fdel$,fdel$
          row=row+1
 end if
    ! create data section
    !  for cnt=0 to chf(chan)-1 ! original
	! Code change below
	maxrec=chf(chan)-1
	if maxrec>98 let maxrec=98 ! rec's are 0 to 98 for whs 1 to 99
    ! create data section
      for cnt=0 to maxrec !!!!!!!!!!!!!!!!!!!!!starts at 0
        read record #chan,cnt;whinfo.;
        if row>tmpcnt let tmpcnt=expandarray(E$,List$[])
        !
        tmpline$=""
        if rtrim$(whinfo.WhName$)<>"" !indicates active record in non-indexed file
          for fcnt=0 to ubound(Field$[],1)
           if Field$[fcnt] = "" exit for ! exit??
           tmpfield$=""
            if Field$[fcnt]="WhName$" let tmpfield$=whinfo.WhName$," "
           !
		   if tmpfield$<>"" let tmpfield$=RTrim$(tmpfield$) \ if tmpfield$="" let tmpfield$=" " !even if field all spaces, include it
          if tmpfield$
           if blockformat
            let tmpline$=tmpline$,rtrim$(tmpfield$)," "
           else
            let tmpline$=tmpline$,rtrim$(tmpfield$),fdel$
           end if
          end if
          next fcnt
        !
        if tmpline$
          if blockformat=0 List$[row]=Str$(cnt+1),fdel$,tmpline$
          if blockformat let list$[row]=tmpline$,fdel$,str$(cnt+1),fdel$,fdel$
          row=row+1
        endif
       end if !requiredfieldname <>""
        !
      next cnt
    !
    if row>tmpcnt let tmpcnt=expandarray(e$,List$[])
    if blockformat=0 let List$[row]=esdel$ ! end of section delimiter
    !
else
  dim msc4$[100] \ msc4$=msc$(4)
  if Pos(msc4$, = "/",-1) let msc4$=msc4$[pos(msc4$,="/",-1)+1]
  select case spc(8)
    case 10000
      ! this is default "message" error
      ! e$ should be set with message to display
    case 11000
      ! search error
      call env(2,"PROGNAME",msc4$)
      call programdump()
      call searcherr(e$, e, Spc(10),e$)
    case else
      e$="error in filedroplist whinfo"
      if spc(8) = 123 let e$=" record locked"
      if spc(8)<10000 if spc(8)<>123
        call env(2,"PROGNAME",msc4$)
        call programdump()
        call suberr(e$,Spc(8),Spc(10),Msc$(2))
      end if
  end select
  error 10000
end try
end sub ! filedroplistwhinfo
!
! ----------------------------------------
